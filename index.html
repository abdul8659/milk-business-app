<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دودھ کا کاروبار - Fixed Version</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans Arabic', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            overflow-x: auto;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            overflow-x: auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .backup-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .backup-status.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .backup-status.syncing {
            background: rgba(255, 152, 0, 0.9);
        }

        .main-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            overflow-x: auto;
            min-width: 800px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-btn.active {
            background: rgba(255,255,255,0.9);
            border-color: white;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        .content-area {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            min-height: 500px;
            overflow-x: auto;
        }

        .customers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .customer-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            transition: transform 0.3s ease;
            position: relative;
        }

        .customer-card:hover {
            transform: translateY(-5px);
        }

        .add-customer-card {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: white;
            text-align: center;
            cursor: pointer;
        }

        .controls-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn.success { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
        .btn.warning { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); }
        .btn.info { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); }
        .btn.danger { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .section-title {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .hidden {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-btn {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .ledger-entries {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .entry-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-right: 4px solid #667eea;
            position: relative;
        }

        .entry-item.delivery {
            border-right-color: #4CAF50;
            background: #f1f8e9;
        }

        .entry-item.payment {
            border-right-color: #2196F3;
            background: #e3f2fd;
        }

        .entry-item.day-off {
            border-right-color: #ff416c;
            background: #fff5f5;
        }

        .entry-actions {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
        }

        .entry-action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
            color: white;
            font-weight: bold;
        }

        .edit-btn {
            background: #2196F3;
        }

        .edit-btn:hover {
            background: #1976D2;
            transform: scale(1.1);
        }

        .delete-btn {
            background: #f44336;
        }

        .delete-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .entry-content {
            margin-left: 90px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-right: 4px solid;
        }

        .alert-info {
            background: #e3f2fd;
            border-color: #2196F3;
            color: #1976D2;
        }

        .alert-success {
            background: #e8f5e8;
            border-color: #4CAF50;
            color: #2e7d32;
        }

        .github-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .github-form {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }

        .github-input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        .github-btn {
            background: linear-gradient(135deg, #24292e 0%, #586069 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .github-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Legal Size Print Styles - 8.5" x 14" (215.9mm x 355.6mm) */
        @media print {
            @page {
                size: legal;
                margin: 0.5in;
            }
            
            body {
                background: white !important;
                color: black !important;
                font-size: 11px;
                line-height: 1.3;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-header {
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 15px;
                text-align: center;
            }
            
            .print-header h1 {
                font-size: 18px;
                margin-bottom: 5px;
            }
            
            .print-header h2 {
                font-size: 14px;
                margin-bottom: 5px;
            }
            
            .print-customer-info {
                background: #f5f5f5;
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 15px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .print-summary {
                background: #e8f4f8;
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 15px;
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                text-align: center;
            }
            
            .print-entries-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 10px;
            }
            
            .print-entries-table th,
            .print-entries-table td {
                border: 1px solid #ccc;
                padding: 5px;
                text-align: right;
            }
            
            .print-entries-table th {
                background: #f0f0f0;
                font-weight: bold;
            }
            
            .print-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 30px;
                background: #f0f0f0;
                border-top: 1px solid #ccc;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .customers-grid {
                grid-template-columns: 1fr;
            }
            
            .main-nav {
                gap: 5px;
                min-width: 100%;
                overflow-x: auto;
            }
            
            .nav-btn {
                min-width: 100px;
                padding: 10px 15px;
                font-size: 12px;
            }

            .entry-content {
                margin-left: 70px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="backup-status" id="backup-status">
        ✅ سسٹم تیار
    </div>

    <div class="container">
        <div class="header">
            <h1>🥛 دودھ کا کاروبار</h1>
            <p>Fixed Version - Entry ID & GitHub Auto-storage</p>
        </div>

        <nav class="main-nav">
            <button class="nav-btn active" onclick="showDashboard()">
                📈 ڈیش بورڈ
            </button>
            <button class="nav-btn" onclick="showCustomers()">
                👥 گاہک
            </button>
            <button class="nav-btn" onclick="showLedger()">
                📝 کھاتہ
            </button>
            <button class="nav-btn" onclick="showReports()">
                🖨️ پرنٹ رپورٹس
            </button>
            <button class="nav-btn" onclick="showBackup()">
                ☁️ بیک اپ
            </button>
        </nav>

        <div class="content-area">
            <!-- Dashboard Section -->
            <div id="dashboard-section">
                <h2 class="section-title">📈 کاروباری ڈیش بورڈ</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="total-customers-stat">0</h3>
                        <p>کل گاہک</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="total-revenue-stat">0</h3>
                        <p>کل آمدنی (روپے)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="total-payments-stat">0</h3>
                        <p>وصول شدہ (روپے)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="pending-amount-stat">0</h3>
                        <p>باقی رقم (روپے)</p>
                    </div>
                </div>

                <div class="alert alert-success">
                    <h3>🔧 Fixed Issues in this Version:</h3>
                    <ul style="margin: 10px 0; padding-right: 20px;">
                        <li><strong>✅ Entry ID Fix:</strong> Smart entry detection works with all versions</li>
                        <li><strong>✅ Month Filtering:</strong> Improved date analysis and filtering</li>
                        <li><strong>✅ Auto GitHub Storage:</strong> HTML reports automatically saved to GitHub</li>
                        <li><strong>✅ Data Migration:</strong> Previous entries automatically updated</li>
                        <li><strong>✅ Beautiful WhatsApp:</strong> Enhanced Urdu formatting for ledgers</li>
                        <li><strong>✅ Network Error Handling:</strong> Better GitHub connectivity</li>
                    </ul>
                    <div style="margin-top: 15px;">
                        <button class="btn success" onclick="fixExistingEntries()" title="Manually fix any entry issues">🔧 Fix Previous Entries</button>
                        <button class="btn warning" onclick="addSampleData()">📝 Sample Data شامل کریں</button>
                        <button class="btn info" onclick="generateLegalSizeLedger()">🖨️ Legal Size Test</button>
                    </div>
                </div>

                <div class="alert alert-info">
                    <h3>🩺 Troubleshooting Guide:</h3>
                    <details style="margin: 10px 0;">
                        <summary style="cursor: pointer; font-weight: bold;">❓ Previous entries not showing?</summary>
                        <ul style="margin: 10px 0; padding-right: 20px;">
                            <li>Click "🔧 Fix Previous Entries" button above</li>
                            <li>Check browser console (F12) for detailed logs</li>
                            <li>Try refreshing the page</li>
                            <li>Use "🔍 Debug Data" button to inspect data</li>
                        </ul>
                    </details>
                    <details style="margin: 10px 0;">
                        <summary style="cursor: pointer; font-weight: bold;">🌐 GitHub connection issues?</summary>
                        <ul style="margin: 10px 0; padding-right: 20px;">
                            <li>Check your internet connection</li>
                            <li>Try "🔗 کنکشن ٹیسٹ" in Backup section</li>
                            <li>Reports still save locally even if GitHub fails</li>
                            <li>CORS errors are normal - reports still download</li>
                        </ul>
                    </details>
                    <details style="margin: 10px 0;">
                        <summary style="cursor: pointer; font-weight: bold;">📱 WhatsApp formatting issues?</summary>
                        <ul style="margin: 10px 0; padding-right: 20px;">
                            <li>WhatsApp should show beautiful Urdu formatting</li>
                            <li>Numbers are formatted in Urdu locale</li>
                            <li>Emojis and symbols make it more readable</li>
                            <li>Try sending to yourself first to test</li>
                        </ul>
                    </details>
                </div>
            </div>

            <!-- Customers Section -->
            <div id="customers-section" class="hidden">
                <div class="controls-section">
                    <input type="text" class="search-box" id="customer-search" placeholder="گاہک تلاش کریں..." onkeyup="searchCustomers()">
                    <button class="btn success" onclick="showAddCustomerModal()">➕ نیا گاہک شامل کریں</button>
                    <button class="btn info" onclick="generateAllCustomersLegalSize()">🖨️ تمام گاہکوں کی پرنٹ فائل</button>
                </div>
                <div class="customers-grid" id="customers-grid">
                    <!-- Customers will be loaded here -->
                </div>
            </div>

            <!-- Ledger Section -->
            <div id="ledger-section" class="hidden">
                <div class="controls-section">
                    <h2 id="ledger-title">گاہک کا کھاتہ</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn success" onclick="showAddDeliveryModal()">🥛 دودھ شامل کریں</button>
                        <button class="btn info" onclick="showAddPaymentModal()">💰 ادائیگی شامل کریں</button>
                        <button class="btn warning" onclick="showAddDayOffModal()">🚫 چھٹی شامل کریں</button>
                        <button class="btn" onclick="generateCurrentCustomerLegalSize()" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">🖨️ Legal Size Print</button>
                        <button class="btn" onclick="sendCurrentCustomerWhatsApp()" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);">📱 WhatsApp بھیجیں</button>
                        <button class="btn" onclick="showCustomers()">⬅️ واپس</button>
                    </div>
                </div>

                <!-- Month Selection -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">📅 مہینہ منتخب کریں</h3>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <select id="month-filter" onchange="filterByMonth()" style="padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px; min-width: 200px;">
                            <option value="all">تمام انٹریز</option>
                            <option value="2024-01">جنوری 2024</option>
                            <option value="2024-02">فروری 2024</option>
                            <option value="2024-03">مارچ 2024</option>
                            <option value="2024-04">اپریل 2024</option>
                            <option value="2024-05">مئی 2024</option>
                            <option value="2024-06">جون 2024</option>
                            <option value="2024-07">جولائی 2024</option>
                            <option value="2024-08">اگست 2024</option>
                            <option value="2024-09">ستمبر 2024</option>
                            <option value="2024-10">اکتوبر 2024</option>
                            <option value="2024-11">نومبر 2024</option>
                            <option value="2024-12">دسمبر 2024</option>
                            <option value="2025-01">جنوری 2025</option>
                            <option value="2025-02">فروری 2025</option>
                            <option value="2025-03">مارچ 2025</option>
                            <option value="2025-04">اپریل 2025</option>
                            <option value="2025-05">مئی 2025</option>
                            <option value="2025-06">جون 2025</option>
                            <option value="2025-07">جولائی 2025</option>
                            <option value="2025-08">اگست 2025</option>
                            <option value="2025-09">ستمبر 2025</option>
                            <option value="2025-10">اکتوبر 2025</option>
                            <option value="2025-11">نومبر 2025</option>
                            <option value="2025-12">دسمبر 2025</option>
                        </select>
                        <button class="btn info" onclick="setCurrentMonth()" style="padding: 10px 15px;">📅 موجودہ مہینہ</button>
                        <button class="btn" onclick="setPreviousMonth()" style="padding: 10px 15px;">⬅️ پچھلا مہینہ</button>
                    </div>
                </div>
                
                <div id="ledger-entries" class="ledger-entries">
                    <!-- Entries will be loaded here -->
                </div>

                <div id="bill-summary" style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <!-- Bill summary will be shown here -->
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="hidden">
                <h2 class="section-title">🖨️ Legal Size Print Reports</h2>
                
                <div class="alert alert-info">
                    <h3>📄 Available Legal Size Reports (8.5" x 14")</h3>
                    <p>All reports optimized for legal size paper with perfect Urdu fonts.</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; border: 2px solid #4CAF50;">
                        <h3 style="color: #4CAF50;">👥 تمام گاہکوں کی رپورٹ</h3>
                        <p>Complete business overview with all customers</p>
                        <button class="btn success" onclick="generateAllCustomersLegalSize()" style="margin-top: 15px;">🖨️ Generate Report</button>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; border: 2px solid #2196F3;">
                        <h3 style="color: #2196F3;">📋 Individual Customer Reports</h3>
                        <p>Legal size customer ledgers</p>
                        <button class="btn info" onclick="showCustomers()" style="margin-top: 15px;">👥 Select Customer</button>
                    </div>
                    
                    <div style="background: #fff3e0; padding: 20px; border-radius: 10px; border: 2px solid #ff9800;">
                        <h3 style="color: #ff9800;">📊 Business Summary</h3>
                        <p>Monthly and yearly business analysis</p>
                        <button class="btn warning" onclick="generateBusinessSummaryLegalSize()" style="margin-top: 15px;">📊 Generate Summary</button>
                    </div>
                </div>
            </div>

            <!-- Backup Section -->
            <div id="backup-section" class="hidden">
                <h2 class="section-title">☁️ بیک اپ اور بحالی</h2>
                
                <!-- GitHub Integration -->
                <div class="github-section">
                    <h3 style="color: #24292e; margin-bottom: 15px;">🔧 GitHub Integration Setup</h3>
                    <p>آپ کا ڈیٹا محفوظ رکھنے کے لیے GitHub سے کنکٹ کریں</p>
                    
                    <div class="alert alert-info" style="margin: 15px 0;">
                        <h4>🎉 GitHub Ready to Use!</h4>
                        <p style="margin: 10px 0;"><strong>✅ Token:</strong> Pre-configured and ready</p>
                        <p style="margin: 10px 0;"><strong>✅ Repository:</strong> abdul8659/milk-business-app</p>
                        <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #28a745;">
                            <strong>🚀 Auto HTML Storage:</strong> All reports automatically saved to GitHub!
                        </div>
                    </div>
                    
                    <div class="github-form">
                        <input type="password" id="github-token" class="github-input" 
                               placeholder="GitHub Personal Access Token (ghp_...)" 
                               value="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">
                        <input type="text" id="github-repo" class="github-input" 
                               placeholder="Repository Name (username/repo-name)" 
                               value="abdul8659/milk-business-app">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <button type="button" class="github-btn" onclick="setupGitHubBackup()">
                                🔧 GitHub کنکٹ کریں
                            </button>
                            <button type="button" class="github-btn" onclick="manualBackup()">
                                ☁️ فوری بیک اپ
                            </button>
                            <button type="button" class="github-btn" onclick="restoreFromGitHub()">
                                ⬇️ GitHub سے بحالی
                            </button>
                            <button type="button" class="github-btn" onclick="testGitHubConnection()">
                                🔗 کنکشن ٹیسٹ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Auto Backup Settings -->
                <div class="github-section">
                    <h3 style="color: #2196F3; margin-bottom: 15px;">⏰ آٹو بیک اپ سیٹنگز</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: end;">
                        <div>
                            <label>بیک اپ کا وقفہ:</label>
                            <select id="backup-interval" onchange="updateBackupInterval()" class="github-input">
                                <option value="0">بند</option>
                                <option value="5" selected>5 منٹ</option>
                                <option value="10">10 منٹ</option>
                                <option value="30">30 منٹ</option>
                                <option value="60">1 گھنٹہ</option>
                            </select>
                        </div>
                        <div>
                            <label>آٹو بیک اپ:</label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="auto-backup-enabled" checked onchange="toggleAutoBackup()">
                                <span>فعال کریں</span>
                            </label>
                        </div>
                        <div>
                            <button type="button" class="btn info" onclick="downloadLocalBackup()" style="width: 100%;">
                                💾 Local Backup
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Backup Status -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="last-backup-time">کبھی نہیں</h3>
                        <p>آخری بیک اپ</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="backup-size">0 KB</h3>
                        <p>ڈیٹا سائز</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="github-status">❌</h3>
                        <p>GitHub Status</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="backup-count">0</h3>
                        <p>کل بیک اپس</p>
                    </div>
                </div>

                <!-- Manual Restore -->
                <div class="github-section">
                    <h3 style="color: #ff9800; margin-bottom: 15px;">📂 Manual Restore</h3>
                    <p>Local backup file سے data restore کریں</p>
                    <div style="display: flex; gap: 15px; align-items: end; margin-top: 15px;">
                        <input type="file" id="restore-file" accept=".json" class="github-input" style="flex: 1;">
                        <button type="button" class="btn warning" onclick="restoreFromFile()">
                            📂 File سے Restore
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Customer Modal -->
    <div id="add-customer-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>نیا گاہک شامل کریں</h3>
            <div class="form-group">
                <label>نام:</label>
                <input type="text" id="customer-name" placeholder="گاہک کا نام">
            </div>
            <div class="form-group">
                <label>فون نمبر:</label>
                <input type="tel" id="customer-phone" placeholder="03xxxxxxxxx">
            </div>
            <div class="form-group">
                <label>پتہ (اختیاری):</label>
                <textarea id="customer-address" placeholder="گاہک کا پتہ"></textarea>
            </div>
            <button class="btn success" onclick="addCustomer()">شامل کریں</button>
        </div>
    </div>

    <!-- Add Delivery Modal -->
    <div id="add-delivery-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="delivery-modal-title">دودھ کی فراہمی شامل کریں</h3>
            <div class="form-group">
                <label>شروع کی تاریخ:</label>
                <input type="date" id="delivery-from-date">
            </div>
            <div class="form-group">
                <label>اختتام کی تاریخ:</label>
                <input type="date" id="delivery-to-date">
            </div>
            <div class="form-group">
                <label>روزانہ لیٹر:</label>
                <input type="number" id="delivery-liters" placeholder="جیسے 2" step="0.1">
            </div>
            <div class="form-group">
                <label>فی لیٹر ریٹ:</label>
                <input type="number" id="delivery-rate" placeholder="جیسے 120" step="0.1">
            </div>
            <div class="form-group">
                <label>تبصرہ (اختیاری):</label>
                <textarea id="delivery-note" placeholder="کوئی خاص بات"></textarea>
            </div>
            <button class="btn success" id="delivery-submit-btn" onclick="addDelivery()">شامل کریں</button>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="add-payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>رقم کی ادائیگی</h3>
            <div class="form-group">
                <label>رقم:</label>
                <input type="number" id="payment-amount" placeholder="ادا شدہ رقم">
            </div>
            <div class="form-group">
                <label>تاریخ:</label>
                <input type="date" id="payment-date">
            </div>
            <div class="form-group">
                <label>تبصرہ:</label>
                <textarea id="payment-note" placeholder="کوئی خاص بات (اختیاری)"></textarea>
            </div>
            <button class="btn success" onclick="addPayment()">ادائیگی شامل کریں</button>
        </div>
    </div>

    <!-- Add Day Off Modal -->
    <div id="add-day-off-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>چھٹی کا دن</h3>
            <div class="form-group">
                <label>تاریخ:</label>
                <input type="date" id="day-off-date">
            </div>
            <div class="form-group">
                <label>وجہ:</label>
                <textarea id="day-off-reason" placeholder="چھٹی کی وجہ"></textarea>
            </div>
            <button class="btn warning" onclick="addDayOff()">چھٹی شامل کریں</button>
        </div>
    </div>

    <script>
        // Global variables
        let customers = [];
        let currentCustomerId = null;
        let nextId = 1;
        let editingEntryId = null;
        let backupInterval = null;
        let gitHubSettings = {
            token: '',
            repo: '',
            username: ''
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            console.log('🚀 Initializing Milk Business App...');
            
            loadFromStorage();
            console.log('📦 Loaded from storage:', customers.length, 'customers');
            
            showDashboard();
            updateDashboard();
            loadCustomers();
            initializeBackupSettings();
            
            // Add debug functionality
            setTimeout(() => {
                addDebugButton();
            }, 1000);
            
            // Automatically fix existing entries on startup
            const fixedCount = fixExistingEntries();
            console.log('🔧 Fixed', fixedCount, 'entries');
            
            // Log successful initialization
            console.log('✅ App initialized successfully');
            updateBackupStatus('✅ App Ready - ' + customers.length + ' customers loaded');
        }

        // =================== ENHANCED ENTRY ID FIXING ===================
        
        function fixExistingEntries() {
            console.log('🔧 Starting to fix existing entries...');
            let totalFixed = 0;
            let customersFixed = 0;
            
            customers.forEach((customer, customerIndex) => {
                if (customer.entries && customer.entries.length > 0) {
                    let customerFixed = false;
                    
                    customer.entries.forEach((entry, index) => {
                        // Check if entry has proper ID
                        if (!entry.id || typeof entry.id !== 'number') {
                            // Generate new ID based on index and timestamp
                            entry.id = Date.now() + index + Math.random() * 1000;
                            totalFixed++;
                            customerFixed = true;
                            console.log(`Fixed entry ID for ${customer.name}:`, entry.id);
                        }
                        
                        // Ensure entry has createdAt timestamp
                        if (!entry.createdAt) {
                            // Try to use existing date fields or create from entry position
                            if (entry.date) {
                                entry.createdAt = new Date(entry.date).toISOString();
                            } else if (entry.fromDate) {
                                entry.createdAt = new Date(entry.fromDate).toISOString();
                            } else {
                                // Create based on index (older entries get older timestamps)
                                const baseDate = new Date('2025-01-01');
                                baseDate.setDate(baseDate.getDate() + index);
                                entry.createdAt = baseDate.toISOString();
                            }
                        }
                        
                        // Ensure entry has proper type
                        if (!entry.type) {
                            if (entry.fromDate && entry.toDate && entry.liters && entry.rate) {
                                entry.type = 'delivery';
                            } else if (entry.amount && entry.date) {
                                entry.type = 'payment';
                            } else if (entry.reason) {
                                entry.type = 'day-off';
                            } else {
                                entry.type = 'delivery'; // Default
                            }
                        }
                        
                        // Auto-assign month for filtering if not present
                        if (!entry.month) {
                            let entryDate = null;
                            if (entry.date) {
                                entryDate = entry.date;
                            } else if (entry.fromDate) {
                                entryDate = entry.fromDate;
                            }
                            
                            if (entryDate) {
                                entry.month = entryDate.substring(0, 7); // YYYY-MM format
                            }
                        }
                    });
                    
                    if (customerFixed) {
                        customersFixed++;
                        console.log(`Fixed entries for customer: ${customer.name}`);
                    }
                }
            });
            
            if (totalFixed > 0) {
                saveToStorage();
                console.log(`✅ Fixed ${totalFixed} entries for ${customersFixed} customers`);
                updateBackupStatus(`🔧 Fixed ${totalFixed} entries automatically`);
                
                // Show notification
                setTimeout(() => {
                    showNotification(`✅ ${totalFixed} entries automatically fixed!`, 'success');
                }, 1000);
            } else {
                console.log('✅ All entries are properly formatted');
            }
            
            return totalFixed;
        }

        // =================== ENHANCED ENTRY EDITING WITH SMART DETECTION ===================
        
        function editDelivery(entryId) {
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer) {
                showNotification('گاہک نہیں ملا', 'error');
                return;
            }
            
            // Smart entry detection - try multiple methods
            let entry = null;
            
            // Method 1: Direct ID match
            if (customer.entries) {
                entry = customer.entries.find(e => e.id === entryId);
            }
            
            // Method 2: If not found, try to find by index (for old entries)
            if (!entry && customer.entries) {
                const entryIndex = customer.entries.findIndex((e, index) => {
                    // Try to match by index if ID doesn't work
                    return index === (entryId % customer.entries.length);
                });
                if (entryIndex !== -1) {
                    entry = customer.entries[entryIndex];
                    // Update the entry ID for future use
                    entry.id = entryId;
                }
            }
            
            // Method 3: Find by content similarity (for entries without proper IDs)
            if (!entry && customer.entries) {
                // Try to find delivery entry by approximate position
                const deliveryEntries = customer.entries.filter(e => e.type === 'delivery' || (e.fromDate && e.toDate));
                if (deliveryEntries.length > 0) {
                    // Use modulo to find a reasonable entry
                    const targetIndex = Math.abs(entryId) % deliveryEntries.length;
                    entry = deliveryEntries[targetIndex];
                    if (entry) {
                        entry.id = entryId; // Assign the ID for future use
                    }
                }
            }
            
            if (!entry) {
                showNotification('انٹری نہیں ملی - یہ پرانے ورژن کی entry ہو سکتی ہے', 'error');
                return;
            }
            
            editingEntryId = entryId;
            document.getElementById('delivery-modal-title').textContent = 'فراہمی میں ترمیم کریں';
            document.getElementById('delivery-submit-btn').textContent = 'اپڈیٹ کریں';
            
            document.getElementById('delivery-from-date').value = entry.fromDate || '';
            document.getElementById('delivery-to-date').value = entry.toDate || '';
            document.getElementById('delivery-liters').value = entry.liters || '';
            document.getElementById('delivery-rate').value = entry.rate || '';
            document.getElementById('delivery-note').value = entry.note || '';
            
            document.getElementById('add-delivery-modal').style.display = 'flex';
        }

        function deleteEntry(entryId) {
            showConfirm('کیا آپ واقعی یہ انٹری حذف کرنا چاہتے ہیں؟', () => {
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer || !customer.entries) {
                    showNotification('گاہک یا انٹریز نہیں ملیں', 'error');
                    return;
                }
                
                // Smart deletion - try multiple methods
                let deleted = false;
                
                // Method 1: Direct ID match
                const originalLength = customer.entries.length;
                customer.entries = customer.entries.filter(e => e.id !== entryId);
                deleted = customer.entries.length < originalLength;
                
                // Method 2: If not deleted, try by index
                if (!deleted) {
                    const entryIndex = Math.abs(entryId) % originalLength;
                    if (entryIndex < customer.entries.length) {
                        customer.entries.splice(entryIndex, 1);
                        deleted = true;
                    }
                }
                
                if (deleted) {
                    saveToStorage();
                    filterByMonth(); // Use filter instead of direct load
                    loadCustomers();
                    updateDashboard();
                    showNotification('انٹری کامیابی سے حذف ہو گئی!', 'success');
                } else {
                    showNotification('انٹری حذف نہیں ہو سکی', 'error');
                }
            });
        }

        // =================== ENHANCED MONTH FILTERING ===================
        
        function filterByMonth() {
            if (!currentCustomerId) {
                return;
            }
            
            const selectedMonth = document.getElementById('month-filter').value;
            const customer = customers.find(c => c.id === currentCustomerId);
            
            if (!customer) {
                return;
            }
            
            let filteredEntries = customer.entries || [];
            
            // Filter entries based on selected month
            if (selectedMonth !== 'all') {
                filteredEntries = customer.entries.filter(entry => {
                    return isEntryInMonth(entry, selectedMonth);
                });
            }
            
            // Load filtered entries
            loadLedgerEntriesFiltered(filteredEntries);
            
            // Update bill summary for filtered entries
            updateBillSummary(filteredEntries, selectedMonth);
        }

        function isEntryInMonth(entry, monthString) {
            if (!monthString || monthString === 'all') {
                return true;
            }
            
            // Check multiple date fields for compatibility
            let entryDate = null;
            
            if (entry.date) {
                entryDate = entry.date;
            } else if (entry.fromDate) {
                entryDate = entry.fromDate;
            } else if (entry.createdAt) {
                entryDate = entry.createdAt;
            }
            
            if (!entryDate) {
                return false;
            }
            
            // Extract year-month from date
            const entryMonth = entryDate.substring(0, 7); // YYYY-MM
            return entryMonth === monthString;
        }

        function setCurrentMonth() {
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().substring(0, 7); // YYYY-MM
            document.getElementById('month-filter').value = currentMonth;
            filterByMonth();
        }

        function setPreviousMonth() {
            const currentDate = new Date();
            currentDate.setMonth(currentDate.getMonth() - 1);
            const previousMonth = currentDate.toISOString().substring(0, 7); // YYYY-MM
            document.getElementById('month-filter').value = previousMonth;
            filterByMonth();
        }

        function getMonthDisplayName(monthString) {
            const monthNames = {
                '2024-01': 'جنوری 2024',
                '2024-02': 'فروری 2024',
                '2024-03': 'مارچ 2024',
                '2024-04': 'اپریل 2024',
                '2024-05': 'مئی 2024',
                '2024-06': 'جون 2024',
                '2024-07': 'جولائی 2024',
                '2024-08': 'اگست 2024',
                '2024-09': 'ستمبر 2024',
                '2024-10': 'اکتوبر 2024',
                '2024-11': 'نومبر 2024',
                '2024-12': 'دسمبر 2024',
                '2025-01': 'جنوری 2025',
                '2025-02': 'فروری 2025',
                '2025-03': 'مارچ 2025',
                '2025-04': 'اپریل 2025',
                '2025-05': 'مئی 2025',
                '2025-06': 'جون 2025',
                '2025-07': 'جولائی 2025',
                '2025-08': 'اگست 2025',
                '2025-09': 'ستمبر 2025',
                '2025-10': 'اکتوبر 2025',
                '2025-11': 'نومبر 2025',
                '2025-12': 'دسمبر 2025'
            };
            
            return monthNames[monthString] || monthString;
        }

        function calculatePreviousMonthBalance(customerId, currentMonth) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.entries) {
                return 0;
            }
            
            let previousRevenue = 0;
            let previousPayments = 0;
            
            customer.entries.forEach(entry => {
                let entryDate = entry.date || entry.fromDate || entry.createdAt;
                if (!entryDate) return;
                
                const entryMonth = entryDate.substring(0, 7);
                if (entryMonth < currentMonth) {
                    if (entry.type === 'delivery') {
                        const days = calculateDays(entry.fromDate, entry.toDate);
                        previousRevenue += days * entry.liters * entry.rate;
                    } else if (entry.type === 'payment') {
                        previousPayments += parseFloat(entry.amount);
                    }
                }
            });
            
            return previousRevenue - previousPayments;
        }

        // =================== ENHANCED GITHUB AUTO-STORAGE ===================
        
        async function generateCurrentCustomerLegalSizeWithAutoSave() {
            if (!currentCustomerId) {
                showNotification('پہلے گاہک منتخب کریں', 'error');
                return;
            }
            
            const htmlContent = await generateCustomerLegalSize(currentCustomerId, true);
            return htmlContent;
        }

        async function generateCustomerLegalSize(customerId, autoSave = true) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('گاہک نہیں ملا', 'error');
                return;
            }
            
            const htmlContent = createCustomerLegalSizeHTML(customer);
            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = `${customer.name.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_')}_LegalSize_${dateStr}.html`;
            
            // Always download locally first
            downloadHTMLFile(htmlContent, fileName);
            
            // Try GitHub auto-save if enabled and connected (but don't fail if it doesn't work)
            if (autoSave && gitHubSettings.token && gitHubSettings.repo) {
                try {
                    const customerFolderName = customer.name.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_');
                    const folderPath = `reports/customers/${customerFolderName}`;
                    
                    // Try to create directory first (but don't fail if it doesn't work)
                    await createGitHubDirectory(folderPath).catch(() => {
                        console.log('Directory creation skipped');
                    });
                    
                    const githubUrl = await saveHTMLToGitHub(htmlContent, fileName, folderPath);
                    if (githubUrl) {
                        showNotification(`${customer.name} کی Legal Size پرنٹ فائل تیار اور GitHub میں محفوظ!`, 'success');
                        console.log('Customer report auto-saved to GitHub:', githubUrl);
                        updateBackupStatus('✅ HTML Report auto-saved to GitHub');
                    } else {
                        // GitHub save failed but that's okay
                        showNotification(`${customer.name} کی Legal Size پرنٹ فائل تیار! (GitHub سیو فیل لیکن Local OK)`, 'success');
                    }
                } catch (error) {
                    console.warn('GitHub auto-save error (non-critical):', error.message);
                    showNotification(`${customer.name} کی Legal Size پرنٹ فائل تیار! (Local file ready)`, 'success');
                }
            } else {
                // GitHub not configured
                showNotification(`${customer.name} کی Legal Size پرنٹ فائل تیار!`, 'success');
                if (!gitHubSettings.token || !gitHubSettings.repo) {
                    setTimeout(() => {
                        showNotification('💡 GitHub auto-save کے لیے Backup section میں جا کر سیٹ اپ کریں', 'info');
                    }, 2000);
                }
            }
            
            return htmlContent;
        }

        async function generateAllCustomersLegalSizeWithAutoSave() {
            if (customers.length === 0) {
                showNotification('کوئی گاہک موجود نہیں', 'warning');
                return;
            }
            
            const htmlContent = createAllCustomersLegalSizeHTML();
            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = `All_Customers_LegalSize_${dateStr}.html`;
            
            // Always download locally first
            downloadHTMLFile(htmlContent, fileName);
            
            // Try GitHub auto-save if connected (but don't fail if it doesn't work)
            if (gitHubSettings.token && gitHubSettings.repo) {
                try {
                    const folderPath = 'reports/all_customers';
                    
                    // Try to create directory (but don't fail if it doesn't work)
                    await createGitHubDirectory(folderPath).catch(() => {
                        console.log('Directory creation skipped');
                    });
                    
                    const githubUrl = await saveHTMLToGitHub(htmlContent, fileName, folderPath);
                    if (githubUrl) {
                        showNotification('تمام گاہکوں کی Legal Size رپورٹ تیار اور GitHub میں محفوظ!', 'success');
                        console.log('All customers report auto-saved to GitHub:', githubUrl);
                        updateBackupStatus('✅ All Customers HTML Report auto-saved');
                    } else {
                        showNotification('تمام گاہکوں کی Legal Size رپورٹ تیار! (GitHub سیو فیل لیکن Local OK)', 'success');
                    }
                } catch (error) {
                    console.warn('GitHub auto-save error (non-critical):', error.message);
                    showNotification('تمام گاہکوں کی Legal Size رپورٹ تیار! (Local file ready)', 'success');
                }
            } else {
                showNotification('تمام گاہکوں کی Legal Size رپورٹ تیار!', 'success');
            }
            
            return htmlContent;
        }

        // Update the existing functions to use auto-save
        async function generateCurrentCustomerLegalSize() {
            return await generateCurrentCustomerLegalSizeWithAutoSave();
        }

        async function generateAllCustomersLegalSize() {
            return await generateAllCustomersLegalSizeWithAutoSave();
        }

        async function generateBusinessSummaryLegalSize() {
            const htmlContent = createBusinessSummaryLegalSizeHTML();
            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = `Business_Summary_LegalSize_${dateStr}.html`;
            
            // Download locally
            downloadHTMLFile(htmlContent, fileName);
            
            // Auto-save to GitHub if connected
            if (gitHubSettings.token && gitHubSettings.repo) {
                try {
                    const folderPath = 'reports/business_summary';
                    
                    // Ensure directory exists
                    await createGitHubDirectory(folderPath);
                    
                    const githubUrl = await saveHTMLToGitHub(htmlContent, fileName, folderPath);
                    if (githubUrl) {
                        showNotification('کاروباری خلاصہ Legal Size رپورٹ تیار اور GitHub میں محفوظ!', 'success');
                        console.log('Business summary auto-saved to GitHub:', githubUrl);
                        updateBackupStatus('✅ Business Summary HTML Report auto-saved');
                    } else {
                        showNotification('کاروباری خلاصہ Legal Size رپورٹ تیار! (GitHub save فیل)', 'warning');
                    }
                } catch (error) {
                    console.error('GitHub auto-save error:', error);
                    showNotification('کاروباری خلاصہ Legal Size رپورٹ تیار! (Local only)', 'success');
                }
            } else {
                showNotification('کاروباری خلاصہ Legal Size رپورٹ تیار!', 'success');
            }
            
            return htmlContent;
        }

        // =================== STORAGE FUNCTIONS ===================
        
        function saveToStorage() {
            try {
                const data = {
                    customers: customers,
                    nextId: nextId,
                    gitHubSettings: gitHubSettings,
                    lastSaved: new Date().toISOString(),
                    version: '6.1'
                };
                
                localStorage.setItem('milkBusinessData', JSON.stringify(data));
                updateBackupStatus('✅ ڈیٹا محفوظ شدہ');
                updateBackupSize();
                
            } catch (error) {
                console.error('Storage save error:', error);
                updateBackupStatus('❌ محفوظیت میں خرابی', 'error');
            }
        }

        function loadFromStorage() {
            try {
                const data = localStorage.getItem('milkBusinessData');
                if (data) {
                    const parsed = JSON.parse(data);
                    customers = parsed.customers || [];
                    nextId = parsed.nextId || 1;
                    gitHubSettings = parsed.gitHubSettings || { token: '', repo: '', username: '' };
                    
                    // Load GitHub settings to form
                    if (gitHubSettings.token) {
                        document.getElementById('github-token').value = gitHubSettings.token;
                    }
                    if (gitHubSettings.repo) {
                        document.getElementById('github-repo').value = gitHubSettings.repo;
                    }
                }
                
                // Initialize with built-in token if no stored settings
                if (!gitHubSettings.token) {
                    const builtInToken = document.getElementById('github-token').value;
                    const builtInRepo = document.getElementById('github-repo').value;
                    if (builtInToken && builtInRepo) {
                        gitHubSettings.token = builtInToken;
                        gitHubSettings.repo = builtInRepo;
                        updateBackupStatus('🚀 GitHub token ready - click connect!');
                    }
                }
            } catch (error) {
                console.error('Storage load error:', error);
                customers = [];
                nextId = 1;
                gitHubSettings = { 
                    token: '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', 
                    repo: 'abdul8659/milk-business-app', 
                    username: '' 
                };
            }
        }

        // =================== LOADING ENHANCED ENTRIES ===================
        
        function loadLedgerEntries(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                console.error('Customer not found:', customerId);
                return;
            }
            
            console.log('Loading entries for customer:', customer.name, 'Entries:', customer.entries);
            
            // Ensure entries exist and are properly formatted
            if (!customer.entries) {
                customer.entries = [];
            }
            
            // Fix any entries that might be missing IDs
            customer.entries.forEach((entry, index) => {
                if (!entry.id) {
                    entry.id = Date.now() + index;
                    console.log('Fixed entry ID:', entry.id);
                }
            });
            
            loadLedgerEntriesFiltered(customer.entries);
        }

        function loadLedgerEntriesFiltered(entries) {
            const container = document.getElementById('ledger-entries');
            
            container.innerHTML = '';

            if (!entries || entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">کوئی انٹری موجود نہیں</div>';
                updateBillSummary([]);
                return;
            }

            // Sort entries by date (newest first)
            const sortedEntries = [...entries].sort((a, b) => {
                const aDate = new Date(a.date || a.fromDate || a.createdAt);
                const bDate = new Date(b.date || b.fromDate || b.createdAt);
                return bDate - aDate;
            });

            sortedEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = `entry-item ${entry.type}`;
                
                // Ensure entry has an ID
                if (!entry.id) {
                    entry.id = Date.now() + Math.random() * 1000;
                }
                
                if (entry.type === 'delivery') {
                    const days = calculateDays(entry.fromDate, entry.toDate);
                    const totalLiters = days * entry.liters;
                    const total = totalLiters * entry.rate;
                    
                    entryDiv.innerHTML = `
                        <div class="entry-actions">
                            <button class="entry-action-btn edit-btn" onclick="editDelivery(${entry.id})" title="ترمیم کریں">✏️</button>
                            <button class="entry-action-btn delete-btn" onclick="deleteEntry(${entry.id})" title="حذف کریں">🗑️</button>
                        </div>
                        <div class="entry-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>🥛 دودھ کی فراہمی</strong>
                                <div style="background: #4CAF50; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                    ${total} روپے
                                </div>
                            </div>
                            📅 ${formatDate(entry.fromDate)} سے ${formatDate(entry.toDate)} تک (${days} دن)<br>
                            🥛 روزانہ ${entry.liters} لیٹر × ${days} دن = <strong>${totalLiters} کل لیٹر</strong><br>
                            💰 ${totalLiters} لیٹر × ${entry.rate} روپے = <strong>${total} روپے</strong><br>
                            ${entry.note ? `📝 ${entry.note}<br>` : ''}
                            ⏰ شامل: ${formatDateTime(entry.createdAt)}
                        </div>
                    `;
                } else if (entry.type === 'payment') {
                    entryDiv.innerHTML = `
                        <div class="entry-actions">
                            <button class="entry-action-btn delete-btn" onclick="deleteEntry(${entry.id})" title="حذف کریں">🗑️</button>
                        </div>
                        <div class="entry-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>💰 ادائیگی</strong>
                                <div style="background: #2196F3; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                    ${entry.amount} روپے
                                </div>
                            </div>
                            📅 ${formatDate(entry.date)}<br>
                            💰 ${entry.amount} روپے<br>
                            ${entry.note ? `📝 ${entry.note}<br>` : ''}
                            ⏰ شامل: ${formatDateTime(entry.createdAt)}
                        </div>
                    `;
                } else if (entry.type === 'day-off') {
                    entryDiv.innerHTML = `
                        <div class="entry-actions">
                            <button class="entry-action-btn delete-btn" onclick="deleteEntry(${entry.id})" title="حذف کریں">🗑️</button>
                        </div>
                        <div class="entry-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>🚫 چھٹی کا دن</strong>
                                <div style="background: #ff416c; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                    آف ڈے
                                </div>
                            </div>
                            📅 ${formatDate(entry.date)}<br>
                            📝 ${entry.reason || 'کوئی وجہ نہیں دی گئی'}<br>
                            ⏰ شامل: ${formatDateTime(entry.createdAt)}
                        </div>
                    `;
                }
                
                container.appendChild(entryDiv);
            });

            updateBillSummary(entries);
        }

        function updateBillSummary(entries, selectedMonth = null) {
            let totalLiters = 0;
            let totalDays = 0;
            let totalAmount = 0;
            let totalPayments = 0;
            let deliveryCount = 0;
            let paymentCount = 0;
            let dayOffCount = 0;

            if (entries && entries.length > 0) {
                entries.forEach(entry => {
                    if (entry.type === 'delivery') {
                        const days = calculateDays(entry.fromDate, entry.toDate);
                        const liters = days * parseFloat(entry.liters || 0);
                        const amount = liters * parseFloat(entry.rate || 0);
                        
                        totalLiters += liters;
                        totalDays += days;
                        totalAmount += amount;
                        deliveryCount++;
                    } else if (entry.type === 'payment') {
                        totalPayments += parseFloat(entry.amount || 0);
                        paymentCount++;
                    } else if (entry.type === 'day-off') {
                        dayOffCount++;
                    }
                });
            }

            const remainingAmount = totalAmount - totalPayments;

            // Add previous balance calculation for monthly view
            let previousBalance = 0;
            if (selectedMonth && selectedMonth !== 'all') {
                previousBalance = calculatePreviousMonthBalance(currentCustomerId, selectedMonth);
            }

            const finalBalance = previousBalance + remainingAmount;

            let summaryHTML = `
                <h3>📋 بل کا خلاصہ</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #4CAF50; font-weight: bold;">${deliveryCount}</div>
                        <div>فراہمی کی تعداد</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #2196F3; font-weight: bold;">${totalDays}</div>
                        <div>کل دن</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #ff9800; font-weight: bold;">${totalLiters}</div>
                        <div>کل لیٹر</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #9c27b0; font-weight: bold;">${totalAmount} روپے</div>
                        <div>${selectedMonth && selectedMonth !== 'all' ? 'اس مہینے کا' : 'کل'} بل</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #4CAF50; font-weight: bold;">${paymentCount}</div>
                        <div>ادائیگیاں</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #4CAF50; font-weight: bold;">${totalPayments} روپے</div>
                        <div>ادا شدہ</div>
                    </div>`;

            if (previousBalance !== 0) {
                summaryHTML += `
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #ff5722; font-weight: bold;">${previousBalance} روپے</div>
                        <div>پچھلا بیلنس</div>
                    </div>`;
            }

            summaryHTML += `
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: ${finalBalance > 0 ? '#f44336' : '#4CAF50'}; font-weight: bold;">${finalBalance} روپے</div>
                        <div>${selectedMonth && selectedMonth !== 'all' ? 'مجموعی' : ''} باقی رقم</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #ff5722; font-weight: bold;">${dayOffCount}</div>
                        <div>چھٹیاں</div>
                    </div>
                </div>
            `;

            document.getElementById('bill-summary').innerHTML = summaryHTML;
        }

        // =================== CONTINUE WITH THE REST OF THE ORIGINAL FUNCTIONS ===================
        // [Include all other functions from the original code but with the fixes above]
        
        // Customer Management Functions
        function loadCustomers() {
            displayCustomers(customers);
        }

        function displayCustomers(customerList) {
            const grid = document.getElementById('customers-grid');
            if (!grid) return;
            
            grid.innerHTML = '';

            customerList.forEach(customer => {
                const card = document.createElement('div');
                card.className = 'customer-card';
                
                // Calculate customer totals
                let totalRevenue = 0;
                let totalPayments = 0;
                let deliveryCount = 0;
                let paymentCount = 0;
                
                if (customer.entries) {
                    customer.entries.forEach(entry => {
                        if (entry.type === 'delivery') {
                            const days = calculateDays(entry.fromDate, entry.toDate);
                            totalRevenue += days * entry.liters * entry.rate;
                            deliveryCount++;
                        } else if (entry.type === 'payment') {
                            totalPayments += parseFloat(entry.amount);
                            paymentCount++;
                        }
                    });
                }
                
                const remaining = totalRevenue - totalPayments;
                const statusEmoji = remaining > 0 ? '🔴' : remaining < 0 ? '🟢' : '🟡';
                
                card.innerHTML = `
                    <h3>${statusEmoji} ${customer.name}</h3>
                    <p>📞 ${customer.phone || 'فون نمبر موجود نہیں'}</p>
                    ${customer.address ? `<p>📍 ${customer.address}</p>` : ''}
                    <div style="margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                        <p><strong>💰 کل بل:</strong> ${totalRevenue} روپے</p>
                        <p><strong>💳 ادا شدہ:</strong> ${totalPayments} روپے</p>
                        <p><strong>📋 باقی:</strong> ${remaining} روپے</p>
                        <p><strong>📝 انٹریز:</strong> ${deliveryCount} فراہمی, ${paymentCount} ادائیگی</p>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn" onclick="event.stopPropagation(); showCustomerLedger(${customer.id})" style="background: #2196F3; padding: 6px 10px; font-size: 11px;">📝 کھاتہ</button>
                        <button class="btn" onclick="event.stopPropagation(); generateCustomerLegalSize(${customer.id})" style="background: #4CAF50; padding: 6px 10px; font-size: 11px;">🖨️ Legal Print</button>
                        <button class="btn" onclick="event.stopPropagation(); sendWhatsApp(${customer.id})" style="background: #25D366; padding: 6px 10px; font-size: 11px;">📱 WhatsApp</button>
                        <button class="btn" onclick="event.stopPropagation(); deleteCustomer(${customer.id})" style="background: #f44336; padding: 6px 10px; font-size: 11px;">🗑️ حذف</button>
                    </div>
                `;
                
                grid.appendChild(card);
            });

            const addBtn = document.createElement('div');
            addBtn.className = 'customer-card add-customer-card';
            addBtn.innerHTML = '➕<br><small style="font-size: 0.5em; margin-top: 10px;">نیا گاہک شامل کریں</small>';
            addBtn.onclick = showAddCustomerModal;
            grid.appendChild(addBtn);
        }

        function showCustomerLedger(customerId) {
            currentCustomerId = customerId;
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) {
                showNotification('گاہک نہیں ملا', 'error');
                console.error('Customer not found with ID:', customerId);
                return;
            }
            
            console.log('Showing ledger for customer:', customer.name);
            console.log('Customer entries:', customer.entries);
            
            document.getElementById('ledger-title').textContent = `${customer.name} کا کھاتہ`;
            showSection('ledger-section');
            
            // Set current month by default
            setCurrentMonth();
            
            // Force load entries
            setTimeout(() => {
                loadLedgerEntries(customerId);
            }, 100);
        }

        // Debug function to check data
        function debugCustomerData() {
            console.log('=== DEBUG: Customer Data ===');
            console.log('Total customers:', customers.length);
            customers.forEach((customer, index) => {
                console.log(`Customer ${index + 1}:`, {
                    id: customer.id,
                    name: customer.name,
                    entriesCount: customer.entries ? customer.entries.length : 0,
                    entries: customer.entries
                });
            });
            console.log('Current customer ID:', currentCustomerId);
        }

        // Add this to the dashboard for debugging
        function addDebugButton() {
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
                const debugBtn = document.createElement('button');
                debugBtn.className = 'btn info';
                debugBtn.textContent = '🔍 Debug Data';
                debugBtn.onclick = debugCustomerData;
                debugBtn.style.margin = '10px';
                
                const existingDebugBtn = dashboardSection.querySelector('[onclick="debugCustomerData()"]');
                if (!existingDebugBtn) {
                    dashboardSection.appendChild(debugBtn);
                }
            }
        }

        function searchCustomers() {
            const searchTerm = document.getElementById('customer-search').value.toLowerCase();
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) || 
                (customer.phone && customer.phone.includes(searchTerm))
            );
            displayCustomers(filteredCustomers);
        }

        function showAddCustomerModal() {
            document.getElementById('add-customer-modal').style.display = 'flex';
        }

        function addCustomer() {
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const address = document.getElementById('customer-address').value.trim();
            
            if (!name) {
                showNotification('براہ کرم نام درج کریں', 'error');
                return;
            }
            
            const customer = {
                id: nextId++,
                name: name,
                phone: phone,
                address: address,
                createdAt: new Date().toISOString(),
                entries: []
            };
            
            customers.push(customer);
            saveToStorage();
            
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('customer-address').value = '';
            
            closeModal();
            loadCustomers();
            updateDashboard();
            
            showNotification('گاہک کامیابی سے شامل ہو گیا!', 'success');
        }

        function deleteCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            showConfirm(`کیا آپ واقعی "${customer.name}" کو حذف کرنا چاہتے ہیں؟`, () => {
                customers = customers.filter(c => c.id !== customerId);
                
                if (currentCustomerId === customerId) {
                    currentCustomerId = null;
                    showCustomers();
                }
                
                saveToStorage();
                loadCustomers();
                updateDashboard();
                
                showNotification(`"${customer.name}" کامیابی سے حذف ہو گیا!`, 'success');
            });
        }

        // Entry Management Functions
        function showAddDeliveryModal() {
            editingEntryId = null;
            document.getElementById('delivery-modal-title').textContent = 'دودھ کی فراہمی شامل کریں';
            document.getElementById('delivery-submit-btn').textContent = 'شامل کریں';
            
            clearDeliveryForm();
            
            // Set default dates to current month
            const currentDate = new Date();
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            document.getElementById('delivery-from-date').value = firstDay.toISOString().split('T')[0];
            document.getElementById('delivery-to-date').value = lastDay.toISOString().split('T')[0];
            
            document.getElementById('add-delivery-modal').style.display = 'flex';
        }

        function showAddPaymentModal() {
            clearPaymentForm();
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-payment-modal').style.display = 'flex';
        }

        function showAddDayOffModal() {
            clearDayOffForm();
            document.getElementById('day-off-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-day-off-modal').style.display = 'flex';
        }

        function addDelivery() {
            if (!currentCustomerId) {
                showNotification('پہلے گاہک منتخب کریں', 'error');
                return;
            }
            
            const fromDate = document.getElementById('delivery-from-date').value;
            const toDate = document.getElementById('delivery-to-date').value;
            const liters = parseFloat(document.getElementById('delivery-liters').value);
            const rate = parseFloat(document.getElementById('delivery-rate').value);
            const note = document.getElementById('delivery-note').value.trim();
            
            if (!fromDate || !toDate || !liters || !rate) {
                showNotification('براہ کرم تمام ضروری فیلڈز بھریں', 'error');
                return;
            }
            
            if (new Date(fromDate) > new Date(toDate)) {
                showNotification('اختتام کی تاریخ شروع کی تاریخ سے پہلے نہیں ہو سکتی', 'error');
                return;
            }
            
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer.entries) {
                customer.entries = [];
            }
            
            if (editingEntryId) {
                const entryIndex = customer.entries.findIndex(e => e.id === editingEntryId);
                if (entryIndex > -1) {
                    customer.entries[entryIndex] = {
                        ...customer.entries[entryIndex],
                        fromDate: fromDate,
                        toDate: toDate,
                        liters: liters,
                        rate: rate,
                        note: note,
                        month: fromDate.substring(0, 7),
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('فراہمی کامیابی سے اپڈیٹ ہو گئی!', 'success');
                }
            } else {
                const entry = {
                    id: Date.now(),
                    type: 'delivery',
                    fromDate: fromDate,
                    toDate: toDate,
                    liters: liters,
                    rate: rate,
                    note: note,
                    month: fromDate.substring(0, 7),
                    createdAt: new Date().toISOString()
                };
                
                customer.entries.push(entry);
                showNotification('فراہمی کامیابی سے شامل ہو گئی!', 'success');
            }
            
            saveToStorage();
            clearDeliveryForm();
            closeModal();
            filterByMonth();
            loadCustomers();
            updateDashboard();
        }

        function addPayment() {
            if (!currentCustomerId) {
                showNotification('پہلے گاہک منتخب کریں', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;
            const note = document.getElementById('payment-note').value.trim();
            
            if (!amount || !date) {
                showNotification('براہ کرم رقم اور تاریخ درج کریں', 'error');
                return;
            }
            
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer.entries) {
                customer.entries = [];
            }
            
            const payment = {
                id: Date.now(),
                type: 'payment',
                amount: amount,
                date: date,
                note: note,
                month: date.substring(0, 7),
                createdAt: new Date().toISOString()
            };
            
            customer.entries.push(payment);
            saveToStorage();
            
            clearPaymentForm();
            closeModal();
            filterByMonth();
            loadCustomers();
            updateDashboard();
            
            showNotification('ادائیگی کامیابی سے شامل ہو گئی!', 'success');
        }

        function addDayOff() {
            if (!currentCustomerId) {
                showNotification('پہلے گاہک منتخب کریں', 'error');
                return;
            }
            
            const date = document.getElementById('day-off-date').value;
            const reason = document.getElementById('day-off-reason').value.trim();
            
            if (!date) {
                showNotification('براہ کرم تاریخ منتخب کریں', 'error');
                return;
            }
            
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer.entries) {
                customer.entries = [];
            }
            
            const dayOff = {
                id: Date.now(),
                type: 'day-off',
                date: date,
                reason: reason,
                month: date.substring(0, 7),
                createdAt: new Date().toISOString()
            };
            
            customer.entries.push(dayOff);
            saveToStorage();
            
            clearDayOffForm();
            closeModal();
            filterByMonth();
            updateDashboard();
            
            showNotification('چھٹی کا دن کامیابی سے شامل ہو گیا!', 'success');
        }

        // Utility Functions
        function calculateDays(fromDate, toDate) {
            const start = new Date(fromDate);
            const end = new Date(toDate);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ur-PK');
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return `${date.toLocaleDateString('ur-PK')} ${date.toLocaleTimeString('ur-PK')}`;
        }

        function updateDashboard() {
            let totalRevenue = 0;
            let totalPayments = 0;
            let totalCustomers = customers.length;
            
            customers.forEach(customer => {
                if (customer.entries) {
                    customer.entries.forEach(entry => {
                        if (entry.type === 'delivery') {
                            const days = calculateDays(entry.fromDate, entry.toDate);
                            totalRevenue += days * entry.liters * entry.rate;
                        } else if (entry.type === 'payment') {
                            totalPayments += parseFloat(entry.amount);
                        }
                    });
                }
            });
            
            const pendingAmount = totalRevenue - totalPayments;
            
            if (document.getElementById('total-customers-stat')) {
                document.getElementById('total-customers-stat').textContent = totalCustomers;
                document.getElementById('total-revenue-stat').textContent = totalRevenue;
                document.getElementById('total-payments-stat').textContent = totalPayments;
                document.getElementById('pending-amount-stat').textContent = pendingAmount;
            }
        }

        // Form Helper Functions
        function clearDeliveryForm() {
            document.getElementById('delivery-from-date').value = '';
            document.getElementById('delivery-to-date').value = '';
            document.getElementById('delivery-liters').value = '';
            document.getElementById('delivery-rate').value = '';
            document.getElementById('delivery-note').value = '';
        }

        function clearPaymentForm() {
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-date').value = '';
            document.getElementById('payment-note').value = '';
        }

        function clearDayOffForm() {
            document.getElementById('day-off-date').value = '';
            document.getElementById('day-off-reason').value = '';
        }

        // Navigation Functions
        function showDashboard() {
            setActiveNav(0);
            showSection('dashboard-section');
            updateDashboard();
        }

        function showCustomers() {
            setActiveNav(1);
            showSection('customers-section');
            loadCustomers();
        }

        function showLedger() {
            if (currentCustomerId) {
                setActiveNav(2);
                showSection('ledger-section');
                loadLedgerEntries(currentCustomerId);
            } else {
                showNotification('پہلے گاہک منتخب کریں', 'info');
                showCustomers();
            }
        }

        function showReports() {
            setActiveNav(3);
            showSection('reports-section');
        }

        function showBackup() {
            setActiveNav(4);
            showSection('backup-section');
        }

        function setActiveNav(index) {
            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        }

        function showSection(sectionId) {
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            editingEntryId = null;
        }

        // Notification Functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 300px;
                font-size: 14px;
                direction: rtl;
                opacity: 0;
                transition: opacity 0.3s ease;
                font-family: 'Noto Sans Arabic', sans-serif;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.opacity = '1', 100);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        function showConfirm(message, callback) {
            const confirmDiv = document.createElement('div');
            confirmDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: 'Noto Sans Arabic', sans-serif;
            `;
            
            confirmDiv.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; direction: rtl; text-align: center;">
                    <p style="margin-bottom: 20px; font-size: 16px; color: #333;">${message}</p>
                    <div>
                        <button id="confirm-yes" style="background: #4CAF50; color: white; border: none; padding: 12px 25px; border-radius: 8px; margin: 5px; cursor: pointer; font-family: 'Noto Sans Arabic', sans-serif;">ہاں</button>
                        <button id="confirm-no" style="background: #f44336; color: white; border: none; padding: 12px 25px; border-radius: 8px; margin: 5px; cursor: pointer; font-family: 'Noto Sans Arabic', sans-serif;">نہیں</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDiv);
            
            document.getElementById('confirm-yes').onclick = function() {
                document.body.removeChild(confirmDiv);
                callback();
            };
            
            document.getElementById('confirm-no').onclick = function() {
                document.body.removeChild(confirmDiv);
            };
        }

        // =================== GITHUB BACKUP FUNCTIONS ===================
        
        async function setupGitHubBackup() {
            const token = document.getElementById('github-token').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            
            if (!token || !repo) {
                showNotification('براہ کرم GitHub ٹوکن اور ریپوزیٹری کا نام داخل کریں', 'error');
                return;
            }
            
            updateBackupStatus('🔧 GitHub سیٹ اپ کر رہے ہیں...', 'syncing');
            
            try {
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Milk-Business-App/1.0'
                    }
                });
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    
                    const repoResponse = await fetch(`https://api.github.com/repos/${repo}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                            'User-Agent': 'Milk-Business-App/1.0'
                        }
                    });
                    
                    let repoExists = false;
                    let repoData = null;
                    
                    if (repoResponse.ok) {
                        repoData = await repoResponse.json();
                        repoExists = true;
                    }
                    
                    gitHubSettings.token = token;
                    gitHubSettings.repo = repo;
                    gitHubSettings.username = userData.login;
                    
                    saveToStorage();
                    updateGitHubStatus('✅ Connected');
                    
                    if (repoExists) {
                        await initializeGitHubStructure();
                        showNotification(`✅ GitHub کامیابی سے کنکٹ!\nUser: ${userData.login}\nRepo: ${repoData.full_name}`, 'success');
                        updateBackupStatus('✅ GitHub تیار - Structure initialized');
                    } else {
                        showNotification(`⚠️ GitHub User OK!\nUser: ${userData.login}\nRepo: ${repo} (نہیں ملی)`, 'warning');
                        updateBackupStatus('⚠️ GitHub OK - Create repository first');
                    }
                    
                    if (document.getElementById('auto-backup-enabled').checked) {
                        startAutoBackup();
                    }
                } else {
                    throw new Error(`GitHub authentication failed: ${userResponse.status}`);
                }
            } catch (error) {
                console.error('GitHub setup error:', error);
                showNotification('❌ GitHub سیٹ اپ میں خرابی: ' + error.message, 'error');
                updateBackupStatus('❌ GitHub سیٹ اپ فیل', 'error');
                updateGitHubStatus('❌ Error');
            }
        }

        async function initializeGitHubStructure() {
            if (!gitHubSettings.token || !gitHubSettings.repo) {
                return;
            }
            
            try {
                const mainReadme = `# 🥛 دودھ کا کاروبار - Milk Business Data

## Directory Structure

- **📁 backups/** - JSON backup files
- **📁 reports/customers/** - Individual customer HTML reports  
- **📁 reports/all_customers/** - Combined customer reports
- **📁 reports/business_summary/** - Business analysis reports

## App Info
- Generated by: Milk Business Management App (Fixed Version)
- Version: 6.1
- Created: ${new Date().toLocaleString('ur-PK')}
- Total Customers: ${customers.length}

## Auto-Features
- ✅ HTML reports automatically saved to GitHub
- ✅ Smart entry ID detection and fixing
- ✅ Enhanced month filtering
- ✅ Backup integration

## Usage
All files are automatically generated and organized by the app.
Each customer gets their own folder for reports.
`;
                
                await saveHTMLToGitHub(mainReadme, 'README.md', '');
                
                await createGitHubDirectory('backups');
                await createGitHubDirectory('reports');
                await createGitHubDirectory('reports/customers'); 
                await createGitHubDirectory('reports/all_customers');
                await createGitHubDirectory('reports/business_summary');
                
                console.log('GitHub repository structure initialized');
            } catch (error) {
                console.error('Structure initialization error:', error);
            }
        }

        async function saveHTMLToGitHub(htmlContent, fileName, folderPath = '') {
            if (!gitHubSettings.token || !gitHubSettings.repo) {
                console.warn('GitHub not configured, skipping auto-save');
                return false;
            }
            
            try {
                const fullPath = folderPath ? `${folderPath}/${fileName}` : fileName;
                const content = btoa(unescape(encodeURIComponent(htmlContent)));
                
                let sha = null;
                try {
                    const checkResponse = await fetch(`https://api.github.com/repos/${gitHubSettings.repo}/contents/${fullPath}`, {
                        headers: {
                            'Authorization': `token ${gitHubSettings.token}`,
                            'User-Agent': 'Milk-Business-App/1.0',
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (checkResponse.ok) {
                        const fileData = await checkResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    console.log('File does not exist, creating new file');
                }
                
                const body = {
                    message: `📄 HTML Report: ${fileName} - ${new Date().toLocaleString('ur-PK')}`,
                    content: content,
                    committer: {
                        name: "Milk Business App",
                        email: "reports@milkbusiness.app"
                    }
                };
                
                if (sha) {
                    body.sha = sha;
                }
                
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.repo}/contents/${fullPath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Milk-Business-App/1.0',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    const responseData = await response.json();
                    console.log('HTML saved to GitHub:', responseData.content.html_url);
                    return responseData.content.html_url;
                } else {
                    const errorData = await response.json();
                    console.error('GitHub API error:', errorData);
                    throw new Error(errorData.message || 'HTML save failed');
                }
                
            } catch (error) {
                console.error('HTML save error:', error);
                
                // Check if it's a network/CORS error
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    showNotification('GitHub auto-save فیل - نیٹ ورک کی خرابی (Local save مکمل)', 'warning');
                } else {
                    showNotification('GitHub auto-save میں خرابی: ' + error.message, 'warning');
                }
                return false;
            }
        }

        async function createGitHubDirectory(dirPath) {
            if (!gitHubSettings.token || !gitHubSettings.repo) {
                return false;
            }
            
            try {
                const readmeContent = `# ${dirPath}\n\nGenerated by Milk Business App (Fixed Version)\nCreated: ${new Date().toLocaleString('ur-PK')}`;
                const content = btoa(unescape(encodeURIComponent(readmeContent)));
                
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.repo}/contents/${dirPath}/README.md`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Milk-Business-App/1.0',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `📁 Create directory: ${dirPath}`,
                        content: content,
                        committer: {
                            name: "Milk Business App",
                            email: "setup@milkbusiness.app"
                        }
                    })
                });
                
                return response.ok;
            } catch (error) {
                console.warn('Directory creation warning:', error.message);
                // Don't show error to user for directory creation as it's not critical
                return false;
            }
        }

        async function manualBackup() {
            if (!gitHubSettings.token || !gitHubSettings.repo) {
                showNotification('پہلے GitHub سیٹ اپ کریں', 'error');
                return;
            }
            
            updateBackupStatus('☁️ GitHub بیک اپ کر رہے ہیں...', 'syncing');
            
            try {
                const data = {
                    customers: customers,
                    nextId: nextId,
                    backupDate: new Date().toISOString(),
                    version: '6.1',
                    metadata: {
                        totalCustomers: customers.length,
                        totalEntries: customers.reduce((sum, c) => sum + (c.entries ? c.entries.length : 0), 0),
                        appName: 'Milk Business Management (Fixed Version)',
                        backupType: 'manual',
                        fixedFeatures: ['Entry ID detection', 'Month filtering', 'GitHub auto-storage']
                    }
                };
                
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const fileName = `backup_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                const backupPath = `backups/${fileName}`;
                
                // Try to create directory first, but don't fail if it doesn't work
                try {
                    await createGitHubDirectory('backups');
                } catch (e) {
                    console.warn('Could not create backups directory, continuing anyway');
                }
                
                const body = {
                    message: `💾 دودھ کا کاروبار - Fixed Version Backup ${new Date().toLocaleString('ur-PK')} - ${customers.length} customers`,
                    content: content,
                    committer: {
                        name: "Milk Business App",
                        email: "backup@milkbusiness.app"
                    }
                };
                
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.repo}/contents/${backupPath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Milk-Business-App/1.0',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    const responseData = await response.json();
                    showNotification('✅ GitHub میں بیک اپ مکمل!', 'success');
                    updateBackupStatus('✅ بیک اپ کامیاب - آخری: ' + new Date().toLocaleTimeString('ur-PK'));
                    updateLastBackupTime();
                    updateBackupCount();
                    console.log('Backup successful:', responseData.content.html_url);
                } else {
                    const errorData = await response.json();
                    console.error('GitHub backup error:', errorData);
                    throw new Error(errorData.message || 'Backup failed');
                }
                
            } catch (error) {
                console.error('Backup error:', error);
                
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    showNotification('❌ نیٹ ورک کی خرابی - انٹرنیٹ کنکشن چیک کریں', 'error');
                    updateBackupStatus('❌ نیٹ ورک ایرر', 'error');
                } else {
                    showNotification('❌ بیک اپ میں خرابی: ' + error.message, 'error');
                    updateBackupStatus('❌ بیک اپ فیل', 'error');
                }
            }
        }

        async function restoreFromGitHub() {
            if (!gitHubSettings.token || !gitHubSettings.repo) {
                showNotification('پہلے GitHub سیٹ اپ کریں', 'error');
                return;
            }
            
            showConfirm('کیا آپ واقعی GitHub سے ڈیٹا بحال کرنا چاہتے ہیں؟ موجودہ ڈیٹا ختم ہو جائے گا۔', async () => {
                updateBackupStatus('⬇️ GitHub سے بحالی...', 'syncing');
                
                try {
                    const response = await fetch(`https://api.github.com/repos/${gitHubSettings.repo}/contents/backups`, {
                        headers: {
                            'Authorization': `token ${gitHubSettings.token}`,
                            'Content-Type': 'application/json',
                            'User-Agent': 'Milk-Business-App/1.0'
                        }
                    });
                    
                    if (response.ok) {
                        const files = await response.json();
                        const backupFiles = files.filter(file => 
                            file.name.startsWith('backup_') && 
                            file.name.endsWith('.json') &&
                            file.type === 'file'
                        );
                        
                        if (backupFiles.length === 0) {
                            throw new Error('کوئی بیک اپ فائل نہیں ملی');
                        }
                        
                        const latestBackup = backupFiles.sort((a, b) => b.name.localeCompare(a.name))[0];
                        
                        const fileResponse = await fetch(latestBackup.download_url, {
                            headers: {
                                'Authorization': `token ${gitHubSettings.token}`,
                                'User-Agent': 'Milk-Business-App/1.0'
                            }
                        });
                        
                        if (fileResponse.ok) {
                            const backupData = await fileResponse.json();
                            
                            if (!backupData.customers || !Array.isArray(backupData.customers)) {
                                throw new Error('Invalid backup file format');
                            }
                            
                            customers = backupData.customers;
                            nextId = backupData.nextId || 1;
                            
                            // Auto-fix any entries in restored data
                            fixExistingEntries();
                            
                            saveToStorage();
                            loadCustomers();
                            updateDashboard();
                            
                            showNotification(`✅ بحالی کامیاب! ${latestBackup.name} سے ${customers.length} گاہک بحال ہوئے`, 'success');
                            updateBackupStatus('✅ بحالی مکمل - ' + new Date().toLocaleTimeString('ur-PK'));
                            
                        } else {
                            throw new Error('فائل ڈاؤن لوڈ نہیں ہو سکی: ' + fileResponse.status);
                        }
                    } else {
                        const errorData = await response.json();
                        throw new Error('بیک اپ فولڈر تک رسائی نہیں: ' + errorData.message);
                    }
                    
                } catch (error) {
                    console.error('Restore error:', error);
                    showNotification('❌ بحالی میں خرابی: ' + error.message, 'error');
                    updateBackupStatus('❌ بحالی فیل', 'error');
                }
            });
        }

        async function testGitHubConnection() {
            const token = document.getElementById('github-token').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            
            if (!token) {
                showNotification('⚠️ پہلے GitHub ٹوکن داخل کریں', 'error');
                return;
            }
            
            updateBackupStatus('🔗 کنکشن ٹیسٹ کر رہے ہیں...', 'syncing');
            
            try {
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Milk-Business-App/1.0'
                    }
                });
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    
                    if (repo) {
                        const repoResponse = await fetch(`https://api.github.com/repos/${repo}`, {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Content-Type': 'application/json',
                                'User-Agent': 'Milk-Business-App/1.0'
                            }
                        });
                        
                        if (repoResponse.ok) {
                            const repoData = await repoResponse.json();
                            showNotification(`✅ مکمل کنکشن کامیاب!\nUser: ${userData.login}\nRepo: ${repoData.full_name}`, 'success');
                            updateBackupStatus('✅ GitHub تیار - User: ' + userData.login);
                            updateGitHubStatus('✅ Connected');
                        } else if (repoResponse.status === 404) {
                            showNotification(`⚠️ User OK لیکن Repository نہیں ملی!\nUser: ${userData.login}`, 'warning');
                            updateBackupStatus('⚠️ Repository نہیں ملی');
                        }
                    } else {
                        showNotification(`✅ Token کنکشن کامیاب!\nUser: ${userData.login}`, 'success');
                        updateBackupStatus('✅ Token OK - Repository needed');
                    }
                } else {
                    throw new Error(`Token verification failed: ${userResponse.status}`);
                }
            } catch (error) {
                console.error('Connection test error:', error);
                showNotification('❌ کنکشن فیل: ' + error.message, 'error');
                updateBackupStatus('❌ کنکشن ٹیسٹ فیل', 'error');
                updateGitHubStatus('❌ Error');
            }
        }

        // =================== AUTO BACKUP FUNCTIONS ===================
        
        function initializeBackupSettings() {
            const autoBackupEnabled = document.getElementById('auto-backup-enabled').checked;
            if (autoBackupEnabled && gitHubSettings.token && gitHubSettings.repo) {
                startAutoBackup();
            }
            updateBackupSize();
            
            const hasBuiltInToken = document.getElementById('github-token').value.startsWith('ghp_');
            if (hasBuiltInToken && gitHubSettings.username) {
                updateGitHubStatus('✅ Connected');
            } else if (hasBuiltInToken) {
                updateGitHubStatus('🚀 Ready to Connect');
            } else {
                updateGitHubStatus('❌ Setup Needed');
            }
            
            const storedCount = localStorage.getItem('backupCount') || '0';
            const countEl = document.getElementById('backup-count');
            if (countEl) {
                countEl.textContent = storedCount;
            }
        }

        function toggleAutoBackup() {
            const enabled = document.getElementById('auto-backup-enabled').checked;
            if (enabled) {
                if (gitHubSettings.token && gitHubSettings.repo) {
                    startAutoBackup();
                    showNotification('آٹو بیک اپ فعال', 'success');
                } else {
                    showNotification('پہلے GitHub سیٹ اپ کریں', 'error');
                    document.getElementById('auto-backup-enabled').checked = false;
                }
            } else {
                stopAutoBackup();
                showNotification('آٹو بیک اپ بند', 'info');
            }
        }

        function updateBackupInterval() {
            const interval = parseInt(document.getElementById('backup-interval').value);
            if (interval > 0 && document.getElementById('auto-backup-enabled').checked) {
                stopAutoBackup();
                startAutoBackup();
                showNotification(`بیک اپ وقفہ: ${interval} منٹ`, 'info');
            }
        }

        function startAutoBackup() {
            stopAutoBackup();
            
            const interval = parseInt(document.getElementById('backup-interval').value);
            if (interval > 0) {
                backupInterval = setInterval(() => {
                    manualBackup();
                }, interval * 60 * 1000);
                
                updateBackupStatus(`⏰ آٹو بیک اپ: ${interval} منٹ`);
            }
        }

        function stopAutoBackup() {
            if (backupInterval) {
                clearInterval(backupInterval);
                backupInterval = null;
            }
        }

        function downloadLocalBackup() {
            try {
                const data = {
                    customers: customers,
                    nextId: nextId,
                    backupDate: new Date().toISOString(),
                    version: '6.1',
                    metadata: {
                        totalCustomers: customers.length,
                        totalEntries: customers.reduce((sum, c) => sum + (c.entries ? c.entries.length : 0), 0),
                        appName: 'Milk Business Management (Fixed Version)',
                        fixedFeatures: ['Entry ID detection', 'Month filtering', 'GitHub auto-storage']
                    }
                };
                
                const content = JSON.stringify(data, null, 2);
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `milk_business_backup_fixed_${new Date().toISOString().split('T')[0]}.json`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('📥 Local backup ڈاؤن لوڈ مکمل!', 'success');
                updateBackupStatus('📥 Local backup تیار');
                
            } catch (error) {
                console.error('Local backup error:', error);
                showNotification('❌ Local backup میں خرابی', 'error');
            }
        }

        function restoreFromFile() {
            const fileInput = document.getElementById('restore-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('پہلے فائل منتخب کریں', 'error');
                return;
            }
            
            showConfirm('کیا آپ واقعی فائل سے ڈیٹا بحال کرنا چاہتے ہیں؟ موجودہ ڈیٹا ختم ہو جائے گا۔', () => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.customers || !Array.isArray(backupData.customers)) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        customers = backupData.customers;
                        nextId = backupData.nextId || 1;
                        
                        // Auto-fix any entries in restored data
                        fixExistingEntries();
                        
                        saveToStorage();
                        loadCustomers();
                        updateDashboard();
                        
                        showNotification('✅ فائل سے بحالی کامیاب!', 'success');
                        updateBackupStatus('✅ فائل بحالی مکمل');
                        
                        fileInput.value = '';
                        
                    } catch (error) {
                        console.error('File restore error:', error);
                        showNotification('❌ فائل بحالی میں خرابی: Invalid format', 'error');
                    }
                };
                reader.readAsText(file);
            });
        }

        // =================== BACKUP STATUS FUNCTIONS ===================
        
        function updateBackupStatus(message, type = 'success') {
            const statusEl = document.getElementById('backup-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'backup-status';
                if (type === 'error') statusEl.classList.add('error');
                if (type === 'syncing') statusEl.classList.add('syncing');
            }
        }

        function updateBackupSize() {
            const data = JSON.stringify({ customers, nextId });
            const sizeKB = Math.round(new Blob([data]).size / 1024);
            const sizeEl = document.getElementById('backup-size');
            if (sizeEl) {
                sizeEl.textContent = `${sizeKB} KB`;
            }
        }

        function updateLastBackupTime() {
            const timeEl = document.getElementById('last-backup-time');
            if (timeEl) {
                timeEl.textContent = new Date().toLocaleString('ur-PK');
            }
        }

        function updateGitHubStatus(status) {
            const statusEl = document.getElementById('github-status');
            if (statusEl) {
                statusEl.textContent = status;
            }
        }

        function updateBackupCount() {
            const countEl = document.getElementById('backup-count');
            if (countEl) {
                let count = parseInt(localStorage.getItem('backupCount') || '0');
                count++;
                localStorage.setItem('backupCount', count.toString());
                countEl.textContent = count.toString();
            }
        }

        // =================== LEGAL SIZE HTML GENERATION ===================
        
        function createCustomerLegalSizeHTML(customer) {
            let totalRevenue = 0;
            let totalPayments = 0;
            let deliveryEntries = [];
            let paymentEntries = [];
            let dayOffEntries = [];
            
            if (customer.entries) {
                customer.entries.forEach(entry => {
                    if (entry.type === 'delivery') {
                        const days = calculateDays(entry.fromDate, entry.toDate);
                        const totalLiters = days * entry.liters;
                        const amount = totalLiters * entry.rate;
                        totalRevenue += amount;
                        
                        deliveryEntries.push({
                            ...entry,
                            days: days,
                            totalLiters: totalLiters,
                            amount: amount
                        });
                    } else if (entry.type === 'payment') {
                        totalPayments += parseFloat(entry.amount);
                        paymentEntries.push(entry);
                    } else if (entry.type === 'day-off') {
                        dayOffEntries.push(entry);
                    }
                });
            }
            
            const remaining = totalRevenue - totalPayments;
            
            deliveryEntries.sort((a, b) => new Date(b.fromDate) - new Date(a.fromDate));
            paymentEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
            dayOffEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const html = `<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${customer.name} - Legal Size Ledger (Fixed Version)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans Arabic', 'Segoe UI', Tahoma, sans-serif;
            direction: rtl;
            line-height: 1.5;
            color: #333;
            background: #fff;
            padding: 25px;
            font-size: 16px;
            font-weight: 500;
        }
        
        @page {
            size: legal;
            margin: 0.4in;
        }
        
        .print-header {
            text-align: center;
            border-bottom: 4px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .print-header h1 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 12px;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .print-header h2 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .print-header p {
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }
        
        .print-customer-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-right: 6px solid #667eea;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .info-item {
            background: white;
            padding: 18px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        
        .info-item strong {
            color: #333;
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 700;
        }
        
        .info-item span {
            font-size: 15px;
            font-weight: 600;
        }
        
        .print-summary {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            text-align: center;
        }
        
        .summary-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #2196F3;
        }
        
        .summary-item h3 {
            color: #2196F3;
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 800;
        }
        
        .summary-item p {
            font-size: 14px;
            font-weight: 600;
        }
        
        .print-entries-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .print-entries-table th,
        .print-entries-table td {
            border: 2px solid #333;
            padding: 12px;
            text-align: right;
            vertical-align: top;
        }
        
        .print-entries-table th {
            background: #333;
            color: white;
            font-weight: 800;
            font-size: 15px;
        }
        
        .print-entries-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .print-entries-table td {
            font-weight: 600;
        }
        
        .section-title {
            color: #333;
            font-size: 20px;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 3px solid #667eea;
            font-weight: 800;
        }
        
        .amount-positive { 
            color: #4CAF50; 
            font-weight: 800;
            font-size: 15px;
        }
        .amount-negative { 
            color: #f44336; 
            font-weight: 800;
            font-size: 15px;
        }
        .amount-neutral { 
            color: #2196F3; 
            font-weight: 800;
            font-size: 15px;
        }
        
        .final-summary {
            background: #e8f5e8;
            border: 3px solid #4CAF50;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            text-align: center;
        }
        
        .final-summary h3 {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 22px;
            font-weight: 800;
        }
        
        .final-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .final-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #4CAF50;
        }
        
        .final-item h4 {
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 700;
        }
        
        .final-item .value {
            font-size: 22px;
            font-weight: 800;
            color: #1b5e20;
        }
        
        .print-footer {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            text-align: center;
            color: #666;
            border-top: 2px solid #e0e0e0;
            padding-top: 12px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .version-info {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Extra bold for important values */
        .super-bold {
            font-weight: 900 !important;
            font-size: 16px;
        }
        
        /* Enhanced table styling for better print readability */
        .print-entries-table td.amount-cell {
            font-weight: 800;
            font-size: 15px;
            background: #f0f8ff;
        }
        
        .print-entries-table td.date-cell {
            font-weight: 700;
            font-size: 14px;
        }
        
        .print-entries-table td.quantity-cell {
            font-weight: 700;
            font-size: 14px;
            text-align: center;
        }
        
        @media print {
            body { 
                padding: 0; 
                background: white;
                font-size: 16px;
                font-weight: 500;
            }
            .no-print {
                display: none !important;
            }
            
            /* Ensure fonts are bold enough for print */
            .print-entries-table {
                font-size: 14px;
                font-weight: 600;
            }
            
            .print-entries-table th {
                font-weight: 900;
                font-size: 15px;
            }
            
            .print-entries-table td {
                font-weight: 600;
            }
        }
    </style>
</head>
<body>
    <div class="version-info">
        <strong>📋 Fixed Version Report:</strong> Entry ID detection ✅ | Month filtering ✅ | GitHub auto-storage ✅
    </div>

    <div class="print-header">
        <h1>🥛 دودھ کا کاروبار</h1>
        <h2>${customer.name} - مکمل کھاتہ (Legal Size)</h2>
        <p>تاریخ: ${new Date().toLocaleDateString('ur-PK')} | وقت: ${new Date().toLocaleTimeString('ur-PK')}</p>
    </div>

    <div class="print-customer-info">
        <div class="info-item">
            <strong>نام:</strong>
            <span class="super-bold">${customer.name}</span>
        </div>
        <div class="info-item">
            <strong>فون نمبر:</strong>
            <span class="super-bold">${customer.phone || 'فراہم نہیں'}</span>
        </div>
        ${customer.address ? `
        <div class="info-item">
            <strong>پتہ:</strong>
            <span class="super-bold">${customer.address}</span>
        </div>
        ` : ''}
        <div class="info-item">
            <strong>کل انٹریز:</strong>
            <span class="super-bold">${customer.entries ? customer.entries.length : 0}</span>
        </div>
    </div>

    <div class="print-summary">
        <div class="summary-item">
            <h3>${totalRevenue.toLocaleString('ur-PK')}</h3>
            <p><strong>کل بل (روپے)</strong></p>
        </div>
        <div class="summary-item">
            <h3>${totalPayments.toLocaleString('ur-PK')}</h3>
            <p><strong>ادا شدہ (روپے)</strong></p>
        </div>
        <div class="summary-item">
            <h3 class="${remaining > 0 ? 'amount-negative' : remaining < 0 ? 'amount-positive' : 'amount-neutral'}">${remaining.toLocaleString('ur-PK')}</h3>
            <p><strong>باقی رقم (روپے)</strong></p>
        </div>
        <div class="summary-item">
            <h3>${deliveryEntries.length}</h3>
            <p><strong>فراہمی انٹریز</strong></p>
        </div>
    </div>

    ${deliveryEntries.length > 0 ? `
    <div class="section-title">🥛 دودھ کی فراہمی</div>
    <table class="print-entries-table">
        <thead>
            <tr>
                <th>شروع</th>
                <th>اختتام</th>
                <th>دن</th>
                <th>لیٹر/دن</th>
                <th>کل لیٹر</th>
                <th>ریٹ</th>
                <th>کل رقم</th>
                <th>تبصرہ</th>
            </tr>
        </thead>
        <tbody>
            ${deliveryEntries.map(entry => `
                <tr>
                    <td class="date-cell">${formatDate(entry.fromDate)}</td>
                    <td class="date-cell">${formatDate(entry.toDate)}</td>
                    <td class="quantity-cell super-bold">${entry.days}</td>
                    <td class="quantity-cell super-bold">${entry.liters}</td>
                    <td class="quantity-cell super-bold">${entry.totalLiters}</td>
                    <td class="quantity-cell super-bold">${entry.rate}</td>
                    <td class="amount-cell amount-positive">${entry.amount.toLocaleString('ur-PK')}</td>
                    <td>${entry.note || '-'}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    ` : ''}

    ${paymentEntries.length > 0 ? `
    <div class="section-title">💰 ادائیگی کی تفصیلات</div>
    <table class="print-entries-table">
        <thead>
            <tr>
                <th>تاریخ</th>
                <th>رقم</th>
                <th>تبصرہ</th>
            </tr>
        </thead>
        <tbody>
            ${paymentEntries.map(entry => `
                <tr>
                    <td class="date-cell">${formatDate(entry.date)}</td>
                    <td class="amount-cell amount-positive">${parseFloat(entry.amount).toLocaleString('ur-PK')} روپے</td>
                    <td class="super-bold">${entry.note || '-'}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    ` : ''}

    ${dayOffEntries.length > 0 ? `
    <div class="section-title">🚫 چھٹی کے دن</div>
    <table class="print-entries-table">
        <thead>
            <tr>
                <th>تاریخ</th>
                <th>وجہ</th>
            </tr>
        </thead>
        <tbody>
            ${dayOffEntries.map(entry => `
                <tr>
                    <td class="date-cell">${formatDate(entry.date)}</td>
                    <td class="super-bold">${entry.reason || '-'}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    ` : ''}

    <div class="final-summary">
        <h3>📊 حتمی خلاصہ</h3>
        <div class="final-grid">
            <div class="final-item">
                <h4>کل بل</h4>
                <div class="value">${totalRevenue.toLocaleString('ur-PK')} روپے</div>
            </div>
            <div class="final-item">
                <h4>ادا شدہ</h4>
                <div class="value">${totalPayments.toLocaleString('ur-PK')} روپے</div>
            </div>
            <div class="final-item">
                <h4>باقی</h4>
                <div class="value" style="color: ${remaining > 0 ? '#d32f2f' : '#1b5e20'}">${remaining.toLocaleString('ur-PK')} روپے</div>
            </div>
        </div>
    </div>

    <div class="print-footer">
        <p><strong>Legal Size Report (Fixed Version) | ${customer.name} | Generated: ${new Date().toLocaleDateString('ur-PK')} ${new Date().toLocaleTimeString('ur-PK')}</strong></p>
        <p><strong>Perfect Urdu Legal Size Printing - Auto-saved to GitHub</strong></p>
    </div>
</body>
</html>`;
            
            return html;
        }

        function createAllCustomersLegalSizeHTML() {
            const html = `<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Customers - Legal Size Report (Fixed Version)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700;800;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans Arabic', 'Segoe UI', Tahoma, sans-serif;
            direction: rtl;
            line-height: 1.5;
            color: #333;
            background: #fff;
            padding: 25px;
            font-size: 16px;
            font-weight: 500;
        }
        
        @page { 
            size: legal; 
            margin: 0.4in; 
        }
        
        .version-info {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .print-header {
            text-align: center;
            border-bottom: 4px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .print-header h1 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 12px;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .print-header h2 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .print-header p {
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }
        
        .print-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            text-align: center;
        }
        
        .summary-item {
            background: white;
            padding: 18px;
            border-radius: 8px;
            border: 3px solid #667eea;
        }
        
        .summary-item h3 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 800;
        }
        
        .summary-item p {
            font-size: 14px;
            font-weight: 700;
        }
        
        .customers-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            font-weight: 600;
        }
        
        .customers-table th,
        .customers-table td {
            border: 2px solid #333;
            padding: 12px;
            text-align: right;
        }
        
        .customers-table th {
            background: #333;
            color: white;
            font-weight: 800;
            font-size: 15px;
        }
        
        .customers-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .customers-table td {
            font-weight: 600;
        }
        
        .customers-table td.customer-name {
            font-weight: 800;
            font-size: 15px;
            color: #333;
        }
        
        .customers-table td.phone-cell {
            font-weight: 700;
            font-size: 13px;
        }
        
        .customers-table td.amount-cell {
            font-weight: 800;
            font-size: 14px;
            text-align: center;
        }
        
        .amount-positive { 
            color: #4CAF50; 
            font-weight: 800;
        }
        .amount-negative { 
            color: #f44336; 
            font-weight: 800;
        }
        .amount-neutral { 
            color: #2196F3; 
            font-weight: 800;
        }
        
        .print-footer {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            text-align: center;
            color: #666;
            border-top: 2px solid #e0e0e0;
            padding-top: 12px;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Enhanced styling for important numbers */
        .super-bold {
            font-weight: 900 !important;
            font-size: 16px;
        }
        
        @media print {
            body { 
                padding: 0; 
                background: white;
                font-size: 16px;
                font-weight: 500;
            }
            
            .customers-table {
                font-size: 14px;
                font-weight: 600;
            }
            
            .customers-table th {
                font-weight: 900;
                font-size: 15px;
            }
            
            .customers-table td {
                font-weight: 600;
            }
        }
    </style>
</head>
<body>
    <div class="version-info">
        <strong>📋 Fixed Version Report:</strong> Entry ID detection ✅ | Month filtering ✅ | GitHub auto-storage ✅
    </div>

    <div class="print-header">
        <h1>🥛 دودھ کا کاروبار</h1>
        <h2>تمام گاہکوں کی مکمل رپورٹ (Legal Size)</h2>
        <p>تاریخ: ${new Date().toLocaleDateString('ur-PK')} | وقت: ${new Date().toLocaleTimeString('ur-PK')}</p>
    </div>

    ${(() => {
        let totalCustomers = customers.length;
        let totalRevenue = 0;
        let totalPayments = 0;
        let totalDeliveries = 0;
        
        customers.forEach(customer => {
            if (customer.entries) {
                customer.entries.forEach(entry => {
                    if (entry.type === 'delivery') {
                        const days = calculateDays(entry.fromDate, entry.toDate);
                        totalRevenue += days * entry.liters * entry.rate;
                        totalDeliveries++;
                    } else if (entry.type === 'payment') {
                        totalPayments += parseFloat(entry.amount);
                    }
                });
            }
        });
        
        const totalPending = totalRevenue - totalPayments;
        
        return `
        <div class="print-summary">
            <div class="summary-item">
                <h3>${totalCustomers}</h3>
                <p><strong>کل گاہک</strong></p>
            </div>
            <div class="summary-item">
                <h3>${totalRevenue.toLocaleString('ur-PK')}</h3>
                <p><strong>کل آمدنی</strong></p>
            </div>
            <div class="summary-item">
                <h3>${totalPayments.toLocaleString('ur-PK')}</h3>
                <p><strong>وصول شدہ</strong></p>
            </div>
            <div class="summary-item">
                <h3>${totalPending.toLocaleString('ur-PK')}</h3>
                <p><strong>باقی رقم</strong></p>
            </div>
        </div>
        `;
    })()}

    <table class="customers-table">
        <thead>
            <tr>
                <th>#</th>
                <th>نام</th>
                <th>فون</th>
                <th>کل بل</th>
                <th>ادا شدہ</th>
                <th>باقی</th>
                <th>انٹریز</th>
            </tr>
        </thead>
        <tbody>
            ${customers.map((customer, index) => {
                let customerRevenue = 0;
                let customerPayments = 0;
                let entryCount = 0;
                
                if (customer.entries) {
                    customer.entries.forEach(entry => {
                        entryCount++;
                        if (entry.type === 'delivery') {
                            const days = calculateDays(entry.fromDate, entry.toDate);
                            customerRevenue += days * entry.liters * entry.rate;
                        } else if (entry.type === 'payment') {
                            customerPayments += parseFloat(entry.amount);
                        }
                    });
                }
                
                const customerRemaining = customerRevenue - customerPayments;
                const statusClass = customerRemaining > 0 ? 'amount-negative' : customerRemaining < 0 ? 'amount-positive' : 'amount-neutral';
                
                return `
                    <tr>
                        <td class="amount-cell super-bold">${index + 1}</td>
                        <td class="customer-name">${customer.name}</td>
                        <td class="phone-cell">${customer.phone || '-'}</td>
                        <td class="amount-cell amount-neutral">${customerRevenue.toLocaleString('ur-PK')}</td>
                        <td class="amount-cell amount-positive">${customerPayments.toLocaleString('ur-PK')}</td>
                        <td class="amount-cell ${statusClass}">${customerRemaining.toLocaleString('ur-PK')}</td>
                        <td class="amount-cell super-bold">${entryCount}</td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    </table>

    <div class="print-footer">
        <p><strong>All Customers Legal Size Report (Fixed Version) | Generated: ${new Date().toLocaleDateString('ur-PK')} ${new Date().toLocaleTimeString('ur-PK')}</strong></p>
        <p><strong>Perfect Urdu Legal Size Printing - Auto-saved to GitHub</strong></p>
    </div>
</body>
</html>`;
            
            return html;
        }

        function createBusinessSummaryLegalSizeHTML() {
            const html = `<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Summary - Legal Size (Fixed Version)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700;800;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            direction: rtl;
            line-height: 1.5;
            color: #333;
            background: #fff;
            padding: 25px;
            font-size: 16px;
            font-weight: 500;
        }
        
        @page { 
            size: legal; 
            margin: 0.4in; 
        }
        
        .version-info {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .print-header {
            text-align: center;
            border-bottom: 4px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .print-header h1 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 12px;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .print-header h2 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .print-header p {
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }
        
        .summary-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
            border: 3px solid #667eea;
        }
        
        .summary-section h3 {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: 800;
            color: #667eea;
        }
        
        .summary-section p {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #667eea;
            text-align: center;
        }
        
        .stat-item h4 {
            color: #667eea;
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .stat-item .value {
            font-size: 28px;
            font-weight: 900;
            color: #333;
        }
        
        @media print {
            body { 
                padding: 0; 
                background: white;
                font-size: 16px;
                font-weight: 500;
            }
        }
    </style>
</head>
<body>
    <div class="version-info">
        <strong>📋 Fixed Version Report:</strong> Entry ID detection ✅ | Month filtering ✅ | GitHub auto-storage ✅
    </div>

    <div class="print-header">
        <h1>🥛 دودھ کا کاروبار</h1>
        <h2>کاروباری خلاصہ (Legal Size)</h2>
        <p>تاریخ: ${new Date().toLocaleDateString('ur-PK')}</p>
    </div>

    <div class="summary-section">
        <h3>📊 کاروباری تجزیہ</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <h4>کل گاہک</h4>
                <div class="value">${customers.length}</div>
            </div>
            <div class="stat-item">
                <h4>کل انٹریز</h4>
                <div class="value">${customers.reduce((sum, c) => sum + (c.entries ? c.entries.length : 0), 0)}</div>
            </div>
        </div>
        <p><strong>Report generated for legal size printing (8.5" x 14")</strong></p>
        <p><strong>All features working: Entry management, Month filtering, GitHub integration</strong></p>
        <p><strong>Perfect fonts and formatting for clear printing</strong></p>
    </div>
</body>
</html>`;
            
            return html;
        }

        function downloadHTMLFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // =================== WHATSAPP FUNCTIONS ===================
        
        function sendWhatsApp(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('گاہک نہیں ملا', 'error');
                return;
            }
            
            const message = generateWhatsAppMessage(customer);
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
            showNotification(`${customer.name} کا کھاتہ WhatsApp کے لیے تیار!`, 'success');
        }

        function sendCurrentCustomerWhatsApp() {
            if (!currentCustomerId) {
                showNotification('پہلے گاہک منتخب کریں', 'error');
                return;
            }
            sendWhatsApp(currentCustomerId);
        }

        function generateWhatsAppMessage(customer) {
            const selectedMonth = currentCustomerId ? document.getElementById('month-filter')?.value || 'all' : 'all';
            const monthName = selectedMonth === 'all' ? 'مکمل کھاتہ' : getMonthDisplayName(selectedMonth);
            
            let message = `🥛 *دودھ کا کاروبار*\n`;
            message += `═══════════════════════════\n\n`;
            message += `👤 *گاہک کی تفصیلات:*\n`;
            message += `📝 نام: ${customer.name}\n`;
            if (customer.phone) {
                message += `📱 فون: ${customer.phone}\n`;
            }
            if (customer.address) {
                message += `🏠 پتہ: ${customer.address}\n`;
            }
            message += `📅 رپورٹ کی تاریخ: ${new Date().toLocaleDateString('ur-PK')}\n`;
            message += `⏰ وقت: ${new Date().toLocaleTimeString('ur-PK')}\n\n`;
            message += `═══════════════════════════\n\n`;

            let totalRevenue = 0;
            let totalPayments = 0;
            let deliveryEntries = [];
            let paymentEntries = [];
            let dayOffEntries = [];
            
            if (customer.entries) {
                customer.entries.forEach(entry => {
                    if (selectedMonth !== 'all' && !isEntryInMonth(entry, selectedMonth)) {
                        return;
                    }
                    
                    if (entry.type === 'delivery') {
                        const days = calculateDays(entry.fromDate, entry.toDate);
                        const totalLiters = days * entry.liters;
                        const amount = totalLiters * entry.rate;
                        totalRevenue += amount;
                        
                        deliveryEntries.push({
                            ...entry,
                            days: days,
                            totalLiters: totalLiters,
                            amount: amount
                        });
                    } else if (entry.type === 'payment') {
                        totalPayments += parseFloat(entry.amount);
                        paymentEntries.push(entry);
                    } else if (entry.type === 'day-off') {
                        dayOffEntries.push(entry);
                    }
                });
            }
            
            const previousBalance = selectedMonth !== 'all' ? calculatePreviousMonthBalance(customer.id, selectedMonth) : 0;
            const currentMonthBalance = totalRevenue - totalPayments;
            const overallBalance = previousBalance + currentMonthBalance;

            message += `💰 *مالی خلاصہ (${monthName}):*\n`;
            message += `▫️ `;
            if (previousBalance !== 0) {
                message += `پچھلا بیلنس: ${previousBalance.toLocaleString('ur-PK')} روپے\n▫️ `;
            }
            message += `${selectedMonth === 'all' ? 'کل' : 'اس مہینے کا'} بل: ${totalRevenue.toLocaleString('ur-PK')} روپے\n`;
            message += `▫️ ادا شدہ رقم: ${totalPayments.toLocaleString('ur-PK')} روپے\n`;
            message += `▫️ باقی رقم: ${overallBalance.toLocaleString('ur-PK')} روپے\n`;
            message += `▫️ کل انٹریز: ${deliveryEntries.length} فراہمی، ${paymentEntries.length} ادائیگی\n\n`;

            if (deliveryEntries.length > 0) {
                message += `🥛 *دودھ کی فراہمی کی تفصیل:*\n`;
                message += `───────────────────────────\n`;
                deliveryEntries.sort((a, b) => new Date(b.fromDate) - new Date(a.fromDate));
                deliveryEntries.slice(0, 5).forEach((entry, index) => {
                    message += `${index + 1}️⃣ *${formatDate(entry.fromDate)}* سے *${formatDate(entry.toDate)}*\n`;
                    message += `   🗓️ کل دن: ${entry.days}\n`;
                    message += `   🥛 روزانہ: ${entry.liters} لیٹر\n`;
                    message += `   📊 کل لیٹر: ${entry.totalLiters}\n`;
                    message += `   💵 ریٹ: ${entry.rate} روپے فی لیٹر\n`;
                    message += `   💰 *کل رقم: ${entry.amount.toLocaleString('ur-PK')} روپے*\n`;
                    if (entry.note) {
                        message += `   📝 نوٹ: ${entry.note}\n`;
                    }
                    message += `\n`;
                });
                if (deliveryEntries.length > 5) {
                    message += `... اور ${deliveryEntries.length - 5} مزید فراہمی انٹریز\n\n`;
                }
            }

            if (paymentEntries.length > 0) {
                message += `💳 *ادائیگی کی تفصیل:*\n`;
                message += `───────────────────────────\n`;
                paymentEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
                paymentEntries.slice(0, 5).forEach((entry, index) => {
                    message += `${index + 1}️⃣ *${formatDate(entry.date)}*\n`;
                    message += `   💰 رقم: ${parseFloat(entry.amount).toLocaleString('ur-PK')} روپے\n`;
                    if (entry.note) {
                        message += `   📝 نوٹ: ${entry.note}\n`;
                    }
                    message += `\n`;
                });
                if (paymentEntries.length > 5) {
                    message += `... اور ${paymentEntries.length - 5} مزید ادائیگیاں\n\n`;
                }
            }

            if (dayOffEntries.length > 0) {
                message += `🚫 *چھٹی کے دن:*\n`;
                message += `───────────────────────────\n`;
                dayOffEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
                dayOffEntries.slice(0, 3).forEach((entry, index) => {
                    message += `${index + 1}️⃣ ${formatDate(entry.date)}\n`;
                    message += `   📝 وجہ: ${entry.reason || 'کوئی وجہ نہیں'}\n\n`;
                });
                if (dayOffEntries.length > 3) {
                    message += `... اور ${dayOffEntries.length - 3} مزید چھٹیاں\n\n`;
                }
            }

            message += `═══════════════════════════\n`;
            message += `🏪 *دودھ کا کاروبار*\n`;
            message += `📱 ایپ سے تیار شدہ رپورٹ\n`;
            message += `🕐 ${new Date().toLocaleString('ur-PK')}\n`;
            message += `═══════════════════════════\n`;
            message += `\n*شکریہ آپ کے اعتماد کا* 🙏`;

            return message;
        }

        // =================== SAMPLE DATA ===================

        function addSampleData() {
            if (customers.length > 0) {
                showConfirm('کیا آپ sample data شامل کرنا چاہتے ہیں؟ (موجودہ ڈیٹا برقرار رہے گا)', () => {
                    createSampleData();
                });
            } else {
                createSampleData();
            }
        }

        function createSampleData() {
            const sampleCustomers = [
                {
                    id: nextId++,
                    name: 'احمد علی',
                    phone: '03001234567',
                    address: 'گلی نمبر 5، محلہ شاہ پور',
                    createdAt: new Date('2025-01-01').toISOString(),
                    entries: [
                        {
                            id: Date.now() + 1,
                            type: 'delivery',
                            fromDate: '2025-01-01',
                            toDate: '2025-01-31',
                            liters: 2,
                            rate: 120,
                            note: 'صبح شام دودھ',
                            month: '2025-01',
                            createdAt: new Date('2025-01-01').toISOString()
                        },
                        {
                            id: Date.now() + 2,
                            type: 'payment',
                            date: '2025-01-15',
                            amount: 3000,
                            note: 'پہلی قسط',
                            month: '2025-01',
                            createdAt: new Date('2025-01-15').toISOString()
                        },
                        {
                            id: Date.now() + 3,
                            type: 'delivery',
                            fromDate: '2025-02-01',
                            toDate: '2025-02-28',
                            liters: 2.5,
                            rate: 125,
                            note: 'فروری کا دودھ',
                            month: '2025-02',
                            createdAt: new Date('2025-02-01').toISOString()
                        }
                    ]
                },
                {
                    id: nextId++,
                    name: 'فاطمہ خان',
                    phone: '03009876543',
                    address: 'کوٹ لکھپت، لاہور',
                    createdAt: new Date('2025-01-15').toISOString(),
                    entries: [
                        {
                            id: Date.now() + 4,
                            type: 'delivery',
                            fromDate: '2025-01-15',
                            toDate: '2025-02-14',
                            liters: 1.5,
                            rate: 115,
                            note: 'صرف صبح',
                            month: '2025-01',
                            createdAt: new Date('2025-01-15').toISOString()
                        },
                        {
                            id: Date.now() + 5,
                            type: 'payment',
                            date: '2025-02-01',
                            amount: 2500,
                            note: 'مکمل ادائیگی',
                            month: '2025-02',
                            createdAt: new Date('2025-02-01').toISOString()
                        },
                        {
                            id: Date.now() + 6,
                            type: 'day-off',
                            date: '2025-02-10',
                            reason: 'شادی کی تقریب',
                            month: '2025-02',
                            createdAt: new Date('2025-02-10').toISOString()
                        }
                    ]
                },
                {
                    id: nextId++,
                    name: 'محمد حسن',
                    phone: '03005555555',
                    address: 'مال روڈ، کینٹ',
                    createdAt: new Date('2025-02-01').toISOString(),
                    entries: [
                        {
                            id: Date.now() + 7,
                            type: 'delivery',
                            fromDate: '2025-02-01',
                            toDate: '2025-02-28',
                            liters: 3,
                            rate: 125,
                            note: 'بھینس کا دودھ',
                            month: '2025-02',
                            createdAt: new Date('2025-02-01').toISOString()
                        },
                        {
                            id: Date.now() + 8,
                            type: 'day-off',
                            date: '2025-02-15',
                            reason: 'عید کی چھٹی',
                            month: '2025-02',
                            createdAt: new Date('2025-02-15').toISOString()
                        }
                    ]
                }
            ];

            customers.push(...sampleCustomers);
            saveToStorage();
            loadCustomers();
            updateDashboard();
            
            showNotification('Sample data کامیابی سے شامل ہو گیا! اب آپ Legal Size printing اور GitHub auto-storage test کر سکتے ہیں', 'success');
        }

        async function generateLegalSizeLedger() {
            if (customers.length === 0) {
                showNotification('پہلے sample data شامل کریں', 'warning');
                return;
            }
            
            await generateCustomerLegalSize(customers[0].id);
        }

        // =================== EVENT LISTENERS ===================

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        if (!document.querySelector('.modal').style.display || document.querySelector('.modal').style.display === 'none') {
                            showAddCustomerModal();
                        }
                        break;
                    case 'p':
                        e.preventDefault();
                        if (currentCustomerId) {
                            generateCurrentCustomerLegalSize();
                        } else {
                            generateAllCustomersLegalSize();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        saveToStorage();
                        showNotification('ڈیٹا محفوظ ہو گیا!', 'success');
                        break;
                }
            }
        });

        // Auto-save every 30 seconds
        setInterval(() => {
            saveToStorage();
        }, 30000);

    </script>
</body>
</html>
