<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دودھ کا کاروبار - Complete Online Business Solution</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1em;
            opacity: 0.9;
        }

        .backup-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .backup-status.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .backup-status.syncing {
            background: rgba(255, 152, 0, 0.9);
        }

        .main-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-btn.active {
            background: rgba(255,255,255,0.9);
            border-color: white;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        .content-area {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        /* Rest of the existing styles remain the same... */
        .controls-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            direction: rtl;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .customers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .customer-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .customer-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .customer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .customer-card:hover::before {
            top: -25%;
            right: -25%;
        }

        .customer-card h3 {
            font-size: 1.6em;
            font-weight: bold;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            color: #1a1a1a;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .customer-card p {
            opacity: 0.9;
            position: relative;
            z-index: 1;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .payment-status {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .status-paid { background: #4CAF50; color: white; }
        .status-pending { background: #FF9800; color: white; }
        .status-overdue { background: #f44336; color: white; }

        .add-customer-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.3s ease;
        }

        .add-customer-btn:hover {
            transform: translateY(-5px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            direction: ltr;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.3s ease;
            margin: 5px;
        }

        .btn:hover { transform: translateY(-2px); }
        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .btn-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
        .btn-warning { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); }
        .btn-info { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-btn {
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover { color: #333; }

        .section-title {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .hidden { display: none; }

        .ledger-entries {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
        }

        .entry-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .entry-item.day-off {
            border-left-color: #ff416c;
            background: #fff5f5;
        }

        .online-features {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .pdf-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .backup-section {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .container { padding: 5px; }
            .header h1 { font-size: 1.8em; }
            .main-nav { gap: 5px; }
            .nav-btn { padding: 8px 15px; font-size: 12px; }
            .customers-grid { grid-template-columns: 1fr; }
            .controls-section { flex-direction: column; }
            .search-box { min-width: auto; }
            .customer-card { padding: 15px; }
            .customer-card h3 { font-size: 1.4em; }
            .modal-content { padding: 20px; margin: 10px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <!-- Backup Status Indicator -->
    <div id="backup-status" class="backup-status">
        🔄 آنلائن بیک اپ تیار ہے
    </div>

    <div class="container">
        <div class="header">
            <h1>🥛 دودھ کا کاروبار</h1>
            <p>مکمل آنلائن کاروباری حل - Advanced Online Business Management</p>
        </div>

        <div class="main-nav">
            <button class="nav-btn active" onclick="showDashboard()">📊 ڈیش بورڈ</button>
            <button class="nav-btn" onclick="showCustomers()">👥 گاہک</button>
            <button class="nav-btn" onclick="showReports()">📋 رپورٹس</button>
            <button class="nav-btn" onclick="showBackupManagement()">☁️ آنلائن بیک اپ</button>
            <button class="nav-btn" onclick="showDataManagement()">💾 ڈیٹا منیجمنٹ</button>
        </div>

        <div class="content-area">
            <!-- Dashboard Section -->
            <div id="dashboard-section">
                <h2 class="section-title">📊 ڈیش بورڈ - کاروبار کا خلاصہ</h2>
                
                <!-- Main Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                        <div class="stat-value" id="total-customers">0</div>
                        <div>کل گاہک</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                        <div class="stat-value" id="total-revenue">0</div>
                        <div>اس مہینے کی فروخت</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                        <div class="stat-value" id="total-received">0</div>
                        <div>اس مہینے وصول شدہ</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);">
                        <div class="stat-value" id="total-pending">0</div>
                        <div>اس مہینے باقی رقم</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div style="margin: 30px 0;">
                    <h3 style="color: #667eea; margin-bottom: 20px; text-align: center;">🚀 فوری رسائی</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        
                        <div class="customer-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); cursor: pointer;" onclick="showCustomers()">
                            <h3 style="color: white; text-shadow: none;">👥 گاہکوں کا انتظام</h3>
                            <p style="color: white; opacity: 0.9;">• نئے گاہک شامل کریں</p>
                            <p style="color: white; opacity: 0.9;">• گاہکوں کی فہرست دیکھیں</p>
                            <p style="color: white; opacity: 0.9;">• پیمنٹ کی صورتحال</p>
                        </div>

                        <div class="customer-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); cursor: pointer;" onclick="showReports()">
                            <h3 style="color: white; text-shadow: none;">📊 تفصیلی رپورٹس</h3>
                            <p style="color: white; opacity: 0.9;">• ماہانہ اور سالانہ رپورٹ</p>
                            <p style="color: white; opacity: 0.9;">• PDF ڈاؤن لوڈ</p>
                            <p style="color: white; opacity: 0.9;">• گاہک کی رپورٹ</p>
                        </div>

                        <div class="customer-card" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); cursor: pointer;" onclick="showBackupManagement()">
                            <h3 style="color: white; text-shadow: none;">☁️ آنلائن بیک اپ</h3>
                            <p style="color: white; opacity: 0.9;">• GitHub میں محفوظ کریں</p>
                            <p style="color: white; opacity: 0.9;">• خودکار بیک اپ</p>
                            <p style="color: white; opacity: 0.9;">• ڈیٹا کی بحالی</p>
                        </div>

                        <div class="customer-card" style="background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%); cursor: pointer;" onclick="showAddCustomerModal()">
                            <h3 style="color: white; text-shadow: none;">➕ نیا گاہک</h3>
                            <p style="color: white; opacity: 0.9;">• تیزی سے گاہک شامل کریں</p>
                            <p style="color: white; opacity: 0.9;">• مکمل معلومات</p>
                            <p style="color: white; opacity: 0.9;">• ڈیفالٹ ریٹ سیٹ کریں</p>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Customers Section -->
            <div id="customers-section" class="hidden">
                <div class="controls-section">
                    <input type="text" class="search-box" id="customer-search" placeholder="🔍 گاہک تلاش کریں (نام یا فون نمبر)..." onkeyup="searchCustomers()">
                    <button class="btn btn-success" onclick="showAddCustomerModal()">+ نیا گاہک</button>
                </div>
                
                <div class="customers-grid" id="customers-grid">
                    <!-- Customers will be displayed here -->
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="hidden">
                <h2 class="section-title">📊 رپورٹس اور PDF جنریشن</h2>
                
                <div class="online-features">
                    <h3 style="margin-bottom: 20px;">📄 PDF خصوصیات</h3>
                    <div class="pdf-actions">
                        <button class="btn" onclick="generateComprehensivePDF()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                            📑 مکمل ڈیٹا PDF
                        </button>
                        <button class="btn" onclick="generateMonthlyPDF()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                            📅 ماہانہ PDF
                        </button>
                        <button class="btn" onclick="generateCustomerPDF()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                            👤 گاہک کی PDF
                        </button>
                        <button class="btn" onclick="saveAllPDFsOnline()" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                            ☁️ آنلائن محفوظ کریں
                        </button>
                    </div>
                </div>

                <div style="background: #f8f9fa; border-radius: 15px; padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">فلٹر اور رپورٹ کی قسم</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>رپورٹ کی قسم:</label>
                            <select id="report-type">
                                <option value="monthly">ماہانہ رپورٹ</option>
                                <option value="yearly">سالانہ رپورٹ</option>
                                <option value="customer">گاہک رپورٹ</option>
                                <option value="comprehensive">مکمل رپورٹ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>شروعاتی تاریخ:</label>
                            <input type="date" id="report-start-date">
                        </div>
                        <div class="form-group">
                            <label>اختتامی تاریخ:</label>
                            <input type="date" id="report-end-date">
                        </div>
                        <div class="form-group">
                            <label style="opacity: 0;">Generate</label>
                            <button class="btn btn-info" onclick="generateReport()" style="width: 100%;">📊 رپورٹ بنائیں</button>
                        </div>
                    </div>
                </div>

                <div id="report-results" style="display: none; background: #f8f9fa; border-radius: 15px; padding: 20px; margin-top: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">رپورٹ کے نتائج</h3>
                    <div id="report-content">
                        <!-- Report content will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Online Backup Management Section -->
            <div id="backup-management-section" class="hidden">
                <h2 class="section-title">☁️ آنلائن بیک اپ منیجمنٹ</h2>
                
                <div class="backup-section">
                    <h3 style="color: #4CAF50; margin-bottom: 20px;">🔒 GitHub Integration</h3>
                    <div class="form-group">
                        <label>GitHub Personal Access Token:</label>
                        <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            GitHub Settings > Developer settings > Personal access tokens سے ٹوکن بنائیں
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Repository Name:</label>
                        <input type="text" id="github-repo" placeholder="milk-business-backup" value="milk-business-backup">
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="setupGitHubBackup()">🔧 GitHub سیٹ اپ</button>
                        <button class="btn btn-info" onclick="backupToGitHub()">☁️ فوری بیک اپ</button>
                        <button class="btn btn-warning" onclick="restoreFromGitHub()">⬇️ بحالی</button>
                        <button class="btn" onclick="testGitHubConnection()" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);">🔗 کنکشن ٹیسٹ</button>
                    </div>
                </div>

                <div class="backup-section">
                    <h3 style="color: #FF9800; margin-bottom: 20px;">📊 بیک اپ کی تفصیلات</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="last-backup-time">کبھی نہیں</div>
                            <div>آخری بیک اپ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="backup-size">0 KB</div>
                            <div>ڈیٹا سائز</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="backup-count">0</div>
                            <div>کل بیک اپس</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="github-status">❌</div>
                            <div>GitHub Status</div>
                        </div>
                    </div>
                </div>

                <div class="backup-section">
                    <h3 style="color: #2196F3; margin-bottom: 20px;">⚙️ خودکار بیک اپ ترتیبات</h3>
                    <div class="form-group">
                        <label>خودکار بیک اپ:</label>
                        <select id="auto-backup-frequency">
                            <option value="0">بند</option>
                            <option value="5">ہر 5 منٹ</option>
                            <option value="15">ہر 15 منٹ</option>
                            <option value="30">ہر 30 منٹ</option>
                            <option value="60">ہر گھنٹے</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="updateAutoBackupSettings()">محفوظ کریں</button>
                </div>
            </div>

            <!-- Data Management Section -->
            <div id="data-management-section" class="hidden">
                <h2 class="section-title">💾 ڈیٹا منیجمنٹ</h2>
                
                <div class="online-features">
                    <h3 style="margin-bottom: 20px;">📁 فائل منیجمنٹ</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn" onclick="exportData()" style="background: rgba(255,255,255,0.2);">
                            📤 JSON ایکسپورٹ
                        </button>
                        <label for="import-file" style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px; cursor: pointer; color: white;">
                            📥 JSON امپورٹ
                        </label>
                        <input type="file" id="import-file" style="display: none;" accept=".json" onchange="importData(event)">
                        <button class="btn" onclick="clearAllData()" style="background: rgba(255,0,0,0.3);">
                            🗑️ تمام ڈیٹا صاف کریں
                        </button>
                    </div>
                </div>

                <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-top: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">📊 ڈیٹا کی تفصیلات</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-customers-data">0</div>
                            <div>کل گاہک</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-entries-data">0</div>
                            <div>کل انٹریز</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-payments-data">0</div>
                            <div>کل پیمنٹس</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="data-size">0</div>
                            <div>ڈیٹا سائز (KB)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Ledger Section -->
            <div id="ledger-section" class="hidden">
                <button class="btn" onclick="showCustomers()">&rarr; واپس</button>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                    <h2 id="ledger-customer-name">گاہک کا نام</h2>
                    <p id="ledger-customer-phone">فون نمبر</p>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="showAddEntryModal()">+ نئی انٹری</button>
                    <button class="btn btn-danger" onclick="showDayOffModal()">چھٹی کا دن</button>
                    <button class="btn btn-warning" onclick="showPaymentModal()">💰 رقم وصول کریں</button>
                    <button class="btn btn-info" onclick="generateCustomerPDFReport()">📄 PDF رپورٹ</button>
                    <button class="btn" onclick="shareOnWhatsApp()" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);">📱 WhatsApp</button>
                </div>

                <!-- Monthly Filter -->
                <div style="margin-bottom: 20px;">
                    <label style="margin-left: 10px; font-weight: bold;">مہینہ منتخب کریں:</label>
                    <select id="month-filter" onchange="filterByMonth()" style="padding: 8px; border-radius: 5px;">
                        <option value="all">تمام انٹریز</option>
                        <option value="2025-01">جنوری 2025</option>
                        <option value="2025-02">فروری 2025</option>
                        <option value="2025-03">مارچ 2025</option>
                        <option value="2025-04">اپریل 2025</option>
                        <option value="2025-05">مئی 2025</option>
                        <option value="2025-06">جون 2025</option>
                        <option value="2025-07">جولائی 2025</option>
                        <option value="2025-08">اگست 2025</option>
                        <option value="2025-09">ستمبر 2025</option>
                        <option value="2025-10">اکتوبر 2025</option>
                        <option value="2025-11">نومبر 2025</option>
                        <option value="2025-12">دسمبر 2025</option>
                    </select>
                </div>

                <!-- Bill Summary -->
                <div id="bill-summary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="text-align: center; margin-bottom: 15px;">بل کا خلاصہ</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="summary-total-liters">0</div>
                            <div>کل لیٹر</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="summary-total-days">0</div>
                            <div>کل دن</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="summary-total-amount">0</div>
                            <div>کل رقم (روپے)</div>
                        </div>
                    </div>
                </div>

                <div class="ledger-entries" id="ledger-entries">
                    <!-- Ledger entries will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Customer Modal -->
    <div id="add-customer-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 class="section-title">نیا گاہک شامل کریں</h3>
            <form id="add-customer-form" onsubmit="return false;">
                <div class="form-group">
                    <label>گاہک کا نام: *</label>
                    <input type="text" id="customer-name" required>
                </div>
                <div class="form-group">
                    <label>فون نمبر:</label>
                    <input type="tel" id="customer-phone">
                </div>
                <div class="form-group">
                    <label>ابتدائی ریٹ (فی لیٹر):</label>
                    <input type="number" id="customer-rate" step="0.5" placeholder="مثال: 60">
                </div>
                <button type="button" class="btn btn-success" onclick="addCustomer()">شامل کریں</button>
            </form>
        </div>
    </div>

    <!-- Add Entry Modal -->
    <div id="add-entry-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 class="section-title">نئی انٹری</h3>
            <form id="add-entry-form" onsubmit="return false;">
                <div class="form-group">
                    <label>شروع کی تاریخ:</label>
                    <input type="date" id="entry-from-date" required>
                </div>
                <div class="form-group">
                    <label>اختتام کی تاریخ:</label>
                    <input type="date" id="entry-to-date" required>
                </div>
                <div class="form-group">
                    <label>روزانہ لیٹر:</label>
                    <input type="number" id="entry-liters" step="0.5" required>
                </div>
                <div class="form-group">
                    <label>فی لیٹر ریٹ:</label>
                    <input type="number" id="entry-rate" step="0.5" required>
                </div>
                <button type="button" class="btn btn-success" onclick="addEntry()">شامل کریں</button>
            </form>
        </div>
    </div>

    <!-- Day Off Modal -->
    <div id="day-off-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 class="section-title">چھٹی کا دن</h3>
            <form id="day-off-form" onsubmit="return false;">
                <div class="form-group">
                    <label>تاریخ:</label>
                    <input type="date" id="day-off-date" required>
                </div>
                <div class="form-group">
                    <label>وجہ:</label>
                    <input type="text" id="day-off-reason" placeholder="چھٹی کی وجہ">
                </div>
                <button type="button" class="btn btn-danger" onclick="addDayOff()">شامل کریں</button>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 class="section-title">💰 پیمنٹ ریکارڈ</h3>
            <form id="payment-form" onsubmit="return false;">
                <div class="form-group">
                    <label>مہینہ:</label>
                    <select id="payment-month" required>
                        <option value="">مہینہ منتخب کریں</option>
                        <option value="2025-01">جنوری 2025</option>
                        <option value="2025-02">فروری 2025</option>
                        <option value="2025-03">مارچ 2025</option>
                        <option value="2025-04">اپریل 2025</option>
                        <option value="2025-05">مئی 2025</option>
                        <option value="2025-06">جون 2025</option>
                        <option value="2025-07">جولائی 2025</option>
                        <option value="2025-08">اگست 2025</option>
                        <option value="2025-09">ستمبر 2025</option>
                        <option value="2025-10">اکتوبر 2025</option>
                        <option value="2025-11">نومبر 2025</option>
                        <option value="2025-12">دسمبر 2025</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ادا شدہ رقم:</label>
                    <input type="number" id="payment-amount" step="0.5" required>
                </div>
                <div class="form-group">
                    <label>ادائیگی کی تاریخ:</label>
                    <input type="date" id="payment-date" required>
                </div>
                <div class="form-group">
                    <label>نوٹس:</label>
                    <textarea id="payment-notes" rows="3" placeholder="اختیاری"></textarea>
                </div>
                <button type="button" class="btn btn-warning" onclick="addPayment()">💰 پیمنٹ ریکارڈ کریں</button>
            </form>
        </div>
    </div>

    <script>
        // Enhanced data storage with online backup
        let customers = [];
        let currentCustomerId = null;
        let nextId = 1;
        let gitHubSettings = {
            token: '',
            repo: 'milk-business-backup',
            username: ''
        };
        let autoBackupInterval = null;

        // Month names mapping
        const monthNames = {
            '2025-01': 'جنوری 2025', '2025-02': 'فروری 2025', '2025-03': 'مارچ 2025',
            '2025-04': 'اپریل 2025', '2025-05': 'مئی 2025', '2025-06': 'جون 2025',
            '2025-07': 'جولائی 2025', '2025-08': 'اگست 2025', '2025-09': 'ستمبر 2025',
            '2025-10': 'اکتوبر 2025', '2025-11': 'نومبر 2025', '2025-12': 'دسمبر 2025'
        };

        // =================== NOTIFICATION SYSTEM ===================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 300px;
                font-size: 14px;
                direction: rtl;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.opacity = '1', 100);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function showConfirm(message, callback) {
            const confirmDiv = document.createElement('div');
            confirmDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            confirmDiv.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; direction: rtl; text-align: center;">
                    <p style="margin-bottom: 20px; font-size: 16px;">${message}</p>
                    <div>
                        <button onclick="confirmYes()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 5px; cursor: pointer;">ہاں</button>
                        <button onclick="confirmNo()" style="background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 5px; cursor: pointer;">نہیں</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDiv);
            
            window.confirmYes = function() {
                document.body.removeChild(confirmDiv);
                delete window.confirmYes;
                delete window.confirmNo;
                callback(true);
            };
            
            window.confirmNo = function() {
                document.body.removeChild(confirmDiv);
                delete window.confirmYes;
                delete window.confirmNo;
                callback(false);
            };
        }

        // =================== DATA PERSISTENCE ===================
        function saveToStorage() {
            try {
                const data = {
                    customers: customers,
                    nextId: nextId,
                    gitHubSettings: gitHubSettings,
                    lastBackup: new Date().toISOString(),
                    version: '3.0'
                };
                
                localStorage.setItem('milkBusinessData', JSON.stringify(data));
                updateBackupStatus('محفوظ شدہ', 'success');
                console.log('✅ Data saved to localStorage');
            } catch (error) {
                console.error('❌ Error saving data:', error);
                updateBackupStatus('محفوظ کرنے میں خرابی', 'error');
            }
        }

        function loadFromStorage() {
            try {
                const data = localStorage.getItem('milkBusinessData');
                if (data) {
                    const parsed = JSON.parse(data);
                    customers = parsed.customers || [];
                    nextId = parsed.nextId || 1;
                    gitHubSettings = parsed.gitHubSettings || { token: '', repo: 'milk-business-backup', username: '' };
                    console.log('✅ Data loaded from localStorage');
                    updateBackupStatus('لوڈ مکمل', 'success');
                    return true;
                }
            } catch (error) {
                console.error('❌ Error loading data:', error);
                updateBackupStatus('لوڈ کرنے میں خرابی', 'error');
            }
            return false;
        }

        function updateBackupStatus(message, type = 'info') {
            const statusEl = document.getElementById('backup-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'backup-status';
                if (type === 'error') statusEl.classList.add('error');
                if (type === 'syncing') statusEl.classList.add('syncing');
            }
        }

        // =================== GITHUB BACKUP SYSTEM ===================
        async function setupGitHubBackup() {
            const token = document.getElementById('github-token').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            
            if (!token || !repo) {
                showNotification('براہ کرم GitHub ٹوکن اور ریپوزیٹری کا نام داخل کریں', 'error');
                return;
            }
            
            updateBackupStatus('GitHub سیٹ اپ...', 'syncing');
            
            try {
                // Test GitHub connection
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    gitHubSettings.token = token;
                    gitHubSettings.repo = repo;
                    gitHubSettings.username = userData.login;
                    
                    saveToStorage();
                    showNotification('GitHub کامیابی سے کنکٹ ہو گیا!', 'success');
                    updateBackupStatus('GitHub Ready', 'success');
                    updateGitHubStatus();
                } else {
                    throw new Error('Invalid GitHub token');
                }
            } catch (error) {
                console.error('GitHub setup error:', error);
                showNotification('GitHub کنکشن میں خرابی', 'error');
                updateBackupStatus('GitHub خرابی', 'error');
            }
        }

        async function backupToGitHub() {
            if (!gitHubSettings.token) {
                showNotification('پہلے GitHub سیٹ اپ کریں', 'error');
                return;
            }
            
            updateBackupStatus('GitHub بیک اپ...', 'syncing');
            
            try {
                const data = {
                    customers: customers,
                    nextId: nextId,
                    backupDate: new Date().toISOString(),
                    version: '3.0'
                };
                
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const fileName = `backup_${new Date().toISOString().split('T')[0]}.json`;
                
                // Create or update file in GitHub repository
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.username}/${gitHubSettings.repo}/contents/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Milk Business Backup - ${new Date().toLocaleString('ur-PK')}`,
                        content: content
                    })
                });
                
                if (response.ok) {
                    showNotification('GitHub میں بیک اپ مکمل!', 'success');
                    updateBackupStatus('بیک اپ مکمل', 'success');
                    updateBackupStats();
                } else {
                    throw new Error('GitHub backup failed');
                }
            } catch (error) {
                console.error('GitHub backup error:', error);
                showNotification('GitHub بیک اپ میں خرابی', 'error');
                updateBackupStatus('بیک اپ خرابی', 'error');
            }
        }

        async function restoreFromGitHub() {
            if (!gitHubSettings.token) {
                showNotification('پہلے GitHub سیٹ اپ کریں', 'error');
                return;
            }
            
            try {
                updateBackupStatus('GitHub سے بحالی...', 'syncing');
                
                // Get list of backup files
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.username}/${gitHubSettings.repo}/contents`, {
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`
                    }
                });
                
                if (response.ok) {
                    const files = await response.json();
                    const backupFiles = files.filter(file => file.name.startsWith('backup_') && file.name.endsWith('.json'));
                    
                    if (backupFiles.length === 0) {
                        showNotification('کوئی بیک اپ فائل نہیں ملی', 'error');
                        return;
                    }
                    
                    // Get the latest backup file
                    const latestBackup = backupFiles.sort((a, b) => b.name.localeCompare(a.name))[0];
                    
                    // Download and restore
                    const fileResponse = await fetch(latestBackup.download_url);
                    const backupData = await fileResponse.json();
                    
                    showConfirm('کیا آپ GitHub سے ڈیٹا restore کرنا چاہتے ہیں؟', function(confirmed) {
                        if (confirmed) {
                            customers = backupData.customers || [];
                            nextId = backupData.nextId || 1;
                            saveToStorage();
                            loadCustomers();
                            updateDashboard();
                            showNotification('GitHub سے ڈیٹا بحال ہو گیا!', 'success');
                            updateBackupStatus('بحالی مکمل', 'success');
                        }
                    });
                }
            } catch (error) {
                console.error('GitHub restore error:', error);
                showNotification('GitHub سے بحالی میں خرابی', 'error');
                updateBackupStatus('بحالی خرابی', 'error');
            }
        }

        async function testGitHubConnection() {
            const token = document.getElementById('github-token').value.trim();
            
            if (!token) {
                showNotification('پہلے GitHub ٹوکن داخل کریں', 'error');
                return;
            }
            
            try {
                updateBackupStatus('کنکشن ٹیسٹ...', 'syncing');
                
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    showNotification(`کنکشن کامیاب! صارف: ${userData.login}`, 'success');
                    updateBackupStatus('کنکشن OK', 'success');
                } else {
                    throw new Error('Invalid token');
                }
            } catch (error) {
                showNotification('کنکشن ناکام', 'error');
                updateBackupStatus('کنکشن خرابی', 'error');
            }
        }

        function updateGitHubStatus() {
            const statusEl = document.getElementById('github-status');
            if (statusEl) {
                statusEl.textContent = gitHubSettings.token ? '✅' : '❌';
            }
        }

        function updateBackupStats() {
            const now = new Date();
            document.getElementById('last-backup-time').textContent = now.toLocaleString('ur-PK');
            
            const dataSize = new Blob([JSON.stringify(customers)]).size;
            document.getElementById('backup-size').textContent = `${(dataSize / 1024).toFixed(2)} KB`;
        }

        // =================== AUTO BACKUP SYSTEM ===================
        function updateAutoBackupSettings() {
            const frequency = parseInt(document.getElementById('auto-backup-frequency').value);
            
            if (autoBackupInterval) {
                clearInterval(autoBackupInterval);
                autoBackupInterval = null;
            }
            
            if (frequency > 0 && gitHubSettings.token) {
                autoBackupInterval = setInterval(() => {
                    backupToGitHub();
                }, frequency * 60 * 1000);
                
                showNotification(`خودکار بیک اپ ہر ${frequency} منٹ میں شروع`, 'success');
            } else {
                showNotification('خودکار بیک اپ بند', 'info');
            }
        }

        // =================== PDF GENERATION SYSTEM ===================
        function generateComprehensivePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add Urdu support (simplified)
                doc.setFont("helvetica");
                doc.setFontSize(16);
                
                let yPosition = 20;
                
                // Title
                doc.text('Milk Business Complete Report', 20, yPosition);
                yPosition += 20;
                
                // Summary
                doc.setFontSize(12);
                doc.text(`Total Customers: ${customers.length}`, 20, yPosition);
                yPosition += 10;
                
                let totalRevenue = 0;
                let totalPayments = 0;
                
                customers.forEach(customer => {
                    if (customer.entries) {
                        customer.entries.forEach(entry => {
                            if (entry.type === 'delivery') {
                                const days = calculateDays(entry.fromDate, entry.toDate);
                                totalRevenue += days * entry.liters * entry.rate;
                            }
                        });
                    }
                    
                    if (customer.payments) {
                        customer.payments.forEach(payment => {
                            totalPayments += parseFloat(payment.amount);
                        });
                    }
                });
                
                doc.text(`Total Revenue: ${totalRevenue} PKR`, 20, yPosition);
                yPosition += 10;
                doc.text(`Total Received: ${totalPayments} PKR`, 20, yPosition);
                yPosition += 10;
                doc.text(`Total Pending: ${totalRevenue - totalPayments} PKR`, 20, yPosition);
                yPosition += 20;
                
                // Customer Details
                doc.setFontSize(14);
                doc.text('Customer Details:', 20, yPosition);
                yPosition += 15;
                
                doc.setFontSize(10);
                
                customers.forEach((customer, index) => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.text(`${index + 1}. ${customer.name}`, 20, yPosition);
                    yPosition += 7;
                    doc.text(`   Phone: ${customer.phone || 'N/A'}`, 20, yPosition);
                    yPosition += 7;
                    
                    let customerRevenue = 0;
                    let customerPayments = 0;
                    
                    if (customer.entries) {
                        customer.entries.forEach(entry => {
                            if (entry.type === 'delivery') {
                                const days = calculateDays(entry.fromDate, entry.toDate);
                                customerRevenue += days * entry.liters * entry.rate;
                            }
                        });
                    }
                    
                    if (customer.payments) {
                        customer.payments.forEach(payment => {
                            customerPayments += parseFloat(payment.amount);
                        });
                    }
                    
                    doc.text(`   Total Bill: ${customerRevenue} PKR`, 20, yPosition);
                    yPosition += 7;
                    doc.text(`   Paid: ${customerPayments} PKR`, 20, yPosition);
                    yPosition += 7;
                    doc.text(`   Remaining: ${customerRevenue - customerPayments} PKR`, 20, yPosition);
                    yPosition += 10;
                });
                
                // Download the PDF
                const fileName = `Milk_Business_Complete_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                showNotification('مکمل PDF رپورٹ ڈاؤن لوڈ مکمل!', 'success');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showNotification('PDF بنانے میں خرابی', 'error');
            }
        }

        function generateMonthlyPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const currentMonth = new Date().toISOString().slice(0, 7);
                const monthName = monthNames[currentMonth] || currentMonth;
                
                doc.setFont("helvetica");
                doc.setFontSize(16);
                
                let yPosition = 20;
                
                doc.text(`Monthly Report - ${monthName}`, 20, yPosition);
                yPosition += 20;
                
                doc.setFontSize(12);
                
                let monthlyRevenue = 0;
                let monthlyPayments = 0;
                let activeCustomers = 0;
                
                customers.forEach(customer => {
                    let customerActiveThisMonth = false;
                    
                    if (customer.entries) {
                        customer.entries.forEach(entry => {
                            if (entry.type === 'delivery') {
                                const entryMonth = (entry.date || entry.fromDate).slice(0, 7);
                                if (entryMonth === currentMonth) {
                                    customerActiveThisMonth = true;
                                    const days = calculateDays(entry.fromDate, entry.toDate);
                                    monthlyRevenue += days * entry.liters * entry.rate;
                                }
                            }
                        });
                    }
                    
                    if (customer.payments) {
                        customer.payments.forEach(payment => {
                            if (payment.month === currentMonth) {
                                monthlyPayments += parseFloat(payment.amount);
                            }
                        });
                    }
                    
                    if (customerActiveThisMonth) activeCustomers++;
                });
                
                doc.text(`Active Customers: ${activeCustomers}`, 20, yPosition);
                yPosition += 10;
                doc.text(`Monthly Revenue: ${monthlyRevenue} PKR`, 20, yPosition);
                yPosition += 10;
                doc.text(`Monthly Payments: ${monthlyPayments} PKR`, 20, yPosition);
                yPosition += 10;
                doc.text(`Monthly Pending: ${monthlyRevenue - monthlyPayments} PKR`, 20, yPosition);
                
                const fileName = `Monthly_Report_${currentMonth}.pdf`;
                doc.save(fileName);
                showNotification('ماہانہ PDF ڈاؤن لوڈ مکمل!', 'success');
                
            } catch (error) {
                console.error('Monthly PDF error:', error);
                showNotification('ماہانہ PDF میں خرابی', 'error');
            }
        }

        function generateCustomerPDF() {
            if (!currentCustomerId) {
                showNotification('پہلے گاہک منتخب کریں', 'error');
                return;
            }
            
            try {
                const customer = customers.find(c => c.id === currentCustomerId);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFont("helvetica");
                doc.setFontSize(16);
                
                let yPosition = 20;
                
                doc.text(`Customer Report: ${customer.name}`, 20, yPosition);
                yPosition += 20;
                
                doc.setFontSize(12);
                doc.text(`Phone: ${customer.phone || 'N/A'}`, 20, yPosition);
                yPosition += 15;
                
                let totalRevenue = 0;
                let totalPayments = 0;
                
                if (customer.entries) {
                    doc.text('Delivery Entries:', 20, yPosition);
                    yPosition += 10;
                    
                    customer.entries.forEach((entry, index) => {
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        if (entry.type === 'delivery') {
                            const days = calculateDays(entry.fromDate, entry.toDate);
                            const totalLiters = days * entry.liters;
                            const amount = totalLiters * entry.rate;
                            totalRevenue += amount;
                            
                            doc.setFontSize(10);
                            doc.text(`${index + 1}. ${formatDate(entry.fromDate)} to ${formatDate(entry.toDate)}`, 25, yPosition);
                            yPosition += 7;
                            doc.text(`   ${days} days x ${entry.liters} liters = ${totalLiters} total liters`, 25, yPosition);
                            yPosition += 7;
                            doc.text(`   ${totalLiters} liters x ${entry.rate} PKR = ${amount} PKR`, 25, yPosition);
                            yPosition += 10;
                        }
                    });
                }
                
                if (customer.payments) {
                    customer.payments.forEach(payment => {
                        totalPayments += parseFloat(payment.amount);
                    });
                }
                
                yPosition += 10;
                doc.setFontSize(12);
                doc.text(`Total Revenue: ${totalRevenue} PKR`, 20, yPosition);
                yPosition += 10;
                doc.text(`Total Payments: ${totalPayments} PKR`, 20, yPosition);
                yPosition += 10;
                doc.text(`Remaining: ${totalRevenue - totalPayments} PKR`, 20, yPosition);
                
                const fileName = `${customer.name}_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                showNotification('گاہک کی PDF ڈاؤن لوڈ مکمل!', 'success');
                
            } catch (error) {
                console.error('Customer PDF error:', error);
                showNotification('گاہک PDF میں خرابی', 'error');
            }
        }

        function generateCustomerPDFReport() {
            generateCustomerPDF();
        }

        async function saveAllPDFsOnline() {
            if (!gitHubSettings.token) {
                showNotification('پہلے GitHub سیٹ اپ کریں', 'error');
                return;
            }
            
            try {
                updateBackupStatus('PDFs آنلائن محفوظ...', 'syncing');
                
                // Generate comprehensive report data
                const reportData = {
                    generatedAt: new Date().toISOString(),
                    summary: {
                        totalCustomers: customers.length,
                        totalRevenue: 0,
                        totalPayments: 0
                    },
                    customers: customers.map(customer => {
                        let customerRevenue = 0;
                        let customerPayments = 0;
                        
                        if (customer.entries) {
                            customer.entries.forEach(entry => {
                                if (entry.type === 'delivery') {
                                    const days = calculateDays(entry.fromDate, entry.toDate);
                                    customerRevenue += days * entry.liters * entry.rate;
                                }
                            });
                        }
                        
                        if (customer.payments) {
                            customer.payments.forEach(payment => {
                                customerPayments += parseFloat(payment.amount);
                            });
                        }
                        
                        return {
                            name: customer.name,
                            phone: customer.phone,
                            totalRevenue: customerRevenue,
                            totalPayments: customerPayments,
                            remaining: customerRevenue - customerPayments,
                            entries: customer.entries || [],
                            payments: customer.payments || []
                        };
                    })
                };
                
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(reportData, null, 2))));
                const fileName = `pdfs/complete_report_${new Date().toISOString().split('T')[0]}.json`;
                
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.username}/${gitHubSettings.repo}/contents/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `PDF Report Data - ${new Date().toLocaleString('ur-PK')}`,
                        content: content
                    })
                });
                
                if (response.ok) {
                    showNotification('PDFs GitHub میں محفوظ!', 'success');
                    updateBackupStatus('PDFs محفوظ', 'success');
                } else {
                    throw new Error('Failed to save PDFs online');
                }
            } catch (error) {
                console.error('Save PDFs online error:', error);
                showNotification('PDFs آنلائن محفوظ کرنے میں خرابی', 'error');
                updateBackupStatus('PDFs خرابی', 'error');
            }
        }

        // =================== UTILITY FUNCTIONS ===================
        function formatDate(dateString) {
            if (!dateString) return '';
            if (dateString.includes('/')) return dateString;
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        function calculateDays(fromDate, toDate) {
            const from = new Date(fromDate);
            const to = new Date(toDate);
            
            if (isNaN(from.getTime()) || isNaN(to.getTime())) return 0;
            
            const diffTime = Math.abs(to - from);
            const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            return days;
        }

        function getMonthName(monthValue) {
            return monthNames[monthValue] || monthValue;
        }

        // =================== NAVIGATION FUNCTIONS ===================
        function showDashboard() {
            setActiveNav(0);
            showSection('dashboard-section');
            updateDashboard();
        }

        function showCustomers() {
            setActiveNav(1);
            showSection('customers-section');
            loadCustomers();
        }

        function showReports() {
            setActiveNav(2);
            showSection('reports-section');
            setupReportFilters();
        }

        function showBackupManagement() {
            setActiveNav(3);
            showSection('backup-management-section');
            updateGitHubStatus();
            updateBackupStats();
        }

        function showDataManagement() {
            setActiveNav(4);
            showSection('data-management-section');
            updateDataManagementStats();
        }

        function setActiveNav(index) {
            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        }

        function showSection(sectionId) {
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // =================== CUSTOMER MANAGEMENT ===================
        function loadCustomers() {
            displayCustomers(customers);
        }

        function displayCustomers(customerList) {
            const grid = document.getElementById('customers-grid');
            grid.innerHTML = '';

            customerList.forEach(customer => {
                const card = document.createElement('div');
                card.className = 'customer-card';
                card.onclick = () => showLedger(customer.id);
                
                const paymentStatus = getPaymentStatus(customer);
                
                card.innerHTML = `
                    <div class="payment-status ${paymentStatus.class}">${paymentStatus.text}</div>
                    <h3>${customer.name}</h3>
                    <p>📞 ${customer.phone || 'فون نمبر موجود نہیں'}</p>
                    <p>💰 کل: ${calculateCustomerTotal(customer.id)} روپے</p>
                `;
                
                grid.appendChild(card);
            });

            const addBtn = document.createElement('div');
            addBtn.className = 'add-customer-btn';
            addBtn.onclick = () => showAddCustomerModal();
            addBtn.innerHTML = '<span style="font-size: 2em;">+</span> نیا گاہک شامل کریں';
            grid.appendChild(addBtn);
        }

        function getPaymentStatus(customer) {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            let monthlyTotal = 0;
            const monthlyEntries = customer.entries?.filter(entry => {
                const entryDate = entry.date || entry.fromDate;
                return entry.type === 'delivery' && entryDate && entryDate.startsWith(currentMonth);
            }) || [];
            
            monthlyEntries.forEach(entry => {
                const days = calculateDays(entry.fromDate, entry.toDate);
                const amount = days * entry.liters * entry.rate;
                monthlyTotal += amount;
            });
            
            let paidAmount = 0;
            const payments = customer.payments?.filter(p => p.month === currentMonth) || [];
            payments.forEach(payment => {
                paidAmount += parseFloat(payment.amount);
            });
            
            if (monthlyTotal === 0) return { status: 'no-bill', text: 'کوئی بل نہیں', class: 'status-paid' };
            if (paidAmount >= monthlyTotal) return { status: 'paid', text: 'ادا شدہ', class: 'status-paid' };
            if (paidAmount > 0) return { status: 'partial', text: 'جزوی ادا', class: 'status-pending' };
            return { status: 'pending', text: 'باقی', class: 'status-overdue' };
        }

        function calculateCustomerTotal(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.entries) return 0;

            let total = 0;
            customer.entries.forEach(entry => {
                if (entry.type === 'delivery') {
                    const days = calculateDays(entry.fromDate, entry.toDate);
                    total += days * entry.liters * entry.rate;
                }
            });
            return total.toFixed(0);
        }

        function searchCustomers() {
            const searchTerm = document.getElementById('customer-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                loadCustomers();
                return;
            }

            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) ||
                (customer.phone && customer.phone.includes(searchTerm))
            );

            displayCustomers(filteredCustomers);
        }

        // =================== MODAL FUNCTIONS ===================
        function showAddCustomerModal() {
            document.getElementById('add-customer-modal').classList.add('show');
            document.getElementById('add-customer-modal').style.display = 'flex';
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
                modal.style.display = 'none';
            });
            
            document.querySelectorAll('form').forEach(form => form.reset());
        }

        // =================== CUSTOMER OPERATIONS ===================
        function addCustomer() {
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const rate = document.getElementById('customer-rate').value.trim();
            
            if (!name) {
                showNotification('براہ کرم گاہک کا نام داخل کریں', 'error');
                return;
            }
            
            const customer = {
                id: nextId++,
                name: name,
                phone: phone,
                defaultRate: rate ? parseFloat(rate) : 60,
                entries: [],
                payments: [],
                createdAt: new Date().toISOString()
            };
            
            customers.push(customer);
            saveToStorage();
            
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('customer-rate').value = '';
            
            closeModal();
            loadCustomers();
            updateDashboard();
            
            showNotification('گاہک کامیابی سے شامل ہو گیا!', 'success');
        }

        // =================== LEDGER FUNCTIONS ===================
        function showLedger(customerId) {
            currentCustomerId = customerId;
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) return;
            
            showSection('ledger-section');
            
            document.getElementById('ledger-customer-name').textContent = customer.name;
            document.getElementById('ledger-customer-phone').textContent = customer.phone || 'فون نمبر موجود نہیں';
            
            const monthFilter = document.getElementById('month-filter');
            if (monthFilter) monthFilter.value = 'all';
            
            loadLedgerEntries(customerId);
            updateBillSummary(customer.entries);
        }

        function loadLedgerEntries(customerId) {
            const customer = customers.find(c => c.id === customerId);
            const container = document.getElementById('ledger-entries');
            const selectedMonth = document.getElementById('month-filter')?.value || 'all';
            
            container.innerHTML = '';

            if (!customer.entries || customer.entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">کوئی انٹری موجود نہیں</div>';
                updateBillSummary([]);
                return;
            }

            let filteredEntries = customer.entries;
            if (selectedMonth !== 'all') {
                filteredEntries = customer.entries.filter(entry => {
                    const entryDate = entry.date || entry.fromDate;
                    return entryDate && entryDate.startsWith(selectedMonth);
                });
            }

            if (filteredEntries.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">اس مہینے کوئی انٹری موجود نہیں</div>';
                updateBillSummary([]);
                return;
            }

            filteredEntries.sort((a, b) => new Date(b.date || b.fromDate) - new Date(a.date || a.fromDate));

            filteredEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = `entry-item ${entry.type === 'day-off' ? 'day-off' : ''}`;
                
                if (entry.type === 'delivery') {
                    const days = calculateDays(entry.fromDate, entry.toDate);
                    const totalLiters = days * entry.liters;
                    const total = totalLiters * entry.rate;
                    
                    entryDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>دودھ کی فراہمی</strong>
                            <div style="background: #667eea; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                ${total} روپے
                            </div>
                        </div>
                        📅 ${formatDate(entry.fromDate)} سے ${formatDate(entry.toDate)} تک (${days} دن)<br>
                        🥛 روزانہ ${entry.liters} لیٹر × ${days} دن = <strong>${totalLiters} کل لیٹر</strong><br>
                        💰 ${totalLiters} لیٹر × ${entry.rate} روپے = <strong>${total} روپے</strong>
                    `;
                } else {
                    entryDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>چھٹی کا دن</strong>
                            <div style="background: #ff416c; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                آف ڈے
                            </div>
                        </div>
                        📅 ${formatDate(entry.date)}<br>
                        📝 ${entry.reason || 'کوئی وجہ نہیں دی گئی'}
                    `;
                }
                
                container.appendChild(entryDiv);
            });

            updateBillSummary(filteredEntries);
        }

        function updateBillSummary(entries) {
            let totalLiters = 0;
            let totalDays = 0;
            let totalAmount = 0;

            if (entries && entries.length > 0) {
                entries.forEach(entry => {
                    if (entry.type === 'delivery') {
                        const days = calculateDays(entry.fromDate, entry.toDate);
                        const liters = days * parseFloat(entry.liters || 0);
                        const amount = liters * parseFloat(entry.rate || 0);
                        
                        totalLiters += liters;
                        totalDays += days;
                        totalAmount += amount;
                    }
                });
            }

            document.getElementById('summary-total-liters').textContent = totalLiters.toFixed(1);
            document.getElementById('summary-total-days').textContent = totalDays;
            document.getElementById('summary-total-amount').textContent = totalAmount.toFixed(0);
        }

        function filterByMonth() {
            loadLedgerEntries(currentCustomerId);
        }

        // =================== ENTRY MANAGEMENT ===================
        function showAddEntryModal() {
            if (!currentCustomerId) {
                showNotification('پہلے گاہک منتخب کریں', 'error');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entry-from-date').value = today;
            document.getElementById('entry-to-date').value = today;
            
            const customer = customers.find(c => c.id === currentCustomerId);
            if (customer && customer.defaultRate) {
                document.getElementById('entry-rate').value = customer.defaultRate;
            }
            
            const modal = document.getElementById('add-entry-modal');
            modal.classList.add('show');
            modal.style.display = 'flex';
        }

        function addEntry() {
            if (!currentCustomerId) {
                showNotification('پہلے گاہک منتخب کریں', 'error');
                return;
            }
            
            const fromDate = document.getElementById('entry-from-date').value;
            const toDate = document.getElementById('entry-to-date').value;
            const liters = parseFloat(document.getElementById('entry-liters').value);
            const rate = parseFloat(document.getElementById('entry-rate').value);
            
            if (!fromDate || !toDate || !liters || !rate) {
                showNotification('براہ کرم تمام فیلڈز بھریں', 'error');
                return;
            }
            
            if (new Date(fromDate) > new Date(toDate)) {
                showNotification('اختتام کی تاریخ شروع کی تاریخ سے پہلے نہیں ہو سکتی', 'error');
                return;
            }
            
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer.entries) {
                customer.entries = [];
            }
            
            const entry = {
                id: Date.now(),
                type: 'delivery',
                fromDate: fromDate,
                toDate: toDate,
                liters: liters,
                rate: rate,
                date: fromDate,
                createdAt: new Date().toISOString()
            };
            
            customer.entries.push(entry);
            saveToStorage();
            
            document.getElementById('entry-from-date').value = '';
            document.getElementById('entry-to-date').value = '';
            document.getElementById('entry-liters').value = '';
            document.getElementById('entry-rate').value = '';
            
            closeModal();
            loadLedgerEntries(currentCustomerId);
            loadCustomers();
            updateDashboard();
            
            showNotification('انٹری کامیابی سے شامل ہو گئی!', 'success');
        }

        function showDayOffModal() {
            const modal = document.getElementById('day-off-modal');
            if (modal) {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('day-off-date').value = today;
                modal.classList.add('show');
                modal.style.display = 'flex';
            }
        }

        function addDayOff() {
            const date = document.getElementById('day-off-date').value;
            const reason = document.getElementById('day-off-reason').value;
            
            if (!date) {
                showNotification('براہ کرم تاریخ منتخب کریں', 'error');
                return;
            }
            
            const customer = customers.find(c => c.id === currentCustomerId);
            const entry = {
                id: Date.now(),
                type: 'day-off',
                date: date,
                reason: reason || 'کوئی وجہ نہیں دی گئی',
                createdAt: new Date().toISOString()
            };
            
            customer.entries.push(entry);
            saveToStorage();
            
            document.getElementById('day-off-date').value = '';
            document.getElementById('day-off-reason').value = '';
            
            closeModal();
            loadLedgerEntries(currentCustomerId);
            showNotification('چھٹی کا دن شامل ہو گیا!', 'success');
        }

        // =================== PAYMENT MANAGEMENT ===================
        function showPaymentModal() {
            const modal = document.getElementById('payment-modal');
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            
            modal.classList.add('show');
            modal.style.display = 'flex';
        }

        function addPayment() {
            const month = document.getElementById('payment-month').value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;
            const notes = document.getElementById('payment-notes').value;
            
            if (!month || !amount || !date) {
                showNotification('براہ کرم تمام ضروری فیلڈز بھریں', 'error');
                return;
            }
            
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer.payments) {
                customer.payments = [];
            }
            
            const payment = {
                id: Date.now(),
                month: month,
                amount: amount,
                date: date,
                notes: notes,
                timestamp: new Date().toISOString()
            };
            
            customer.payments.push(payment);
            saveToStorage();
            
            document.getElementById('payment-month').value = '';
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-date').value = '';
            document.getElementById('payment-notes').value = '';
            
            closeModal();
            loadCustomers();
            updateDashboard();
            
            showNotification(`پیمنٹ کامیابی سے ریکارڈ ہو گئی! ${amount} روپے - ${getMonthName(month)}`, 'success');
        }

        // =================== REPORTS ===================
        function setupReportFilters() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('report-start-date').value = firstDay.toISOString().split('T')[0];
            document.getElementById('report-end-date').value = lastDay.toISOString().split('T')[0];
        }

        function generateReport() {
            const reportType = document.getElementById('report-type').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;

            if (!startDate || !endDate) {
                showNotification('براہ کرم شروعاتی اور اختتامی تاریخ منتخب کریں', 'error');
                return;
            }

            let reportContent = generateBasicReport(startDate, endDate, reportType);
            
            document.getElementById('report-content').innerHTML = reportContent;
            document.getElementById('report-results').style.display = 'block';
        }

        function generateBasicReport(startDate, endDate, reportType) {
            let totalRevenue = 0;
            let totalPayments = 0;
            let activeCustomers = 0;

            customers.forEach(customer => {
                let customerActive = false;
                
                customer.entries?.forEach(entry => {
                    if (entry.type === 'delivery') {
                        const entryDate = entry.date || entry.fromDate;
                        if (entryDate >= startDate && entryDate <= endDate) {
                            customerActive = true;
                            const days = calculateDays(entry.fromDate, entry.toDate);
                            const amount = days * entry.liters * entry.rate;
                            totalRevenue += amount;
                        }
                    }
                });

                customer.payments?.forEach(payment => {
                    if (payment.date >= startDate && payment.date <= endDate) {
                        totalPayments += parseFloat(payment.amount);
                    }
                });

                if (customerActive) activeCustomers++;
            });

            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${customers.length}</div>
                        <div>کل گاہک</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${activeCustomers}</div>
                        <div>فعال گاہک</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalRevenue.toFixed(0)}</div>
                        <div>کل فروخت</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalPayments.toFixed(0)}</div>
                        <div>کل وصولی</div>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 20px; color: #667eea; font-size: 16px;">
                    ${reportType === 'comprehensive' ? 'مکمل' : reportType === 'monthly' ? 'ماہانہ' : 'تفصیلی'} رپورٹ: ${startDate} سے ${endDate} تک
                </p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-info" onclick="generateComprehensivePDF()" style="margin: 5px;">📄 PDF ڈاؤن لوڈ</button>
                    <button class="btn btn-success" onclick="saveAllPDFsOnline()" style="margin: 5px;">☁️ آنلائن محفوظ</button>
                </div>
            `;
        }

        // =================== DATA MANAGEMENT ===================
        function exportData() {
            try {
                const data = {
                    customers: customers,
                    nextId: nextId,
                    gitHubSettings: gitHubSettings,
                    exportDate: new Date().toISOString(),
                    version: '3.0'
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `milk_business_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('✅ ڈیٹا کامیابی سے ایکسپورٹ ہو گیا!', 'success');
            } catch (error) {
                console.error('❌ Export error:', error);
                showNotification('ایکسپورٹ میں خرابی: ' + error.message, 'error');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    showConfirm('کیا آپ واقعی موجودہ ڈیٹا کو تبدیل کرنا چاہتے ہیں؟ یہ عمل واپس نہیں ہو سکتا۔', function(confirmed) {
                        if (confirmed) {
                            customers = data.customers || [];
                            nextId = data.nextId || 1;
                            gitHubSettings = data.gitHubSettings || { token: '', repo: 'milk-business-backup', username: '' };
                            
                            saveToStorage();
                            loadCustomers();
                            updateDashboard();
                            updateDataManagementStats();
                            
                            showNotification('✅ ڈیٹا کامیابی سے امپورٹ ہو گیا!', 'success');
                        }
                    });
                } catch (error) {
                    console.error('❌ Import error:', error);
                    showNotification('امپورٹ میں خرابی: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            showConfirm('کیا آپ واقعی تمام ڈیٹا صاف کرنا چاہتے ہیں؟ یہ عمل واپس نہیں ہو سکتا۔', function(firstConfirm) {
                if (firstConfirm) {
                    showConfirm('آخری بار تصدیق: تمام گاہک، انٹریز اور پیمنٹس ڈیلیٹ ہو جائیں گے!', function(secondConfirm) {
                        if (secondConfirm) {
                            customers = [];
                            nextId = 1;
                            gitHubSettings = { token: '', repo: 'milk-business-backup', username: '' };
                            
                            localStorage.removeItem('milkBusinessData');
                            
                            loadCustomers();
                            updateDashboard();
                            updateDataManagementStats();
                            
                            showNotification('✅ تمام ڈیٹا صاف ہو گیا!', 'success');
                        }
                    });
                }
            });
        }

        function updateDataManagementStats() {
            const totalCustomers = customers.length;
            let totalEntries = 0;
            let totalPayments = 0;

            customers.forEach(customer => {
                totalEntries += customer.entries?.length || 0;
                totalPayments += customer.payments?.length || 0;
            });

            const dataSize = new Blob([JSON.stringify({ customers, nextId, gitHubSettings })]).size;
            const dataSizeKB = (dataSize / 1024).toFixed(2);

            document.getElementById('total-customers-data').textContent = totalCustomers;
            document.getElementById('total-entries-data').textContent = totalEntries;
            document.getElementById('total-payments-data').textContent = totalPayments;
            document.getElementById('data-size').textContent = dataSizeKB;
        }

        // =================== DASHBOARD FUNCTIONS ===================
        function updateDashboard() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const totalCustomers = customers.length;
            let monthlyRevenue = 0;
            let monthlyReceived = 0;
            let activeCustomersThisMonth = 0;

            customers.forEach(customer => {
                let customerActiveThisMonth = false;
                
                if (customer.entries) {
                    customer.entries.forEach(entry => {
                        if (entry.type === 'delivery') {
                            const entryMonth = (entry.date || entry.fromDate).slice(0, 7);
                            if (entryMonth === currentMonth) {
                                customerActiveThisMonth = true;
                                const days = calculateDays(entry.fromDate, entry.toDate);
                                monthlyRevenue += days * entry.liters * entry.rate;
                            }
                        }
                    });
                }
                
                if (customer.payments) {
                    customer.payments.forEach(payment => {
                        if (payment.month === currentMonth) {
                            monthlyReceived += parseFloat(payment.amount);
                        }
                    });
                }

                if (customerActiveThisMonth) activeCustomersThisMonth++;
            });

            const monthlyPending = monthlyRevenue - monthlyReceived;

            document.getElementById('total-customers').textContent = totalCustomers;
            document.getElementById('total-revenue').textContent = monthlyRevenue.toFixed(0);
            document.getElementById('total-received').textContent = monthlyReceived.toFixed(0);
            document.getElementById('total-pending').textContent = monthlyPending.toFixed(0);
        }

        // =================== WHATSAPP SHARING ===================
        function shareOnWhatsApp() {
            const customer = customers.find(c => c.id === currentCustomerId);
            const selectedMonth = document.getElementById('month-filter').value;
            const monthName = getMonthName(selectedMonth);
            
            let message = `*${customer.name} کا دودھ کا بل*\n${monthName}\n\n`;
            
            let filteredEntries = customer.entries;
            if (selectedMonth !== 'all') {
                filteredEntries = customer.entries.filter(entry => {
                    const entryDate = entry.date || entry.fromDate;
                    return entryDate && entryDate.startsWith(selectedMonth);
                });
            }
            
            let totalLiters = 0;
            let totalAmount = 0;
            let entryNumber = 1;
            
            filteredEntries.sort((a, b) => new Date(a.date || a.fromDate) - new Date(b.date || b.fromDate));
            
            filteredEntries.forEach(entry => {
                if (entry.type === 'delivery') {
                    const days = calculateDays(entry.fromDate, entry.toDate);
                    const liters = days * entry.liters;
                    const amount = liters * entry.rate;
                    
                    const fromDateFormatted = formatDate(entry.fromDate);
                    const toDateFormatted = formatDate(entry.toDate);
                    
                    message += `${entryNumber}. ${fromDateFormatted} سے ${toDateFormatted}\n`;
                    message += `📦 ${days} دن × ${entry.liters} لیٹر = *${liters} کل لیٹر*\n`;
                    message += `💰 ${liters} لیٹر × ${entry.rate} روپے = *${amount} روپے*\n\n`;
                    
                    totalLiters += liters;
                    totalAmount += amount;
                    entryNumber++;
                }
            });
            
            message += `━━━━━━━━━━━━━━━━━━━━\n`;
            message += `🥛 *کل لیٹر:* ${totalLiters.toFixed(1)}\n`;
            message += `💵 *کل رقم:* ${totalAmount.toFixed(0)} روپے\n`;
            message += `━━━━━━━━━━━━━━━━━━━━\n`;
            message += `📞 فون: ${customer.phone || 'نہیں دیا گیا'}\n`;
            message += `\n*دودھ کا کاروبار*\nشکریہ! 🙏`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
            showNotification('WhatsApp پر شیئر کے لیے تیار!', 'success');
        }

        // =================== INITIALIZATION ===================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Enhanced Milk Business App initializing...');
            
            // Load data from storage
            loadFromStorage();
            
            // Initialize dashboard as default view
            setActiveNav(0);
            showSection('dashboard-section');
            
            // Initialize all sections
            loadCustomers();
            updateDashboard();
            updateDataManagementStats();
            
            // Set GitHub settings in UI
            if (gitHubSettings.token) {
                document.getElementById('github-token').value = gitHubSettings.token;
            }
            if (gitHubSettings.repo) {
                document.getElementById('github-repo').value = gitHubSettings.repo;
            }
            
            // Set today's date as default for payment
            const today = new Date().toISOString().split('T')[0];
            const paymentDateInput = document.getElementById('payment-date');
            if (paymentDateInput) {
                paymentDateInput.value = today;
            }
            
            // Update status
            updateBackupStatus('App Ready', 'success');
            updateGitHubStatus();
            
            console.log('✅ Enhanced Milk Business App initialized successfully!');
            console.log(`📊 Loaded ${customers.length} customers from storage`);
            showNotification('🚀 Enhanced Milk Business App آمادہ!', 'success');
        });

        // Auto-save every 30 seconds
        setInterval(() => {
            if (customers.length > 0) {
                saveToStorage();
                console.log('💾 Auto-saved data');
            }
        }, 30000);

        // Auto-backup every 5 minutes if GitHub is configured
        setInterval(() => {
            if (gitHubSettings.token && customers.length > 0) {
                backupToGitHub();
            }
        }, 300000); // 5 minutes

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal();
            }
        });

        // Handle beforeunload to save data
        window.addEventListener('beforeunload', function() {
            saveToStorage();
        });

    </script>
</body>
</html>