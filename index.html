<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ú©Ø§Ø±ÙˆØ¨Ø§Ø± - Fixed Version</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans Arabic', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            overflow-x: auto;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            overflow-x: auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .backup-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .backup-status.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .backup-status.syncing {
            background: rgba(255, 152, 0, 0.9);
        }

        .main-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            overflow-x: auto;
            min-width: 800px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-btn.active {
            background: rgba(255,255,255,0.9);
            border-color: white;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        .content-area {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            min-height: 500px;
            overflow-x: auto;
        }

        .customers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .customer-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            transition: transform 0.3s ease;
            position: relative;
        }

        .customer-card:hover {
            transform: translateY(-5px);
        }

        .add-customer-card {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: white;
            text-align: center;
            cursor: pointer;
        }

        .controls-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn.success { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
        .btn.warning { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); }
        .btn.info { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); }
        .btn.danger { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .section-title {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .hidden {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-btn {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .ledger-entries {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .entry-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-right: 4px solid #667eea;
            position: relative;
        }

        .entry-item.delivery {
            border-right-color: #4CAF50;
            background: #f1f8e9;
        }

        .entry-item.payment {
            border-right-color: #2196F3;
            background: #e3f2fd;
        }

        .entry-item.day-off {
            border-right-color: #ff416c;
            background: #fff5f5;
        }

        .entry-actions {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
        }

        .entry-action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
            color: white;
            font-weight: bold;
        }

        .edit-btn {
            background: #2196F3;
        }

        .edit-btn:hover {
            background: #1976D2;
            transform: scale(1.1);
        }

        .delete-btn {
            background: #f44336;
        }

        .delete-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .entry-content {
            margin-left: 90px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-right: 4px solid;
        }

        .alert-info {
            background: #e3f2fd;
            border-color: #2196F3;
            color: #1976D2;
        }

        .alert-success {
            background: #e8f5e8;
            border-color: #4CAF50;
            color: #2e7d32;
        }

        .github-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .github-form {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }

        .github-input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        .github-btn {
            background: linear-gradient(135deg, #24292e 0%, #586069 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .github-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Legal Size Print Styles - 8.5" x 14" (215.9mm x 355.6mm) */
        @media print {
            @page {
                size: legal;
                margin: 0.5in;
            }
            
            body {
                background: white !important;
                color: black !important;
                font-size: 11px;
                line-height: 1.3;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-header {
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 15px;
                text-align: center;
            }
            
            .print-header h1 {
                font-size: 18px;
                margin-bottom: 5px;
            }
            
            .print-header h2 {
                font-size: 14px;
                margin-bottom: 5px;
            }
            
            .print-customer-info {
                background: #f5f5f5;
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 15px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .print-summary {
                background: #e8f4f8;
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 15px;
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                text-align: center;
            }
            
            .print-entries-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 10px;
            }
            
            .print-entries-table th,
            .print-entries-table td {
                border: 1px solid #ccc;
                padding: 5px;
                text-align: right;
            }
            
            .print-entries-table th {
                background: #f0f0f0;
                font-weight: bold;
            }
            
            .print-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 30px;
                background: #f0f0f0;
                border-top: 1px solid #ccc;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .customers-grid {
                grid-template-columns: 1fr;
            }
            
            .main-nav {
                gap: 5px;
                min-width: 100%;
                overflow-x: auto;
            }
            
            .nav-btn {
                min-width: 100px;
                padding: 10px 15px;
                font-size: 12px;
            }

            .entry-content {
                margin-left: 70px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="backup-status" id="backup-status">
        âœ… Ø³Ø³Ù¹Ù… ØªÛŒØ§Ø±
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ¥› Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ú©Ø§Ø±ÙˆØ¨Ø§Ø±</h1>
            <p>Fixed Version - Entry ID & GitHub Auto-storage</p>
        </div>

        <nav class="main-nav">
            <button class="nav-btn active" onclick="showDashboard()">
                ğŸ“ˆ ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ
            </button>
            <button class="nav-btn" onclick="showCustomers()">
                ğŸ‘¥ Ú¯Ø§ÛÚ©
            </button>
            <button class="nav-btn" onclick="showLedger()">
                ğŸ“ Ú©Ú¾Ø§ØªÛ
            </button>
            <button class="nav-btn" onclick="showReports()">
                ğŸ–¨ï¸ Ù¾Ø±Ù†Ù¹ Ø±Ù¾ÙˆØ±Ù¹Ø³
            </button>
            <button class="nav-btn" onclick="showBackup()">
                â˜ï¸ Ø¨ÛŒÚ© Ø§Ù¾
            </button>
        </nav>

        <div class="content-area">
            <!-- Dashboard Section -->
            <div id="dashboard-section">
                <h2 class="section-title">ğŸ“ˆ Ú©Ø§Ø±ÙˆØ¨Ø§Ø±ÛŒ ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="total-customers-stat">0</h3>
                        <p>Ú©Ù„ Ú¯Ø§ÛÚ©</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="total-revenue-stat">0</h3>
                        <p>Ú©Ù„ Ø¢Ù…Ø¯Ù†ÛŒ (Ø±ÙˆÙ¾Û’)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="total-payments-stat">0</h3>
                        <p>ÙˆØµÙˆÙ„ Ø´Ø¯Û (Ø±ÙˆÙ¾Û’)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="pending-amount-stat">0</h3>
                        <p>Ø¨Ø§Ù‚ÛŒ Ø±Ù‚Ù… (Ø±ÙˆÙ¾Û’)</p>
                    </div>
                </div>

                <div class="alert alert-success">
                    <h3>ğŸ”§ Fixed Issues in this Version:</h3>
                    <ul style="margin: 10px 0; padding-right: 20px;">
                        <li><strong>âœ… Entry ID Fix:</strong> Smart entry detection works with all versions</li>
                        <li><strong>âœ… Month Filtering:</strong> Improved date analysis and filtering</li>
                        <li><strong>âœ… Auto GitHub Storage:</strong> HTML reports automatically saved to GitHub</li>
                        <li><strong>âœ… Data Migration:</strong> Previous entries automatically updated</li>
                        <li><strong>âœ… Beautiful WhatsApp:</strong> Enhanced Urdu formatting for ledgers</li>
                        <li><strong>âœ… Network Error Handling:</strong> Better GitHub connectivity</li>
                    </ul>
                    <div style="margin-top: 15px;">
                        <button class="btn success" onclick="fixExistingEntries()" title="Manually fix any entry issues">ğŸ”§ Fix Previous Entries</button>
                        <button class="btn warning" onclick="addSampleData()">ğŸ“ Sample Data Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
                        <button class="btn info" onclick="generateLegalSizeLedger()">ğŸ–¨ï¸ Legal Size Test</button>
                    </div>
                </div>

                <div class="alert alert-info">
                    <h3>ğŸ©º Troubleshooting Guide:</h3>
                    <details style="margin: 10px 0;">
                        <summary style="cursor: pointer; font-weight: bold;">â“ Previous entries not showing?</summary>
                        <ul style="margin: 10px 0; padding-right: 20px;">
                            <li>Click "ğŸ”§ Fix Previous Entries" button above</li>
                            <li>Check browser console (F12) for detailed logs</li>
                            <li>Try refreshing the page</li>
                            <li>Use "ğŸ” Debug Data" button to inspect data</li>
                        </ul>
                    </details>
                    <details style="margin: 10px 0;">
                        <summary style="cursor: pointer; font-weight: bold;">ğŸŒ GitHub connection issues?</summary>
                        <ul style="margin: 10px 0; padding-right: 20px;">
                            <li>Check your internet connection</li>
                            <li>Try "ğŸ”— Ú©Ù†Ú©Ø´Ù† Ù¹ÛŒØ³Ù¹" in Backup section</li>
                            <li>Reports still save locally even if GitHub fails</li>
                            <li>CORS errors are normal - reports still download</li>
                        </ul>
                    </details>
                    <details style="margin: 10px 0;">
                        <summary style="cursor: pointer; font-weight: bold;">ğŸ“± WhatsApp formatting issues?</summary>
                        <ul style="margin: 10px 0; padding-right: 20px;">
                            <li>WhatsApp should show beautiful Urdu formatting</li>
                            <li>Numbers are formatted in Urdu locale</li>
                            <li>Emojis and symbols make it more readable</li>
                            <li>Try sending to yourself first to test</li>
                        </ul>
                    </details>
                </div>
            </div>

            <!-- Customers Section -->
            <div id="customers-section" class="hidden">
                <div class="controls-section">
                    <input type="text" class="search-box" id="customer-search" placeholder="Ú¯Ø§ÛÚ© ØªÙ„Ø§Ø´ Ú©Ø±ÛŒÚº..." onkeyup="searchCustomers()">
                    <button class="btn success" onclick="showAddCustomerModal()">â• Ù†ÛŒØ§ Ú¯Ø§ÛÚ© Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
                    <button class="btn info" onclick="generateAllCustomersLegalSize()">ğŸ–¨ï¸ ØªÙ…Ø§Ù… Ú¯Ø§ÛÚ©ÙˆÚº Ú©ÛŒ Ù¾Ø±Ù†Ù¹ ÙØ§Ø¦Ù„</button>
                </div>
                <div class="customers-grid" id="customers-grid">
                    <!-- Customers will be loaded here -->
                </div>
            </div>

            <!-- Ledger Section -->
            <div id="ledger-section" class="hidden">
                <div class="controls-section">
                    <h2 id="ledger-title">Ú¯Ø§ÛÚ© Ú©Ø§ Ú©Ú¾Ø§ØªÛ</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn success" onclick="showAddDeliveryModal()">ğŸ¥› Ø¯ÙˆØ¯Ú¾ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
                        <button class="btn info" onclick="showAddPaymentModal()">ğŸ’° Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
                        <button class="btn warning" onclick="showAddDayOffModal()">ğŸš« Ú†Ú¾Ù¹ÛŒ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
                        <button class="btn" onclick="generateCurrentCustomerLegalSize()" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">ğŸ–¨ï¸ Legal Size Print</button>
                        <button class="btn" onclick="sendCurrentCustomerWhatsApp()" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);">ğŸ“± WhatsApp Ø¨Ú¾ÛŒØ¬ÛŒÚº</button>
                        <button class="btn" onclick="showCustomers()">â¬…ï¸ ÙˆØ§Ù¾Ø³</button>
                    </div>
                </div>

                <!-- Month Selection -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ“… Ù…ÛÛŒÙ†Û Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº</h3>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <select id="month-filter" onchange="filterByMonth()" style="padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px; min-width: 200px;">
                            <option value="all">ØªÙ…Ø§Ù… Ø§Ù†Ù¹Ø±ÛŒØ²</option>
                            <option value="2024-01">Ø¬Ù†ÙˆØ±ÛŒ 2024</option>
                            <option value="2024-02">ÙØ±ÙˆØ±ÛŒ 2024</option>
                            <option value="2024-03">Ù…Ø§Ø±Ú† 2024</option>
                            <option value="2024-04">Ø§Ù¾Ø±ÛŒÙ„ 2024</option>
                            <option value="2024-05">Ù…Ø¦ÛŒ 2024</option>
                            <option value="2024-06">Ø¬ÙˆÙ† 2024</option>
                            <option value="2024-07">Ø¬ÙˆÙ„Ø§Ø¦ÛŒ 2024</option>
                            <option value="2024-08">Ø§Ú¯Ø³Øª 2024</option>
                            <option value="2024-09">Ø³ØªÙ…Ø¨Ø± 2024</option>
                            <option value="2024-10">Ø§Ú©ØªÙˆØ¨Ø± 2024</option>
                            <option value="2024-11">Ù†ÙˆÙ…Ø¨Ø± 2024</option>
                            <option value="2024-12">Ø¯Ø³Ù…Ø¨Ø± 2024</option>
                            <option value="2025-01">Ø¬Ù†ÙˆØ±ÛŒ 2025</option>
                            <option value="2025-02">ÙØ±ÙˆØ±ÛŒ 2025</option>
                            <option value="2025-03">Ù…Ø§Ø±Ú† 2025</option>
                            <option value="2025-04">Ø§Ù¾Ø±ÛŒÙ„ 2025</option>
                            <option value="2025-05">Ù…Ø¦ÛŒ 2025</option>
                            <option value="2025-06">Ø¬ÙˆÙ† 2025</option>
                            <option value="2025-07">Ø¬ÙˆÙ„Ø§Ø¦ÛŒ 2025</option>
                            <option value="2025-08">Ø§Ú¯Ø³Øª 2025</option>
                            <option value="2025-09">Ø³ØªÙ…Ø¨Ø± 2025</option>
                            <option value="2025-10">Ø§Ú©ØªÙˆØ¨Ø± 2025</option>
                            <option value="2025-11">Ù†ÙˆÙ…Ø¨Ø± 2025</option>
                            <option value="2025-12">Ø¯Ø³Ù…Ø¨Ø± 2025</option>
                        </select>
                        <button class="btn info" onclick="setCurrentMonth()" style="padding: 10px 15px;">ğŸ“… Ù…ÙˆØ¬ÙˆØ¯Û Ù…ÛÛŒÙ†Û</button>
                        <button class="btn" onclick="setPreviousMonth()" style="padding: 10px 15px;">â¬…ï¸ Ù¾Ú†Ú¾Ù„Ø§ Ù…ÛÛŒÙ†Û</button>
                    </div>
                </div>
                
                <div id="ledger-entries" class="ledger-entries">
                    <!-- Entries will be loaded here -->
                </div>

                <div id="bill-summary" style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <!-- Bill summary will be shown here -->
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="hidden">
                <h2 class="section-title">ğŸ–¨ï¸ Legal Size Print Reports</h2>
                
                <div class="alert alert-info">
                    <h3>ğŸ“„ Available Legal Size Reports (8.5" x 14")</h3>
                    <p>All reports optimized for legal size paper with perfect Urdu fonts.</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; border: 2px solid #4CAF50;">
                        <h3 style="color: #4CAF50;">ğŸ‘¥ ØªÙ…Ø§Ù… Ú¯Ø§ÛÚ©ÙˆÚº Ú©ÛŒ Ø±Ù¾ÙˆØ±Ù¹</h3>
                        <p>Complete business overview with all customers</p>
                        <button class="btn success" onclick="generateAllCustomersLegalSize()" style="margin-top: 15px;">ğŸ–¨ï¸ Generate Report</button>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; border: 2px solid #2196F3;">
                        <h3 style="color: #2196F3;">ğŸ“‹ Individual Customer Reports</h3>
                        <p>Legal size customer ledgers</p>
                        <button class="btn info" onclick="showCustomers()" style="margin-top: 15px;">ğŸ‘¥ Select Customer</button>
                    </div>
                    
                    <div style="background: #fff3e0; padding: 20px; border-radius: 10px; border: 2px solid #ff9800;">
                        <h3 style="color: #ff9800;">ğŸ“Š Business Summary</h3>
                        <p>Monthly and yearly business analysis</p>
                        <button class="btn warning" onclick="generateBusinessSummaryLegalSize()" style="margin-top: 15px;">ğŸ“Š Generate Summary</button>
                    </div>
                </div>
            </div>

            <!-- Backup Section -->
            <div id="backup-section" class="hidden">
                <h2 class="section-title">â˜ï¸ Ø¨ÛŒÚ© Ø§Ù¾ Ø§ÙˆØ± Ø¨Ø­Ø§Ù„ÛŒ</h2>
                
                <!-- GitHub Integration -->
                <div class="github-section">
                    <h3 style="color: #24292e; margin-bottom: 15px;">ğŸ”§ GitHub Integration Setup</h3>
                    <p>Ø¢Ù¾ Ú©Ø§ ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ Ø±Ú©Ú¾Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ GitHub Ø³Û’ Ú©Ù†Ú©Ù¹ Ú©Ø±ÛŒÚº</p>
                    
                    <div class="alert alert-info" style="margin: 15px 0;">
                        <h4>ğŸ‰ GitHub Ready to Use!</h4>
                        <p style="margin: 10px 0;"><strong>âœ… Token:</strong> Pre-configured and ready</p>
                        <p style="margin: 10px 0;"><strong>âœ… Repository:</strong> abdul8659/milk-business-app</p>
                        <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #28a745;">
                            <strong>ğŸš€ Auto HTML Storage:</strong> All reports automatically saved to GitHub!
                        </div>
                    </div>
                    
                    <div class="github-form">
                        <input type="password" id="github-token" class="github-input" 
                               placeholder="GitHub Personal Access Token (ghp_...)" 
                               value="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">
                        <input type="text" id="github-repo" class="github-input" 
                               placeholder="Repository Name (username/repo-name)" 
                               value="abdul8659/milk-business-app">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <button type="button" class="github-btn" onclick="setupGitHubBackup()">
                                ğŸ”§ GitHub Ú©Ù†Ú©Ù¹ Ú©Ø±ÛŒÚº
                            </button>
                            <button type="button" class="github-btn" onclick="manualBackup()">
                                â˜ï¸ ÙÙˆØ±ÛŒ Ø¨ÛŒÚ© Ø§Ù¾
                            </button>
                            <button type="button" class="github-btn" onclick="restoreFromGitHub()">
                                â¬‡ï¸ GitHub Ø³Û’ Ø¨Ø­Ø§Ù„ÛŒ
                            </button>
                            <button type="button" class="github-btn" onclick="testGitHubConnection()">
                                ğŸ”— Ú©Ù†Ú©Ø´Ù† Ù¹ÛŒØ³Ù¹
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Auto Backup Settings -->
                <div class="github-section">
                    <h3 style="color: #2196F3; margin-bottom: 15px;">â° Ø¢Ù¹Ùˆ Ø¨ÛŒÚ© Ø§Ù¾ Ø³ÛŒÙ¹Ù†Ú¯Ø²</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: end;">
                        <div>
                            <label>Ø¨ÛŒÚ© Ø§Ù¾ Ú©Ø§ ÙˆÙ‚ÙÛ:</label>
                            <select id="backup-interval" onchange="updateBackupInterval()" class="github-input">
                                <option value="0">Ø¨Ù†Ø¯</option>
                                <option value="5" selected>5 Ù…Ù†Ù¹</option>
                                <option value="10">10 Ù…Ù†Ù¹</option>
                                <option value="30">30 Ù…Ù†Ù¹</option>
                                <option value="60">1 Ú¯Ú¾Ù†Ù¹Û</option>
                            </select>
                        </div>
                        <div>
                            <label>Ø¢Ù¹Ùˆ Ø¨ÛŒÚ© Ø§Ù¾:</label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="auto-backup-enabled" checked onchange="toggleAutoBackup()">
                                <span>ÙØ¹Ø§Ù„ Ú©Ø±ÛŒÚº</span>
                            </label>
                        </div>
                        <div>
                            <button type="button" class="btn info" onclick="downloadLocalBackup()" style="width: 100%;">
                                ğŸ’¾ Local Backup
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Backup Status -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="last-backup-time">Ú©Ø¨Ú¾ÛŒ Ù†ÛÛŒÚº</h3>
                        <p>Ø¢Ø®Ø±ÛŒ Ø¨ÛŒÚ© Ø§Ù¾</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="backup-size">0 KB</h3>
                        <p>ÚˆÛŒÙ¹Ø§ Ø³Ø§Ø¦Ø²</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="github-status">âŒ</h3>
                        <p>GitHub Status</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="backup-count">0</h3>
                        <p>Ú©Ù„ Ø¨ÛŒÚ© Ø§Ù¾Ø³</p>
                    </div>
                </div>

                <!-- Manual Restore -->
                <div class="github-section">
                    <h3 style="color: #ff9800; margin-bottom: 15px;">ğŸ“‚ Manual Restore</h3>
                    <p>Local backup file Ø³Û’ data restore Ú©Ø±ÛŒÚº</p>
                    <div style="display: flex; gap: 15px; align-items: end; margin-top: 15px;">
                        <input type="file" id="restore-file" accept=".json" class="github-input" style="flex: 1;">
                        <button type="button" class="btn warning" onclick="restoreFromFile()">
                            ğŸ“‚ File Ø³Û’ Restore
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Customer Modal -->
    <div id="add-customer-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Ù†ÛŒØ§ Ú¯Ø§ÛÚ© Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</h3>
            <div class="form-group">
                <label>Ù†Ø§Ù…:</label>
                <input type="text" id="customer-name" placeholder="Ú¯Ø§ÛÚ© Ú©Ø§ Ù†Ø§Ù…">
            </div>
            <div class="form-group">
                <label>ÙÙˆÙ† Ù†Ù…Ø¨Ø±:</label>
                <input type="tel" id="customer-phone" placeholder="03xxxxxxxxx">
            </div>
            <div class="form-group">
                <label>Ù¾ØªÛ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
                <textarea id="customer-address" placeholder="Ú¯Ø§ÛÚ© Ú©Ø§ Ù¾ØªÛ"></textarea>
            </div>
            <button class="btn success" onclick="addCustomer()">Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
        </div>
    </div>

    <!-- Add Delivery Modal -->
    <div id="add-delivery-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="delivery-modal-title">Ø¯ÙˆØ¯Ú¾ Ú©ÛŒ ÙØ±Ø§ÛÙ…ÛŒ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</h3>
            <div class="form-group">
                <label>Ø´Ø±ÙˆØ¹ Ú©ÛŒ ØªØ§Ø±ÛŒØ®:</label>
                <input type="date" id="delivery-from-date">
            </div>
            <div class="form-group">
                <label>Ø§Ø®ØªØªØ§Ù… Ú©ÛŒ ØªØ§Ø±ÛŒØ®:</label>
                <input type="date" id="delivery-to-date">
            </div>
            <div class="form-group">
                <label>Ø±ÙˆØ²Ø§Ù†Û Ù„ÛŒÙ¹Ø±:</label>
                <input type="number" id="delivery-liters" placeholder="Ø¬ÛŒØ³Û’ 2" step="0.1">
            </div>
            <div class="form-group">
                <label>ÙÛŒ Ù„ÛŒÙ¹Ø± Ø±ÛŒÙ¹:</label>
                <input type="number" id="delivery-rate" placeholder="Ø¬ÛŒØ³Û’ 120" step="0.1">
            </div>
            <div class="form-group">
                <label>ØªØ¨ØµØ±Û (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
                <textarea id="delivery-note" placeholder="Ú©ÙˆØ¦ÛŒ Ø®Ø§Øµ Ø¨Ø§Øª"></textarea>
            </div>
            <button class="btn success" id="delivery-submit-btn" onclick="addDelivery()">Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="add-payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Ø±Ù‚Ù… Ú©ÛŒ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ</h3>
            <div class="form-group">
                <label>Ø±Ù‚Ù…:</label>
                <input type="number" id="payment-amount" placeholder="Ø§Ø¯Ø§ Ø´Ø¯Û Ø±Ù‚Ù…">
            </div>
            <div class="form-group">
                <label>ØªØ§Ø±ÛŒØ®:</label>
                <input type="date" id="payment-date">
            </div>
            <div class="form-group">
                <label>ØªØ¨ØµØ±Û:</label>
                <textarea id="payment-note" placeholder="Ú©ÙˆØ¦ÛŒ Ø®Ø§Øµ Ø¨Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></textarea>
            </div>
            <button class="btn success" onclick="addPayment()">Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
        </div>
    </div>

    <!-- Add Day Off Modal -->
    <div id="add-day-off-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Ú†Ú¾Ù¹ÛŒ Ú©Ø§ Ø¯Ù†</h3>
            <div class="form-group">
                <label>ØªØ§Ø±ÛŒØ®:</label>
                <input type="date" id="day-off-date">
            </div>
            <div class="form-group">
                <label>ÙˆØ¬Û:</label>
                <textarea id="day-off-reason" placeholder="Ú†Ú¾Ù¹ÛŒ Ú©ÛŒ ÙˆØ¬Û"></textarea>
            </div>
            <button class="btn warning" onclick="addDayOff()">Ú†Ú¾Ù¹ÛŒ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
        </div>
    </div>

    <script>
        // Global variables
        let customers = [];
        let currentCustomerId = null;
        let nextId = 1;
        let editingEntryId = null;
        let backupInterval = null;
        let gitHubSettings = {
            token: '',
            repo: '',
            username: ''
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            console.log('ğŸš€ Initializing Milk Business App...');
            
            loadFromStorage();
            console.log('ğŸ“¦ Loaded from storage:', customers.length, 'customers');
            
            showDashboard();
            updateDashboard();
            loadCustomers();
            initializeBackupSettings();
            
            // Add debug functionality
            setTimeout(() => {
                addDebugButton();
            }, 1000);
            
            // Automatically fix existing entries on startup
            const fixedCount = fixExistingEntries();
            console.log('ğŸ”§ Fixed', fixedCount, 'entries');
            
            // Log successful initialization
            console.log('âœ… App initialized successfully');
            updateBackupStatus('âœ… App Ready - ' + customers.length + ' customers loaded');
        }

        // =================== ENHANCED ENTRY ID FIXING ===================
        
        function fixExistingEntries() {
            console.log('ğŸ”§ Starting to fix existing entries...');
            let totalFixed = 0;
            let customersFixed = 0;
            
            customers.forEach((customer, customerIndex) => {
                if (customer.entries && customer.entries.length > 0) {
                    let customerFixed = false;
                    
                    customer.entries.forEach((entry, index) => {
                        // Check if entry has proper ID
                        if (!entry.id || typeof entry.id !== 'number') {
                            // Generate new ID based on index and timestamp
                            entry.id = Date.now() + index + Math.random() * 1000;
                            totalFixed++;
                            customerFixed = true;
                            console.log(`Fixed entry ID for ${customer.name}:`, entry.id);
                        }
                        
                        // Ensure entry has createdAt timestamp
                        if (!entry.createdAt) {
                            // Try to use existing date fields or create from entry position
                            if (entry.date) {
                                entry.createdAt = new Date(entry.date).toISOString();
                            } else if (entry.fromDate) {
                                entry.createdAt = new Date(entry.fromDate).toISOString();
                            } else {
                                // Create based on index (older entries get older timestamps)
                                const baseDate = new Date('2025-01-01');
                                baseDate.setDate(baseDate.getDate() + index);
                                entry.createdAt = baseDate.toISOString();
                            }
                        }
                        
                        // Ensure entry has proper type
                        if (!entry.type) {
                            if (entry.fromDate && entry.toDate && entry.liters && entry.rate) {
                                entry.type = 'delivery';
                            } else if (entry.amount && entry.date) {
                                entry.type = 'payment';
                            } else if (entry.reason) {
                                entry.type = 'day-off';
                            } else {
                                entry.type = 'delivery'; // Default
                            }
                        }
                        
                        // Auto-assign month for filtering if not present
                        if (!entry.month) {
                            let entryDate = null;
                            if (entry.date) {
                                entryDate = entry.date;
                            } else if (entry.fromDate) {
                                entryDate = entry.fromDate;
                            }
                            
                            if (entryDate) {
                                entry.month = entryDate.substring(0, 7); // YYYY-MM format
                            }
                        }
                    });
                    
                    if (customerFixed) {
                        customersFixed++;
                        console.log(`Fixed entries for customer: ${customer.name}`);
                    }
                }
            });
            
            if (totalFixed > 0) {
                saveToStorage();
                console.log(`âœ… Fixed ${totalFixed} entries for ${customersFixed} customers`);
                updateBackupStatus(`ğŸ”§ Fixed ${totalFixed} entries automatically`);
                
                // Show notification
                setTimeout(() => {
                    showNotification(`âœ… ${totalFixed} entries automatically fixed!`, 'success');
                }, 1000);
            } else {
                console.log('âœ… All entries are properly formatted');
            }
            
            return totalFixed;
        }

        // =================== ENHANCED ENTRY EDITING WITH SMART DETECTION ===================
        
        function editDelivery(entryId) {
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer) {
                showNotification('Ú¯Ø§ÛÚ© Ù†ÛÛŒÚº Ù…Ù„Ø§', 'error');
                return;
            }
            
            // Smart entry detection - try multiple methods
            let entry = null;
            
            // Method 1: Direct ID match
            if (customer.entries) {
                entry = customer.entries.find(e => e.id === entryId);
            }
            
            // Method 2: If not found, try to find by index (for old entries)
            if (!entry && customer.entries) {
                const entryIndex = customer.entries.findIndex((e, index) => {
                    // Try to match by index if ID doesn't work
                    return index === (entryId % customer.entries.length);
                });
                if (entryIndex !== -1) {
                    entry = customer.entries[entryIndex];
                    // Update the entry ID for future use
                    entry.id = entryId;
                }
            }
            
            // Method 3: Find by content similarity (for entries without proper IDs)
            if (!entry && customer.entries) {
                // Try to find delivery entry by approximate position
                const deliveryEntries = customer.entries.filter(e => e.type === 'delivery' || (e.fromDate && e.toDate));
                if (deliveryEntries.length > 0) {
                    // Use modulo to find a reasonable entry
                    const targetIndex = Math.abs(entryId) % deliveryEntries.length;
                    entry = deliveryEntries[targetIndex];
                    if (entry) {
                        entry.id = entryId; // Assign the ID for future use
                    }
                }
            }
            
            if (!entry) {
                showNotification('Ø§Ù†Ù¹Ø±ÛŒ Ù†ÛÛŒÚº Ù…Ù„ÛŒ - ÛŒÛ Ù¾Ø±Ø§Ù†Û’ ÙˆØ±Ú˜Ù† Ú©ÛŒ entry ÛÙˆ Ø³Ú©ØªÛŒ ÛÛ’', 'error');
                return;
            }
            
            editingEntryId = entryId;
            document.getElementById('delivery-modal-title').textContent = 'ÙØ±Ø§ÛÙ…ÛŒ Ù…ÛŒÚº ØªØ±Ù…ÛŒÙ… Ú©Ø±ÛŒÚº';
            document.getElementById('delivery-submit-btn').textContent = 'Ø§Ù¾ÚˆÛŒÙ¹ Ú©Ø±ÛŒÚº';
            
            document.getElementById('delivery-from-date').value = entry.fromDate || '';
            document.getElementById('delivery-to-date').value = entry.toDate || '';
            document.getElementById('delivery-liters').value = entry.liters || '';
            document.getElementById('delivery-rate').value = entry.rate || '';
            document.getElementById('delivery-note').value = entry.note || '';
            
            document.getElementById('add-delivery-modal').style.display = 'flex';
        }

        function deleteEntry(entryId) {
            showConfirm('Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ ÛŒÛ Ø§Ù†Ù¹Ø±ÛŒ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ', () => {
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer || !customer.entries) {
                    showNotification('Ú¯Ø§ÛÚ© ÛŒØ§ Ø§Ù†Ù¹Ø±ÛŒØ² Ù†ÛÛŒÚº Ù…Ù„ÛŒÚº', 'error');
                    return;
                }
                
                // Smart deletion - try multiple methods
                let deleted = false;
                
                // Method 1: Direct ID match
                const originalLength = customer.entries.length;
                customer.entries = customer.entries.filter(e => e.id !== entryId);
                deleted = customer.entries.length < originalLength;
                
                // Method 2: If not deleted, try by index
                if (!deleted) {
                    const entryIndex = Math.abs(entryId) % originalLength;
                    if (entryIndex < customer.entries.length) {
                        customer.entries.splice(entryIndex, 1);
                        deleted = true;
                    }
                }
                
                if (deleted) {
                    saveToStorage();
                    filterByMonth(); // Use filter instead of direct load
                    loadCustomers();
                    updateDashboard();
                    showNotification('Ø§Ù†Ù¹Ø±ÛŒ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø­Ø°Ù ÛÙˆ Ú¯Ø¦ÛŒ!', 'success');
                } else {
                    showNotification('Ø§Ù†Ù¹Ø±ÛŒ Ø­Ø°Ù Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©ÛŒ', 'error');
                }
            });
        }

        // =================== ENHANCED MONTH FILTERING ===================
        
        function filterByMonth() {
            if (!currentCustomerId) {
                return;
            }
            
            const selectedMonth = document.getElementById('month-filter').value;
            const customer = customers.find(c => c.id === currentCustomerId);
            
            if (!customer) {
                return;
            }
            
            let filteredEntries = customer.entries || [];
            
            // Filter entries based on selected month
            if (selectedMonth !== 'all') {
                filteredEntries = customer.entries.filter(entry => {
                    return isEntryInMonth(entry, selectedMonth);
                });
            }
            
            // Load filtered entries
            loadLedgerEntriesFiltered(filteredEntries);
            
            // Update bill summary for filtered entries
            updateBillSummary(filteredEntries, selectedMonth);
        }

        function isEntryInMonth(entry, monthString) {
            if (!monthString || monthString === 'all') {
                return true;
            }
            
            // Check multiple date fields for compatibility
            let entryDate = null;
            
            if (entry.date) {
                entryDate = entry.date;
            } else if (entry.fromDate) {
                entryDate = entry.fromDate;
            } else if (entry.createdAt) {
                entryDate = entry.createdAt;
            }
            
            if (!entryDate) {
                return false;
            }
            
            // Extract year-month from date
            const entryMonth = entryDate.substring(0, 7); // YYYY-MM
            return entryMonth === monthString;
        }

        function setCurrentMonth() {
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().substring(0, 7); // YYYY-MM
            document.getElementById('month-filter').value = currentMonth;
            filterByMonth();
        }

        function setPreviousMonth() {
            const currentDate = new Date();
            currentDate.setMonth(currentDate.getMonth() - 1);
            const previousMonth = currentDate.toISOString().substring(0, 7); // YYYY-MM
            document.getElementById('month-filter').value = previousMonth;
            filterByMonth();
        }

        function getMonthDisplayName(monthString) {
            const monthNames = {
                '2024-01': 'Ø¬Ù†ÙˆØ±ÛŒ 2024',
                '2024-02': 'ÙØ±ÙˆØ±ÛŒ 2024',
                '2024-03': 'Ù…Ø§Ø±Ú† 2024',
                '2024-04': 'Ø§Ù¾Ø±ÛŒÙ„ 2024',
                '2024-05': 'Ù…Ø¦ÛŒ 2024',
                '2024-06': 'Ø¬ÙˆÙ† 2024',
                '2024-07': 'Ø¬ÙˆÙ„Ø§Ø¦ÛŒ 2024',
                '2024-08': 'Ø§Ú¯Ø³Øª 2024',
                '2024-09': 'Ø³ØªÙ…Ø¨Ø± 2024',
                '2024-10': 'Ø§Ú©ØªÙˆØ¨Ø± 2024',
                '2024-11': 'Ù†ÙˆÙ…Ø¨Ø± 2024',
                '2024-12': 'Ø¯Ø³Ù…Ø¨Ø± 2024',
                '2025-01': 'Ø¬Ù†ÙˆØ±ÛŒ 2025',
                '2025-02': 'ÙØ±ÙˆØ±ÛŒ 2025',
                '2025-03': 'Ù…Ø§Ø±Ú† 2025',
                '2025-04': 'Ø§Ù¾Ø±ÛŒÙ„ 2025',
                '2025-05': 'Ù…Ø¦ÛŒ 2025',
                '2025-06': 'Ø¬ÙˆÙ† 2025',
                '2025-07': 'Ø¬ÙˆÙ„Ø§Ø¦ÛŒ 2025',
                '2025-08': 'Ø§Ú¯Ø³Øª 2025',
                '2025-09': 'Ø³ØªÙ…Ø¨Ø± 2025',
                '2025-10': 'Ø§Ú©ØªÙˆØ¨Ø± 2025',
                '2025-11': 'Ù†ÙˆÙ…Ø¨Ø± 2025',
                '2025-12': 'Ø¯Ø³Ù…Ø¨Ø± 2025'
            };
            
            return monthNames[monthString] || monthString;
        }

        function calculatePreviousMonthBalance(customerId, currentMonth) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.entries) {
                return 0;
            }
            
            let previousRevenue = 0;
            let previousPayments = 0;
            
            customer.entries.forEach(entry => {
                let entryDate = entry.date || entry.fromDate || entry.createdAt;
                if (!entryDate) return;
                
                const entryMonth = entryDate.substring(0, 7);
                if (entryMonth < currentMonth) {
                    if (entry.type === 'delivery') {
                        const days = calculateDays(entry.fromDate, entry.toDate);
                        previousRevenue += days * entry.liters * entry.rate;
                    } else if (entry.type === 'payment') {
                        previousPayments += parseFloat(entry.amount);
                    }
                }
            });
            
            return previousRevenue - previousPayments;
        }

        // =================== ENHANCED GITHUB AUTO-STORAGE ===================
        
        async function generateCurrentCustomerLegalSizeWithAutoSave() {
            if (!currentCustomerId) {
                showNotification('Ù¾ÛÙ„Û’ Ú¯Ø§ÛÚ© Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            const htmlContent = await generateCustomerLegalSize(currentCustomerId, true);
            return htmlContent;
        }

        async function generateCustomerLegalSize(customerId, autoSave = true) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('Ú¯Ø§ÛÚ© Ù†ÛÛŒÚº Ù…Ù„Ø§', 'error');
                return;
            }
            
            const htmlContent = createCustomerLegalSizeHTML(customer);
            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = `${customer.name.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_')}_LegalSize_${dateStr}.html`;
            
            // Always download locally first
            downloadHTMLFile(htmlContent, fileName);
            
            // Try GitHub auto-save if enabled and connected (but don't fail if it doesn't work)
            if (autoSave && gitHubSettings.token && gitHubSettings.repo) {
                try {
                    const customerFolderName = customer.name.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_');
                    const folderPath = `reports/customers/${customerFolderName}`;
                    
                    // Try to create directory first (but don't fail if it doesn't work)
                    await createGitHubDirectory(folderPath).catch(() => {
                        console.log('Directory creation skipped');
                    });
                    
                    const githubUrl = await saveHTMLToGitHub(htmlContent, fileName, folderPath);
                    if (githubUrl) {
                        showNotification(`${customer.name} Ú©ÛŒ Legal Size Ù¾Ø±Ù†Ù¹ ÙØ§Ø¦Ù„ ØªÛŒØ§Ø± Ø§ÙˆØ± GitHub Ù…ÛŒÚº Ù…Ø­ÙÙˆØ¸!`, 'success');
                        console.log('Customer report auto-saved to GitHub:', githubUrl);
                        updateBackupStatus('âœ… HTML Report auto-saved to GitHub');
                    } else {
                        // GitHub save failed but that's okay
                        showNotification(`${customer.name} Ú©ÛŒ Legal Size Ù¾Ø±Ù†Ù¹ ÙØ§Ø¦Ù„ ØªÛŒØ§Ø±! (GitHub Ø³ÛŒÙˆ ÙÛŒÙ„ Ù„ÛŒÚ©Ù† Local OK)`, 'success');
                    }
                } catch (error) {
                    console.warn('GitHub auto-save error (non-critical):', error.message);
                    showNotification(`${customer.name} Ú©ÛŒ Legal Size Ù¾Ø±Ù†Ù¹ ÙØ§Ø¦Ù„ ØªÛŒØ§Ø±! (Local file ready)`, 'success');
                }
            } else {
                // GitHub not configured
                showNotification(`${customer.name} Ú©ÛŒ Legal Size Ù¾Ø±Ù†Ù¹ ÙØ§Ø¦Ù„ ØªÛŒØ§Ø±!`, 'success');
                if (!gitHubSettings.token || !gitHubSettings.repo) {
                    setTimeout(() => {
                        showNotification('ğŸ’¡ GitHub auto-save Ú©Û’ Ù„ÛŒÛ’ Backup section Ù…ÛŒÚº Ø¬Ø§ Ú©Ø± Ø³ÛŒÙ¹ Ø§Ù¾ Ú©Ø±ÛŒÚº', 'info');
                    }, 2000);
                }
            }
            
            return htmlContent;
        }

        async function generateAllCustomersLegalSizeWithAutoSave() {
            if (customers.length === 0) {
                showNotification('Ú©ÙˆØ¦ÛŒ Ú¯Ø§ÛÚ© Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº', 'warning');
                return;
            }
            
            const htmlContent = createAllCustomersLegalSizeHTML();
            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = `All_Customers_LegalSize_${dateStr}.html`;
            
            // Always download locally first
            downloadHTMLFile(htmlContent, fileName);
            
            // Try GitHub auto-save if connected (but don't fail if it doesn't work)
            if (gitHubSettings.token && gitHubSettings.repo) {
                try {
                    const folderPath = 'reports/all_customers';
                    
                    // Try to create directory (but don't fail if it doesn't work)
                    await createGitHubDirectory(folderPath).catch(() => {
                        console.log('Directory creation skipped');
                    });
                    
                    const githubUrl = await saveHTMLToGitHub(htmlContent, fileName, folderPath);
                    if (githubUrl) {
                        showNotification('ØªÙ…Ø§Ù… Ú¯Ø§ÛÚ©ÙˆÚº Ú©ÛŒ Legal Size Ø±Ù¾ÙˆØ±Ù¹ ØªÛŒØ§Ø± Ø§ÙˆØ± GitHub Ù…ÛŒÚº Ù…Ø­ÙÙˆØ¸!', 'success');
                        console.log('All customers report auto-saved to GitHub:', githubUrl);
                        updateBackupStatus('âœ… All Customers HTML Report auto-saved');
                    } else {
                        showNotification('ØªÙ…Ø§Ù… Ú¯Ø§ÛÚ©ÙˆÚº Ú©ÛŒ Legal Size Ø±Ù¾ÙˆØ±Ù¹ ØªÛŒØ§Ø±! (GitHub Ø³ÛŒÙˆ ÙÛŒÙ„ Ù„ÛŒÚ©Ù† Local OK)', 'success');
                    }
                } catch (error) {
                    console.warn('GitHub auto-save error (non-critical):', error.message);
                    showNotification('ØªÙ…Ø§Ù… Ú¯Ø§ÛÚ©ÙˆÚº Ú©ÛŒ Legal Size Ø±Ù¾ÙˆØ±Ù¹ ØªÛŒØ§Ø±! (Local file ready)', 'success');
                }
            } else {
                showNotification('ØªÙ…Ø§Ù… Ú¯Ø§ÛÚ©ÙˆÚº Ú©ÛŒ Legal Size Ø±Ù¾ÙˆØ±Ù¹ ØªÛŒØ§Ø±!', 'success');
            }
            
            return htmlContent;
        }

        // Update the existing functions to use auto-save
        async function generateCurrentCustomerLegalSize() {
            return await generateCurrentCustomerLegalSizeWithAutoSave();
        }

        async function generateAllCustomersLegalSize() {
            return await generateAllCustomersLegalSizeWithAutoSave();
        }

        async function generateBusinessSummaryLegalSize() {
            const htmlContent = createBusinessSummaryLegalSizeHTML();
            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = `Business_Summary_LegalSize_${dateStr}.html`;
            
            // Download locally
            downloadHTMLFile(htmlContent, fileName);
            
            // Auto-save to GitHub if connected
            if (gitHubSettings.token && gitHubSettings.repo) {
                try {
                    const folderPath = 'reports/business_summary';
                    
                    // Ensure directory exists
                    await createGitHubDirectory(folderPath);
                    
                    const githubUrl = await saveHTMLToGitHub(htmlContent, fileName, folderPath);
                    if (githubUrl) {
                        showNotification('Ú©Ø§Ø±ÙˆØ¨Ø§Ø±ÛŒ Ø®Ù„Ø§ØµÛ Legal Size Ø±Ù¾ÙˆØ±Ù¹ ØªÛŒØ§Ø± Ø§ÙˆØ± GitHub Ù…ÛŒÚº Ù…Ø­ÙÙˆØ¸!', 'success');
                        console.log('Business summary auto-saved to GitHub:', githubUrl);
                        updateBackupStatus('âœ… Business Summary HTML Report auto-saved');
                    } else {
                        showNotification('Ú©Ø§Ø±ÙˆØ¨Ø§Ø±ÛŒ Ø®Ù„Ø§ØµÛ Legal Size Ø±Ù¾ÙˆØ±Ù¹ ØªÛŒØ§Ø±! (GitHub save ÙÛŒÙ„)', 'warning');
                    }
                } catch (error) {
                    console.error('GitHub auto-save error:', error);
                    showNotification('Ú©Ø§Ø±ÙˆØ¨Ø§Ø±ÛŒ Ø®Ù„Ø§ØµÛ Legal Size Ø±Ù¾ÙˆØ±Ù¹ ØªÛŒØ§Ø±! (Local only)', 'success');
                }
            } else {
                showNotification('Ú©Ø§Ø±ÙˆØ¨Ø§Ø±ÛŒ Ø®Ù„Ø§ØµÛ Legal Size Ø±Ù¾ÙˆØ±Ù¹ ØªÛŒØ§Ø±!', 'success');
            }
            
            return htmlContent;
        }

        // =================== STORAGE FUNCTIONS ===================
        
        function saveToStorage() {
            try {
                const data = {
                    customers: customers,
                    nextId: nextId,
                    gitHubSettings: gitHubSettings,
                    lastSaved: new Date().toISOString(),
                    version: '6.1'
                };
                
                localStorage.setItem('milkBusinessData', JSON.stringify(data));
                updateBackupStatus('âœ… ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ Ø´Ø¯Û');
                updateBackupSize();
                
            } catch (error) {
                console.error('Storage save error:', error);
                updateBackupStatus('âŒ Ù…Ø­ÙÙˆØ¸ÛŒØª Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ', 'error');
            }
        }

        function loadFromStorage() {
            try {
                const data = localStorage.getItem('milkBusinessData');
                if (data) {
                    const parsed = JSON.parse(data);
                    customers = parsed.customers || [];
                    nextId = parsed.nextId || 1;
                    gitHubSettings = parsed.gitHubSettings || { token: '', repo: '', username: '' };
                    
                    // Load GitHub settings to form
                    if (gitHubSettings.token) {
                        document.getElementById('github-token').value = gitHubSettings.token;
                    }
                    if (gitHubSettings.repo) {
                        document.getElementById('github-repo').value = gitHubSettings.repo;
                    }
                }
                
                // Initialize with built-in token if no stored settings
                if (!gitHubSettings.token) {
                    const builtInToken = document.getElementById('github-token').value;
                    const builtInRepo = document.getElementById('github-repo').value;
                    if (builtInToken && builtInRepo) {
                        gitHubSettings.token = builtInToken;
                        gitHubSettings.repo = builtInRepo;
                        updateBackupStatus('ğŸš€ GitHub token ready - click connect!');
                    }
                }
            } catch (error) {
                console.error('Storage load error:', error);
                customers = [];
                nextId = 1;
                gitHubSettings = { 
                    token: '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', 
                    repo: 'abdul8659/milk-business-app', 
                    username: '' 
                };
            }
        }

        // =================== LOADING ENHANCED ENTRIES ===================
        
        function loadLedgerEntries(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                console.error('Customer not found:', customerId);
                return;
            }
            
            console.log('Loading entries for customer:', customer.name, 'Entries:', customer.entries);
            
            // Ensure entries exist and are properly formatted
            if (!customer.entries) {
                customer.entries = [];
            }
            
            // Fix any entries that might be missing IDs
            customer.entries.forEach((entry, index) => {
                if (!entry.id) {
                    entry.id = Date.now() + index;
                    console.log('Fixed entry ID:', entry.id);
                }
            });
            
            loadLedgerEntriesFiltered(customer.entries);
        }

        function loadLedgerEntriesFiltered(entries) {
            const container = document.getElementById('ledger-entries');
            
            container.innerHTML = '';

            if (!entries || entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">Ú©ÙˆØ¦ÛŒ Ø§Ù†Ù¹Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº</div>';
                updateBillSummary([]);
                return;
            }

            // Sort entries by date (newest first)
            const sortedEntries = [...entries].sort((a, b) => {
                const aDate = new Date(a.date || a.fromDate || a.createdAt);
                const bDate = new Date(b.date || b.fromDate || b.createdAt);
                return bDate - aDate;
            });

            sortedEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = `entry-item ${entry.type}`;
                
                // Ensure entry has an ID
                if (!entry.id) {
                    entry.id = Date.now() + Math.random() * 1000;
                }
                
                if (entry.type === 'delivery') {
                    const days = calculateDays(entry.fromDate, entry.toDate);
                    const totalLiters = days * entry.liters;
                    const total = totalLiters * entry.rate;
                    
                    entryDiv.innerHTML = `
                        <div class="entry-actions">
                            <button class="entry-action-btn edit-btn" onclick="editDelivery(${entry.id})" title="ØªØ±Ù…ÛŒÙ… Ú©Ø±ÛŒÚº">âœï¸</button>
                            <button class="entry-action-btn delete-btn" onclick="deleteEntry(${entry.id})" title="Ø­Ø°Ù Ú©Ø±ÛŒÚº">ğŸ—‘ï¸</button>
                        </div>
                        <div class="entry-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>ğŸ¥› Ø¯ÙˆØ¯Ú¾ Ú©ÛŒ ÙØ±Ø§ÛÙ…ÛŒ</strong>
                                <div style="background: #4CAF50; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                    ${total} Ø±ÙˆÙ¾Û’
                                </div>
                            </div>
                            ğŸ“… ${formatDate(entry.fromDate)} Ø³Û’ ${formatDate(entry.toDate)} ØªÚ© (${days} Ø¯Ù†)<br>
                            ğŸ¥› Ø±ÙˆØ²Ø§Ù†Û ${entry.liters} Ù„ÛŒÙ¹Ø± Ã— ${days} Ø¯Ù† = <strong>${totalLiters} Ú©Ù„ Ù„ÛŒÙ¹Ø±</strong><br>
                            ğŸ’° ${totalLiters} Ù„ÛŒÙ¹Ø± Ã— ${entry.rate} Ø±ÙˆÙ¾Û’ = <strong>${total} Ø±ÙˆÙ¾Û’</strong><br>
                            ${entry.note ? `ğŸ“ ${entry.note}<br>` : ''}
                            â° Ø´Ø§Ù…Ù„: ${formatDateTime(entry.createdAt)}
                        </div>
                    `;
                } else if (entry.type === 'payment') {
                    entryDiv.innerHTML = `
                        <div class="entry-actions">
                            <button class="entry-action-btn delete-btn" onclick="deleteEntry(${entry.id})" title="Ø­Ø°Ù Ú©Ø±ÛŒÚº">ğŸ—‘ï¸</button>
                        </div>
                        <div class="entry-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>ğŸ’° Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ</strong>
                                <div style="background: #2196F3; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                    ${entry.amount} Ø±ÙˆÙ¾Û’
                                </div>
                            </div>
                            ğŸ“… ${formatDate(entry.date)}<br>
                            ğŸ’° ${entry.amount} Ø±ÙˆÙ¾Û’<br>
                            ${entry.note ? `ğŸ“ ${entry.note}<br>` : ''}
                            â° Ø´Ø§Ù…Ù„: ${formatDateTime(entry.createdAt)}
                        </div>
                    `;
                } else if (entry.type === 'day-off') {
                    entryDiv.innerHTML = `
                        <div class="entry-actions">
                            <button class="entry-action-btn delete-btn" onclick="deleteEntry(${entry.id})" title="Ø­Ø°Ù Ú©Ø±ÛŒÚº">ğŸ—‘ï¸</button>
                        </div>
                        <div class="entry-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>ğŸš« Ú†Ú¾Ù¹ÛŒ Ú©Ø§ Ø¯Ù†</strong>
                                <div style="background: #ff416c; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                    Ø¢Ù ÚˆÛ’
                                </div>
                            </div>
                            ğŸ“… ${formatDate(entry.date)}<br>
                            ğŸ“ ${entry.reason || 'Ú©ÙˆØ¦ÛŒ ÙˆØ¬Û Ù†ÛÛŒÚº Ø¯ÛŒ Ú¯Ø¦ÛŒ'}<br>
                            â° Ø´Ø§Ù…Ù„: ${formatDateTime(entry.createdAt)}
                        </div>
                    `;
                }
                
                container.appendChild(entryDiv);
            });

            updateBillSummary(entries);
        }

        function updateBillSummary(entries, selectedMonth = null) {
            let totalLiters = 0;
            let totalDays = 0;
            let totalAmount = 0;
            let totalPayments = 0;
            let deliveryCount = 0;
            let paymentCount = 0;
            let dayOffCount = 0;

            if (entries && entries.length > 0) {
                entries.forEach(entry => {
                    if (entry.type === 'delivery') {
                        const days = calculateDays(entry.fromDate, entry.toDate);
                        const liters = days * parseFloat(entry.liters || 0);
                        const amount = liters * parseFloat(entry.rate || 0);
                        
                        totalLiters += liters;
                        totalDays += days;
                        totalAmount += amount;
                        deliveryCount++;
                    } else if (entry.type === 'payment') {
                        totalPayments += parseFloat(entry.amount || 0);
                        paymentCount++;
                    } else if (entry.type === 'day-off') {
                        dayOffCount++;
                    }
                });
            }

            const remainingAmount = totalAmount - totalPayments;

            // Add previous balance calculation for monthly view
            let previousBalance = 0;
            if (selectedMonth && selectedMonth !== 'all') {
                previousBalance = calculatePreviousMonthBalance(currentCustomerId, selectedMonth);
            }

            const finalBalance = previousBalance + remainingAmount;

            let summaryHTML = `
                <h3>ğŸ“‹ Ø¨Ù„ Ú©Ø§ Ø®Ù„Ø§ØµÛ</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #4CAF50; font-weight: bold;">${deliveryCount}</div>
                        <div>ÙØ±Ø§ÛÙ…ÛŒ Ú©ÛŒ ØªØ¹Ø¯Ø§Ø¯</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #2196F3; font-weight: bold;">${totalDays}</div>
                        <div>Ú©Ù„ Ø¯Ù†</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #ff9800; font-weight: bold;">${totalLiters}</div>
                        <div>Ú©Ù„ Ù„ÛŒÙ¹Ø±</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #9c27b0; font-weight: bold;">${totalAmount} Ø±ÙˆÙ¾Û’</div>
                        <div>${selectedMonth && selectedMonth !== 'all' ? 'Ø§Ø³ Ù…ÛÛŒÙ†Û’ Ú©Ø§' : 'Ú©Ù„'} Ø¨Ù„</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #4CAF50; font-weight: bold;">${paymentCount}</div>
                        <div>Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒØ§Úº</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #4CAF50; font-weight: bold;">${totalPayments} Ø±ÙˆÙ¾Û’</div>
                        <div>Ø§Ø¯Ø§ Ø´Ø¯Û</div>
                    </div>`;

            if (previousBalance !== 0) {
                summaryHTML += `
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #ff5722; font-weight: bold;">${previousBalance} Ø±ÙˆÙ¾Û’</div>
                        <div>Ù¾Ú†Ú¾Ù„Ø§ Ø¨ÛŒÙ„Ù†Ø³</div>
                    </div>`;
            }

            summaryHTML += `
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: ${finalBalance > 0 ? '#f44336' : '#4CAF50'}; font-weight: bold;">${finalBalance} Ø±ÙˆÙ¾Û’</div>
                        <div>${selectedMonth && selectedMonth !== 'all' ? 'Ù…Ø¬Ù…ÙˆØ¹ÛŒ' : ''} Ø¨Ø§Ù‚ÛŒ Ø±Ù‚Ù…</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; color: #ff5722; font-weight: bold;">${dayOffCount}</div>
                        <div>Ú†Ú¾Ù¹ÛŒØ§Úº</div>
                    </div>
                </div>
            `;

            document.getElementById('bill-summary').innerHTML = summaryHTML;
        }

        // =================== CONTINUE WITH THE REST OF THE ORIGINAL FUNCTIONS ===================
        // [Include all other functions from the original code but with the fixes above]
        
        // Customer Management Functions
        function loadCustomers() {
            displayCustomers(customers);
        }

        function displayCustomers(customerList) {
            const grid = document.getElementById('customers-grid');
            if (!grid) return;
            
            grid.innerHTML = '';

            customerList.forEach(customer => {
                const card = document.createElement('div');
                card.className = 'customer-card';
                
                // Calculate customer totals
                let totalRevenue = 0;
                let totalPayments = 0;
                let deliveryCount = 0;
                let paymentCount = 0;
                
                if (customer.entries) {
                    customer.entries.forEach(entry => {
                        if (entry.type === 'delivery') {
                            const days = calculateDays(entry.fromDate, entry.toDate);
                            totalRevenue += days * entry.liters * entry.rate;
                            deliveryCount++;
                        } else if (entry.type === 'payment') {
                            totalPayments += parseFloat(entry.amount);
                            paymentCount++;
                        }
                    });
                }
                
                const remaining = totalRevenue - totalPayments;
                const statusEmoji = remaining > 0 ? 'ğŸ”´' : remaining < 0 ? 'ğŸŸ¢' : 'ğŸŸ¡';
                
                card.innerHTML = `
                    <h3>${statusEmoji} ${customer.name}</h3>
                    <p>ğŸ“ ${customer.phone || 'ÙÙˆÙ† Ù†Ù…Ø¨Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº'}</p>
                    ${customer.address ? `<p>ğŸ“ ${customer.address}</p>` : ''}
                    <div style="margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                        <p><strong>ğŸ’° Ú©Ù„ Ø¨Ù„:</strong> ${totalRevenue} Ø±ÙˆÙ¾Û’</p>
                        <p><strong>ğŸ’³ Ø§Ø¯Ø§ Ø´Ø¯Û:</strong> ${totalPayments} Ø±ÙˆÙ¾Û’</p>
                        <p><strong>ğŸ“‹ Ø¨Ø§Ù‚ÛŒ:</strong> ${remaining} Ø±ÙˆÙ¾Û’</p>
                        <p><strong>ğŸ“ Ø§Ù†Ù¹Ø±ÛŒØ²:</strong> ${deliveryCount} ÙØ±Ø§ÛÙ…ÛŒ, ${paymentCount} Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ</p>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn" onclick="event.stopPropagation(); showCustomerLedger(${customer.id})" style="background: #2196F3; padding: 6px 10px; font-size: 11px;">ğŸ“ Ú©Ú¾Ø§ØªÛ</button>
                        <button class="btn" onclick="event.stopPropagation(); generateCustomerLegalSize(${customer.id})" style="background: #4CAF50; padding: 6px 10px; font-size: 11px;">ğŸ–¨ï¸ Legal Print</button>
                        <button class="btn" onclick="event.stopPropagation(); sendWhatsApp(${customer.id})" style="background: #25D366; padding: 6px 10px; font-size: 11px;">ğŸ“± WhatsApp</button>
                        <button class="btn" onclick="event.stopPropagation(); deleteCustomer(${customer.id})" style="background: #f44336; padding: 6px 10px; font-size: 11px;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                `;
                
                grid.appendChild(card);
            });

            const addBtn = document.createElement('div');
            addBtn.className = 'customer-card add-customer-card';
            addBtn.innerHTML = 'â•<br><small style="font-size: 0.5em; margin-top: 10px;">Ù†ÛŒØ§ Ú¯Ø§ÛÚ© Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</small>';
            addBtn.onclick = showAddCustomerModal;
            grid.appendChild(addBtn);
        }

        function showCustomerLedger(customerId) {
            currentCustomerId = customerId;
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) {
                showNotification('Ú¯Ø§ÛÚ© Ù†ÛÛŒÚº Ù…Ù„Ø§', 'error');
                console.error('Customer not found with ID:', customerId);
                return;
            }
            
            console.log('Showing ledger for customer:', customer.name);
            console.log('Customer entries:', customer.entries);
            
            document.getElementById('ledger-title').textContent = `${customer.name} Ú©Ø§ Ú©Ú¾Ø§ØªÛ`;
            showSection('ledger-section');
            
            // Set current month by default
            setCurrentMonth();
            
            // Force load entries
            setTimeout(() => {
                loadLedgerEntries(customerId);
            }, 100);
        }

        // Debug function to check data
        function debugCustomerData() {
            console.log('=== DEBUG: Customer Data ===');
            console.log('Total customers:', customers.length);
            customers.forEach((customer, index) => {
                console.log(`Customer ${index + 1}:`, {
                    id: customer.id,
                    name: customer.name,
                    entriesCount: customer.entries ? customer.entries.length : 0,
                    entries: customer.entries
                });
            });
            console.log('Current customer ID:', currentCustomerId);
        }

        // Add this to the dashboard for debugging
        function addDebugButton() {
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
                const debugBtn = document.createElement('button');
                debugBtn.className = 'btn info';
                debugBtn.textContent = 'ğŸ” Debug Data';
                debugBtn.onclick = debugCustomerData;
                debugBtn.style.margin = '10px';
                
                const existingDebugBtn = dashboardSection.querySelector('[onclick="debugCustomerData()"]');
                if (!existingDebugBtn) {
                    dashboardSection.appendChild(debugBtn);
                }
            }
        }

        function searchCustomers() {
            const searchTerm = document.getElementById('customer-search').value.toLowerCase();
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) || 
                (customer.phone && customer.phone.includes(searchTerm))
            );
            displayCustomers(filteredCustomers);
        }

        function showAddCustomerModal() {
            document.getElementById('add-customer-modal').style.display = 'flex';
        }

        function addCustomer() {
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const address = document.getElementById('customer-address').value.trim();
            
            if (!name) {
                showNotification('Ø¨Ø±Ø§Û Ú©Ø±Ù… Ù†Ø§Ù… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            const customer = {
                id: nextId++,
                name: name,
                phone: phone,
                address: address,
                createdAt: new Date().toISOString(),
                entries: []
            };
            
            customers.push(customer);
            saveToStorage();
            
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('customer-address').value = '';
            
            closeModal();
            loadCustomers();
            updateDashboard();
            
            showNotification('Ú¯Ø§ÛÚ© Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø´Ø§Ù…Ù„ ÛÙˆ Ú¯ÛŒØ§!', 'success');
        }

        function deleteCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            showConfirm(`Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ "${customer.name}" Ú©Ùˆ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ`, () => {
                customers = customers.filter(c => c.id !== customerId);
                
                if (currentCustomerId === customerId) {
                    currentCustomerId = null;
                    showCustomers();
                }
                
                saveToStorage();
                loadCustomers();
                updateDashboard();
                
                showNotification(`"${customer.name}" Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø­Ø°Ù ÛÙˆ Ú¯ÛŒØ§!`, 'success');
            });
        }

        // Entry Management Functions
        function showAddDeliveryModal() {
            editingEntryId = null;
            document.getElementById('delivery-modal-title').textContent = 'Ø¯ÙˆØ¯Ú¾ Ú©ÛŒ ÙØ±Ø§ÛÙ…ÛŒ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº';
            document.getElementById('delivery-submit-btn').textContent = 'Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº';
            
            clearDeliveryForm();
            
            // Set default dates to current month
            const currentDate = new Date();
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            document.getElementById('delivery-from-date').value = firstDay.toISOString().split('T')[0];
            document.getElementById('delivery-to-date').value = lastDay.toISOString().split('T')[0];
            
            document.getElementById('add-delivery-modal').style.display = 'flex';
        }

        function showAddPaymentModal() {
            clearPaymentForm();
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-payment-modal').style.display = 'flex';
        }

        function showAddDayOffModal() {
            clearDayOffForm();
            document.getElementById('day-off-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-day-off-modal').style.display = 'flex';
        }

        function addDelivery() {
            if (!currentCustomerId) {
                showNotification('Ù¾ÛÙ„Û’ Ú¯Ø§ÛÚ© Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            const fromDate = document.getElementById('delivery-from-date').value;
            const toDate = document.getElementById('delivery-to-date').value;
            const liters = parseFloat(document.getElementById('delivery-liters').value);
            const rate = parseFloat(document.getElementById('delivery-rate').value);
            const note = document.getElementById('delivery-note').value.trim();
            
            if (!fromDate || !toDate || !liters || !rate) {
                showNotification('Ø¨Ø±Ø§Û Ú©Ø±Ù… ØªÙ…Ø§Ù… Ø¶Ø±ÙˆØ±ÛŒ ÙÛŒÙ„ÚˆØ² Ø¨Ú¾Ø±ÛŒÚº', 'error');
                return;
            }
            
            if (new Date(fromDate) > new Date(toDate)) {
                showNotification('Ø§Ø®ØªØªØ§Ù… Ú©ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ú©ÛŒ ØªØ§Ø±ÛŒØ® Ø³Û’ Ù¾ÛÙ„Û’ Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©ØªÛŒ', 'error');
                return;
            }
            
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer.entries) {
                customer.entries = [];
            }
            
            if (editingEntryId) {
                const entryIndex = customer.entries.findIndex(e => e.id === editingEntryId);
                if (entryIndex > -1) {
                    customer.entries[entryIndex] = {
                        ...customer.entries[entryIndex],
                        fromDate: fromDate,
                        toDate: toDate,
                        liters: liters,
                        rate: rate,
                        note: note,
                        month: fromDate.substring(0, 7),
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('ÙØ±Ø§ÛÙ…ÛŒ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø§Ù¾ÚˆÛŒÙ¹ ÛÙˆ Ú¯Ø¦ÛŒ!', 'success');
                }
            } else {
                const entry = {
                    id: Date.now(),
                    type: 'delivery',
                    fromDate: fromDate,
                    toDate: toDate,
                    liters: liters,
                    rate: rate,
                    note: note,
                    month: fromDate.substring(0, 7),
                    createdAt: new Date().toISOString()
                };
                
                customer.entries.push(entry);
                showNotification('ÙØ±Ø§ÛÙ…ÛŒ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø´Ø§Ù…Ù„ ÛÙˆ Ú¯Ø¦ÛŒ!', 'success');
            }
            
            saveToStorage();
            clearDeliveryForm();
            closeModal();
            filterByMonth();
            loadCustomers();
            updateDashboard();
        }

        function addPayment() {
            if (!currentCustomerId) {
                showNotification('Ù¾ÛÙ„Û’ Ú¯Ø§ÛÚ© Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;
            const note = document.getElementById('payment-note').value.trim();
            
            if (!amount || !date) {
                showNotification('Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø±Ù‚Ù… Ø§ÙˆØ± ØªØ§Ø±ÛŒØ® Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer.entries) {
                customer.entries = [];
            }
            
            const payment = {
                id: Date.now(),
                type: 'payment',
                amount: amount,
                date: date,
                note: note,
                month: date.substring(0, 7),
                createdAt: new Date().toISOString()
            };
            
            customer.entries.push(payment);
            saveToStorage();
            
            clearPaymentForm();
            closeModal();
            filterByMonth();
            loadCustomers();
            updateDashboard();
            
            showNotification('Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø´Ø§Ù…Ù„ ÛÙˆ Ú¯Ø¦ÛŒ!', 'success');
        }

        function addDayOff() {
            if (!currentCustomerId) {
                showNotification('Ù¾ÛÙ„Û’ Ú¯Ø§ÛÚ© Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            const date = document.getElementById('day-off-date').value;
            const reason = document.getElementById('day-off-reason').value.trim();
            
            if (!date) {
                showNotification('Ø¨Ø±Ø§Û Ú©Ø±Ù… ØªØ§Ø±ÛŒØ® Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer.entries) {
                customer.entries = [];
            }
            
            const dayOff = {
                id: Date.now(),
                type: 'day-off',
                date: date,
                reason: reason,
                month: date.substring(0, 7),
                createdAt: new Date().toISOString()
            };
            
            customer.entries.push(dayOff);
            saveToStorage();
            
            clearDayOffForm();
            closeModal();
            filterByMonth();
            updateDashboard();
            
            showNotification('Ú†Ú¾Ù¹ÛŒ Ú©Ø§ Ø¯Ù† Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø´Ø§Ù…Ù„ ÛÙˆ Ú¯ÛŒØ§!', 'success');
        }

        // Utility Functions
        function calculateDays(fromDate, toDate) {
            const start = new Date(fromDate);
            const end = new Date(toDate);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ur-PK');
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return `${date.toLocaleDateString('ur-PK')} ${date.toLocaleTimeString('ur-PK')}`;
        }

        function updateDashboard() {
            let totalRevenue = 0;
            let totalPayments = 0;
            let totalCustomers = customers.length;
            
            customers.forEach(customer => {
                if (customer.entries) {
                    customer.entries.forEach(entry => {
                        if (entry.type === 'delivery') {
                            const days = calculateDays(entry.fromDate, entry.toDate);
                            totalRevenue += days * entry.liters * entry.rate;
                        } else if (entry.type === 'payment') {
                            totalPayments += parseFloat(entry.amount);
                        }
                    });
                }
            });
            
            const pendingAmount = totalRevenue - totalPayments;
            
            if (document.getElementById('total-customers-stat')) {
                document.getElementById('total-customers-stat').textContent = totalCustomers;
                document.getElementById('total-revenue-stat').textContent = totalRevenue;
                document.getElementById('total-payments-stat').textContent = totalPayments;
                document.getElementById('pending-amount-stat').textContent = pendingAmount;
            }
        }

        // Form Helper Functions
        function clearDeliveryForm() {
            document.getElementById('delivery-from-date').value = '';
            document.getElementById('delivery-to-date').value = '';
            document.getElementById('delivery-liters').value = '';
            document.getElementById('delivery-rate').value = '';
            document.getElementById('delivery-note').value = '';
        }

        function clearPaymentForm() {
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-date').value = '';
            document.getElementById('payment-note').value = '';
        }

        function clearDayOffForm() {
            document.getElementById('day-off-date').value = '';
            document.getElementById('day-off-reason').value = '';
        }

        // Navigation Functions
        function showDashboard() {
            setActiveNav(0);
            showSection('dashboard-section');
            updateDashboard();
        }

        function showCustomers() {
            setActiveNav(1);
            showSection('customers-section');
            loadCustomers();
        }

        function showLedger() {
            if (currentCustomerId) {
                setActiveNav(2);
                showSection('ledger-section');
                loadLedgerEntries(currentCustomerId);
            } else {
                showNotification('Ù¾ÛÙ„Û’ Ú¯Ø§ÛÚ© Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº', 'info');
                showCustomers();
            }
        }

        function showReports() {
            setActiveNav(3);
            showSection('reports-section');
        }

        function showBackup() {
            setActiveNav(4);
            showSection('backup-section');
        }

        function setActiveNav(index) {
            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        }

        function showSection(sectionId) {
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            editingEntryId = null;
        }

        // Notification Functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 300px;
                font-size: 14px;
                direction: rtl;
                opacity: 0;
                transition: opacity 0.3s ease;
                font-family: 'Noto Sans Arabic', sans-serif;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.opacity = '1', 100);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        function showConfirm(message, callback) {
            const confirmDiv = document.createElement('div');
            confirmDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: 'Noto Sans Arabic', sans-serif;
            `;
            
            confirmDiv.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; direction: rtl; text-align: center;">
                    <p style="margin-bottom: 20px; font-size: 16px; color: #333;">${message}</p>
                    <div>
                        <button id="confirm-yes" style="background: #4CAF50; color: white; border: none; padding: 12px 25px; border-radius: 8px; margin: 5px; cursor: pointer; font-family: 'Noto Sans Arabic', sans-serif;">ÛØ§Úº</button>
                        <button id="confirm-no" style="background: #f44336; color: white; border: none; padding: 12px 25px; border-radius: 8px; margin: 5px; cursor: pointer; font-family: 'Noto Sans Arabic', sans-serif;">Ù†ÛÛŒÚº</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDiv);
            
            document.getElementById('confirm-yes').onclick = function() {
                document.body.removeChild(confirmDiv);
                callback();
            };
            
            document.getElementById('confirm-no').onclick = function() {
                document.body.removeChild(confirmDiv);
            };
        }

        // =================== GITHUB BACKUP FUNCTIONS ===================
        
        async function setupGitHubBackup() {
            const token = document.getElementById('github-token').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            
            if (!token || !repo) {
                showNotification('Ø¨Ø±Ø§Û Ú©Ø±Ù… GitHub Ù¹ÙˆÚ©Ù† Ø§ÙˆØ± Ø±ÛŒÙ¾ÙˆØ²ÛŒÙ¹Ø±ÛŒ Ú©Ø§ Ù†Ø§Ù… Ø¯Ø§Ø®Ù„ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            updateBackupStatus('ğŸ”§ GitHub Ø³ÛŒÙ¹ Ø§Ù¾ Ú©Ø± Ø±ÛÛ’ ÛÛŒÚº...', 'syncing');
            
            try {
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Milk-Business-App/1.0'
                    }
                });
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    
                    const repoResponse = await fetch(`https://api.github.com/repos/${repo}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                            'User-Agent': 'Milk-Business-App/1.0'
                        }
                    });
                    
                    let repoExists = false;
                    let repoData = null;
                    
                    if (repoResponse.ok) {
                        repoData = await repoResponse.json();
                        repoExists = true;
                    }
                    
                    gitHubSettings.token = token;
                    gitHubSettings.repo = repo;
                    gitHubSettings.username = userData.login;
                    
                    saveToStorage();
                    updateGitHubStatus('âœ… Connected');
                    
                    if (repoExists) {
                        await initializeGitHubStructure();
                        showNotification(`âœ… GitHub Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ú©Ù†Ú©Ù¹!\nUser: ${userData.login}\nRepo: ${repoData.full_name}`, 'success');
                        updateBackupStatus('âœ… GitHub ØªÛŒØ§Ø± - Structure initialized');
                    } else {
                        showNotification(`âš ï¸ GitHub User OK!\nUser: ${userData.login}\nRepo: ${repo} (Ù†ÛÛŒÚº Ù…Ù„ÛŒ)`, 'warning');
                        updateBackupStatus('âš ï¸ GitHub OK - Create repository first');
                    }
                    
                    if (document.getElementById('auto-backup-enabled').checked) {
                        startAutoBackup();
                    }
                } else {
                    throw new Error(`GitHub authentication failed: ${userResponse.status}`);
                }
            } catch (error) {
                console.error('GitHub setup error:', error);
                showNotification('âŒ GitHub Ø³ÛŒÙ¹ Ø§Ù¾ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ: ' + error.message, 'error');
                updateBackupStatus('âŒ GitHub Ø³ÛŒÙ¹ Ø§Ù¾ ÙÛŒÙ„', 'error');
                updateGitHubStatus('âŒ Error');
            }
        }

        async function initializeGitHubStructure() {
            if (!gitHubSettings.token || !gitHubSettings.repo) {
                return;
            }
            
            try {
                const mainReadme = `# ğŸ¥› Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ú©Ø§Ø±ÙˆØ¨Ø§Ø± - Milk Business Data

## Directory Structure

- **ğŸ“ backups/** - JSON backup files
- **ğŸ“ reports/customers/** - Individual customer HTML reports  
- **ğŸ“ reports/all_customers/** - Combined customer reports
- **ğŸ“ reports/business_summary/** - Business analysis reports

## App Info
- Generated by: Milk Business Management App (Fixed Version)
- Version: 6.1
- Created: ${new Date().toLocaleString('ur-PK')}
- Total Customers: ${customers.length}

## Auto-Features
- âœ… HTML reports automatically saved to GitHub
- âœ… Smart entry ID detection and fixing
- âœ… Enhanced month filtering
- âœ… Backup integration

## Usage
All files are automatically generated and organized by the app.
Each customer gets their own folder for reports.
`;
                
                await saveHTMLToGitHub(mainReadme, 'README.md', '');
                
                await createGitHubDirectory('backups');
                await createGitHubDirectory('reports');
                await createGitHubDirectory('reports/customers'); 
                await createGitHubDirectory('reports/all_customers');
                await createGitHubDirectory('reports/business_summary');
                
                console.log('GitHub repository structure initialized');
            } catch (error) {
                console.error('Structure initialization error:', error);
            }
        }

        async function saveHTMLToGitHub(htmlContent, fileName, folderPath = '') {
            if (!gitHubSettings.token || !gitHubSettings.repo) {
                console.warn('GitHub not configured, skipping auto-save');
                return false;
            }
            
            try {
                const fullPath = folderPath ? `${folderPath}/${fileName}` : fileName;
                const content = btoa(unescape(encodeURIComponent(htmlContent)));
                
                let sha = null;
                try {
                    const checkResponse = await fetch(`https://api.github.com/repos/${gitHubSettings.repo}/contents/${fullPath}`, {
                        headers: {
                            'Authorization': `token ${gitHubSettings.token}`,
                            'User-Agent': 'Milk-Business-App/1.0',
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (checkResponse.ok) {
                        const fileData = await checkResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    console.log('File does not exist, creating new file');
                }
                
                const body = {
                    message: `ğŸ“„ HTML Report: ${fileName} - ${new Date().toLocaleString('ur-PK')}`,
                    content: content,
                    committer: {
                        name: "Milk Business App",
                        email: "reports@milkbusiness.app"
                    }
                };
                
                if (sha) {
                    body.sha = sha;
                }
                
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.repo}/contents/${fullPath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Milk-Business-App/1.0',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    const responseData = await response.json();
                    console.log('HTML saved to GitHub:', responseData.content.html_url);
                    return responseData.content.html_url;
                } else {
                    const errorData = await response.json();
                    console.error('GitHub API error:', errorData);
                    throw new Error(errorData.message || 'HTML save failed');
                }
                
            } catch (error) {
                console.error('HTML save error:', error);
                
                // Check if it's a network/CORS error
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    showNotification('GitHub auto-save ÙÛŒÙ„ - Ù†ÛŒÙ¹ ÙˆØ±Ú© Ú©ÛŒ Ø®Ø±Ø§Ø¨ÛŒ (Local save Ù…Ú©Ù…Ù„)', 'warning');
                } else {
                    showNotification('GitHub auto-save Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ: ' + error.message, 'warning');
                }
                return false;
            }
        }

        async function createGitHubDirectory(dirPath) {
            if (!gitHubSettings.token || !gitHubSettings.repo) {
                return false;
            }
            
            try {
                const readmeContent = `# ${dirPath}\n\nGenerated by Milk Business App (Fixed Version)\nCreated: ${new Date().toLocaleString('ur-PK')}`;
                const content = btoa(unescape(encodeURIComponent(readmeContent)));
                
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.repo}/contents/${dirPath}/README.md`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Milk-Business-App/1.0',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `ğŸ“ Create directory: ${dirPath}`,
                        content: content,
                        committer: {
                            name: "Milk Business App",
                            email: "setup@milkbusiness.app"
                        }
                    })
                });
                
                return response.ok;
            } catch (error) {
                console.warn('Directory creation warning:', error.message);
                // Don't show error to user for directory creation as it's not critical
                return false;
            }
        }

        async function manualBackup() {
            if (!gitHubSettings.token || !gitHubSettings.repo) {
                showNotification('Ù¾ÛÙ„Û’ GitHub Ø³ÛŒÙ¹ Ø§Ù¾ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            updateBackupStatus('â˜ï¸ GitHub Ø¨ÛŒÚ© Ø§Ù¾ Ú©Ø± Ø±ÛÛ’ ÛÛŒÚº...', 'syncing');
            
            try {
                const data = {
                    customers: customers,
                    nextId: nextId,
                    backupDate: new Date().toISOString(),
                    version: '6.1',
                    metadata: {
                        totalCustomers: customers.length,
                        totalEntries: customers.reduce((sum, c) => sum + (c.entries ? c.entries.length : 0), 0),
                        appName: 'Milk Business Management (Fixed Version)',
                        backupType: 'manual',
                        fixedFeatures: ['Entry ID detection', 'Month filtering', 'GitHub auto-storage']
                    }
                };
                
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const fileName = `backup_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                const backupPath = `backups/${fileName}`;
                
                // Try to create directory first, but don't fail if it doesn't work
                try {
                    await createGitHubDirectory('backups');
                } catch (e) {
                    console.warn('Could not create backups directory, continuing anyway');
                }
                
                const body = {
                    message: `ğŸ’¾ Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ú©Ø§Ø±ÙˆØ¨Ø§Ø± - Fixed Version Backup ${new Date().toLocaleString('ur-PK')} - ${customers.length} customers`,
                    content: content,
                    committer: {
                        name: "Milk Business App",
                        email: "backup@milkbusiness.app"
                    }
                };
                
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.repo}/contents/${backupPath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Milk-Business-App/1.0',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    const responseData = await response.json();
                    showNotification('âœ… GitHub Ù…ÛŒÚº Ø¨ÛŒÚ© Ø§Ù¾ Ù…Ú©Ù…Ù„!', 'success');
                    updateBackupStatus('âœ… Ø¨ÛŒÚ© Ø§Ù¾ Ú©Ø§Ù…ÛŒØ§Ø¨ - Ø¢Ø®Ø±ÛŒ: ' + new Date().toLocaleTimeString('ur-PK'));
                    updateLastBackupTime();
                    updateBackupCount();
                    console.log('Backup successful:', responseData.content.html_url);
                } else {
                    const errorData = await response.json();
                    console.error('GitHub backup error:', errorData);
                    throw new Error(errorData.message || 'Backup failed');
                }
                
            } catch (error) {
                console.error('Backup error:', error);
                
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    showNotification('âŒ Ù†ÛŒÙ¹ ÙˆØ±Ú© Ú©ÛŒ Ø®Ø±Ø§Ø¨ÛŒ - Ø§Ù†Ù¹Ø±Ù†ÛŒÙ¹ Ú©Ù†Ú©Ø´Ù† Ú†ÛŒÚ© Ú©Ø±ÛŒÚº', 'error');
                    updateBackupStatus('âŒ Ù†ÛŒÙ¹ ÙˆØ±Ú© Ø§ÛŒØ±Ø±', 'error');
                } else {
                    showNotification('âŒ Ø¨ÛŒÚ© Ø§Ù¾ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ: ' + error.message, 'error');
                    updateBackupStatus('âŒ Ø¨ÛŒÚ© Ø§Ù¾ ÙÛŒÙ„', 'error');
                }
            }
        }

        async function restoreFromGitHub() {
            if (!gitHubSettings.token || !gitHubSettings.repo) {
                showNotification('Ù¾ÛÙ„Û’ GitHub Ø³ÛŒÙ¹ Ø§Ù¾ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            showConfirm('Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ GitHub Ø³Û’ ÚˆÛŒÙ¹Ø§ Ø¨Ø­Ø§Ù„ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ Ù…ÙˆØ¬ÙˆØ¯Û ÚˆÛŒÙ¹Ø§ Ø®ØªÙ… ÛÙˆ Ø¬Ø§Ø¦Û’ Ú¯Ø§Û”', async () => {
                updateBackupStatus('â¬‡ï¸ GitHub Ø³Û’ Ø¨Ø­Ø§Ù„ÛŒ...', 'syncing');
                
                try {
                    const response = await fetch(`https://api.github.com/repos/${gitHubSettings.repo}/contents/backups`, {
                        headers: {
                            'Authorization': `token ${gitHubSettings.token}`,
                            'Content-Type': 'application/json',
                            'User-Agent': 'Milk-Business-App/1.0'
                        }
                    });
                    
                    if (response.ok) {
                        const files = await response.json();
                        const backupFiles = files.filter(file => 
                            file.name.startsWith('backup_') && 
                            file.name.endsWith('.json') &&
                            file.type === 'file'
                        );
                        
                        if (backupFiles.length === 0) {
                            throw new Error('Ú©ÙˆØ¦ÛŒ Ø¨ÛŒÚ© Ø§Ù¾ ÙØ§Ø¦Ù„ Ù†ÛÛŒÚº Ù…Ù„ÛŒ');
                        }
                        
                        const latestBackup = backupFiles.sort((a, b) => b.name.localeCompare(a.name))[0];
                        
                        const fileResponse = await fetch(latestBackup.download_url, {
                            headers: {
                                'Authorization': `token ${gitHubSettings.token}`,
                                'User-Agent': 'Milk-Business-App/1.0'
                            }
                        });
                        
                        if (fileResponse.ok) {
                            const backupData = await fileResponse.json();
                            
                            if (!backupData.customers || !Array.isArray(backupData.customers)) {
                                throw new Error('Invalid backup file format');
                            }
                            
                            customers = backupData.customers;
                            nextId = backupData.nextId || 1;
                            
                            // Auto-fix any entries in restored data
                            fixExistingEntries();
                            
                            saveToStorage();
                            loadCustomers();
                            updateDashboard();
                            
                            showNotification(`âœ… Ø¨Ø­Ø§Ù„ÛŒ Ú©Ø§Ù…ÛŒØ§Ø¨! ${latestBackup.name} Ø³Û’ ${customers.length} Ú¯Ø§ÛÚ© Ø¨Ø­Ø§Ù„ ÛÙˆØ¦Û’`, 'success');
                            updateBackupStatus('âœ… Ø¨Ø­Ø§Ù„ÛŒ Ù…Ú©Ù…Ù„ - ' + new Date().toLocaleTimeString('ur-PK'));
                            
                        } else {
                            throw new Error('ÙØ§Ø¦Ù„ ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©ÛŒ: ' + fileResponse.status);
                        }
                    } else {
                        const errorData = await response.json();
                        throw new Error('Ø¨ÛŒÚ© Ø§Ù¾ ÙÙˆÙ„ÚˆØ± ØªÚ© Ø±Ø³Ø§Ø¦ÛŒ Ù†ÛÛŒÚº: ' + errorData.message);
                    }
                    
                } catch (error) {
                    console.error('Restore error:', error);
                    showNotification('âŒ Ø¨Ø­Ø§Ù„ÛŒ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ: ' + error.message, 'error');
                    updateBackupStatus('âŒ Ø¨Ø­Ø§Ù„ÛŒ ÙÛŒÙ„', 'error');
                }
            });
        }

        async function testGitHubConnection() {
            const token = document.getElementById('github-token').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            
            if (!token) {
                showNotification('âš ï¸ Ù¾ÛÙ„Û’ GitHub Ù¹ÙˆÚ©Ù† Ø¯Ø§Ø®Ù„ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            updateBackupStatus('ğŸ”— Ú©Ù†Ú©Ø´Ù† Ù¹ÛŒØ³Ù¹ Ú©Ø± Ø±ÛÛ’ ÛÛŒÚº...', 'syncing');
            
            try {
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Milk-Business-App/1.0'
                    }
                });
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    
                    if (repo) {
                        const repoResponse = await fetch(`https://api.github.com/repos/${repo}`, {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Content-Type': 'application/json',
                                'User-Agent': 'Milk-Business-App/1.0'
                            }
                        });
                        
                        if (repoResponse.ok) {
                            const repoData = await repoResponse.json();
                            showNotification(`âœ… Ù…Ú©Ù…Ù„ Ú©Ù†Ú©Ø´Ù† Ú©Ø§Ù…ÛŒØ§Ø¨!\nUser: ${userData.login}\nRepo: ${repoData.full_name}`, 'success');
                            updateBackupStatus('âœ… GitHub ØªÛŒØ§Ø± - User: ' + userData.login);
                            updateGitHubStatus('âœ… Connected');
                        } else if (repoResponse.status === 404) {
                            showNotification(`âš ï¸ User OK Ù„ÛŒÚ©Ù† Repository Ù†ÛÛŒÚº Ù…Ù„ÛŒ!\nUser: ${userData.login}`, 'warning');
                            updateBackupStatus('âš ï¸ Repository Ù†ÛÛŒÚº Ù…Ù„ÛŒ');
                        }
                    } else {
                        showNotification(`âœ… Token Ú©Ù†Ú©Ø´Ù† Ú©Ø§Ù…ÛŒØ§Ø¨!\nUser: ${userData.login}`, 'success');
                        updateBackupStatus('âœ… Token OK - Repository needed');
                    }
                } else {
                    throw new Error(`Token verification failed: ${userResponse.status}`);
                }
            } catch (error) {
                console.error('Connection test error:', error);
                showNotification('âŒ Ú©Ù†Ú©Ø´Ù† ÙÛŒÙ„: ' + error.message, 'error');
                updateBackupStatus('âŒ Ú©Ù†Ú©Ø´Ù† Ù¹ÛŒØ³Ù¹ ÙÛŒÙ„', 'error');
                updateGitHubStatus('âŒ Error');
            }
        }

        // =================== AUTO BACKUP FUNCTIONS ===================
        
        function initializeBackupSettings() {
            const autoBackupEnabled = document.getElementById('auto-backup-enabled').checked;
            if (autoBackupEnabled && gitHubSettings.token && gitHubSettings.repo) {
                startAutoBackup();
            }
            updateBackupSize();
            
            const hasBuiltInToken = document.getElementById('github-token').value.startsWith('ghp_');
            if (hasBuiltInToken && gitHubSettings.username) {
                updateGitHubStatus('âœ… Connected');
            } else if (hasBuiltInToken) {
                updateGitHubStatus('ğŸš€ Ready to Connect');
            } else {
                updateGitHubStatus('âŒ Setup Needed');
            }
            
            const storedCount = localStorage.getItem('backupCount') || '0';
            const countEl = document.getElementById('backup-count');
            if (countEl) {
                countEl.textContent = storedCount;
            }
        }

        function toggleAutoBackup() {
            const enabled = document.getElementById('auto-backup-enabled').checked;
            if (enabled) {
                if (gitHubSettings.token && gitHubSettings.repo) {
                    startAutoBackup();
                    showNotification('Ø¢Ù¹Ùˆ Ø¨ÛŒÚ© Ø§Ù¾ ÙØ¹Ø§Ù„', 'success');
                } else {
                    showNotification('Ù¾ÛÙ„Û’ GitHub Ø³ÛŒÙ¹ Ø§Ù¾ Ú©Ø±ÛŒÚº', 'error');
                    document.getElementById('auto-backup-enabled').checked = false;
                }
            } else {
                stopAutoBackup();
                showNotification('Ø¢Ù¹Ùˆ Ø¨ÛŒÚ© Ø§Ù¾ Ø¨Ù†Ø¯', 'info');
            }
        }

        function updateBackupInterval() {
            const interval = parseInt(document.getElementById('backup-interval').value);
            if (interval > 0 && document.getElementById('auto-backup-enabled').checked) {
                stopAutoBackup();
                startAutoBackup();
                showNotification(`Ø¨ÛŒÚ© Ø§Ù¾ ÙˆÙ‚ÙÛ: ${interval} Ù…Ù†Ù¹`, 'info');
            }
        }

        function startAutoBackup() {
            stopAutoBackup();
            
            const interval = parseInt(document.getElementById('backup-interval').value);
            if (interval > 0) {
                backupInterval = setInterval(() => {
                    manualBackup();
                }, interval * 60 * 1000);
                
                updateBackupStatus(`â° Ø¢Ù¹Ùˆ Ø¨ÛŒÚ© Ø§Ù¾: ${interval} Ù…Ù†Ù¹`);
            }
        }

        function stopAutoBackup() {
            if (backupInterval) {
                clearInterval(backupInterval);
                backupInterval = null;
            }
        }

        function downloadLocalBackup() {
            try {
                const data = {
                    customers: customers,
                    nextId: nextId,
                    backupDate: new Date().toISOString(),
                    version: '6.1',
                    metadata: {
                        totalCustomers: customers.length,
                        totalEntries: customers.reduce((sum, c) => sum + (c.entries ? c.entries.length : 0), 0),
                        appName: 'Milk Business Management (Fixed Version)',
                        fixedFeatures: ['Entry ID detection', 'Month filtering', 'GitHub auto-storage']
                    }
                };
                
                const content = JSON.stringify(data, null, 2);
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `milk_business_backup_fixed_${new Date().toISOString().split('T')[0]}.json`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('ğŸ“¥ Local backup ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ Ù…Ú©Ù…Ù„!', 'success');
                updateBackupStatus('ğŸ“¥ Local backup ØªÛŒØ§Ø±');
                
            } catch (error) {
                console.error('Local backup error:', error);
                showNotification('âŒ Local backup Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ', 'error');
            }
        }

        function restoreFromFile() {
            const fileInput = document.getElementById('restore-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Ù¾ÛÙ„Û’ ÙØ§Ø¦Ù„ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            
            showConfirm('Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ ÙØ§Ø¦Ù„ Ø³Û’ ÚˆÛŒÙ¹Ø§ Ø¨Ø­Ø§Ù„ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ Ù…ÙˆØ¬ÙˆØ¯Û ÚˆÛŒÙ¹Ø§ Ø®ØªÙ… ÛÙˆ Ø¬Ø§Ø¦Û’ Ú¯Ø§Û”', () => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.customers || !Array.isArray(backupData.customers)) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        customers = backupData.customers;
                        nextId = backupData.nextId || 1;
                        
                        // Auto-fix any entries in restored data
                        fixExistingEntries();
                        
                        saveToStorage();
                        loadCustomers();
                        updateDashboard();
                        
                        showNotification('âœ… ÙØ§Ø¦Ù„ Ø³Û’ Ø¨Ø­Ø§Ù„ÛŒ Ú©Ø§Ù…ÛŒØ§Ø¨!', 'success');
                        updateBackupStatus('âœ… ÙØ§Ø¦Ù„ Ø¨Ø­Ø§Ù„ÛŒ Ù…Ú©Ù…Ù„');
                        
                        fileInput.value = '';
                        
                    } catch (error) {
                        console.error('File restore error:', error);
                        showNotification('âŒ ÙØ§Ø¦Ù„ Ø¨Ø­Ø§Ù„ÛŒ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ: Invalid format', 'error');
                    }
                };
                reader.readAsText(file);
            });
        }

        // =================== BACKUP STATUS FUNCTIONS ===================
        
        function updateBackupStatus(message, type = 'success') {
            const statusEl = document.getElementById('backup-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'backup-status';
                if (type === 'error') statusEl.classList.add('error');
                if (type === 'syncing') statusEl.classList.add('syncing');
            }
        }

        function updateBackupSize() {
            const data = JSON.stringify({ customers, nextId });
            const sizeKB = Math.round(new Blob([data]).size / 1024);
            const sizeEl = document.getElementById('backup-size');
            if (sizeEl) {
                sizeEl.textContent = `${sizeKB} KB`;
            }
        }

        function updateLastBackupTime() {
            const timeEl = document.getElementById('last-backup-time');
            if (timeEl) {
                timeEl.textContent = new Date().toLocaleString('ur-PK');
            }
        }

        function updateGitHubStatus(status) {
            const statusEl = document.getElementById('github-status');
            if (statusEl) {
                statusEl.textContent = status;
            }
        }

        function updateBackupCount() {
            const countEl = document.getElementById('backup-count');
            if (countEl) {
                let count = parseInt(localStorage.getItem('backupCount') || '0');
                count++;
                localStorage.setItem('backupCount', count.toString());
                countEl.textContent = count.toString();
            }
        }

        // =================== LEGAL SIZE HTML GENERATION ===================
        
        function createCustomerLegalSizeHTML(customer) {
            let totalRevenue = 0;
            let totalPayments = 0;
            let deliveryEntries = [];
            let paymentEntries = [];
            let dayOffEntries = [];
            
            if (customer.entries) {
                customer.entries.forEach(entry => {
                    if (entry.type === 'delivery') {
                        const days = calculateDays(entry.fromDate, entry.toDate);
                        const totalLiters = days * entry.liters;
                        const amount = totalLiters * entry.rate;
                        totalRevenue += amount;
                        
                        deliveryEntries.push({
                            ...entry,
                            days: days,
                            totalLiters: totalLiters,
                            amount: amount
                        });
                    } else if (entry.type === 'payment') {
                        totalPayments += parseFloat(entry.amount);
                        paymentEntries.push(entry);
                    } else if (entry.type === 'day-off') {
                        dayOffEntries.push(entry);
                    }
                });
            }
            
            const remaining = totalRevenue - totalPayments;
            
            deliveryEntries.sort((a, b) => new Date(b.fromDate) - new Date(a.fromDate));
            paymentEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
            dayOffEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const html = `<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${customer.name} - Legal Size Ledger (Fixed Version)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans Arabic', 'Segoe UI', Tahoma, sans-serif;
            direction: rtl;
            line-height: 1.5;
            color: #333;
            background: #fff;
            padding: 25px;
            font-size: 16px;
            font-weight: 500;
        }
        
        @page {
            size: legal;
            margin: 0.4in;
        }
        
        .print-header {
            text-align: center;
            border-bottom: 4px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .print-header h1 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 12px;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .print-header h2 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .print-header p {
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }
        
        .print-customer-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-right: 6px solid #667eea;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .info-item {
            background: white;
            padding: 18px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        
        .info-item strong {
            color: #333;
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 700;
        }
        
        .info-item span {
            font-size: 15px;
            font-weight: 600;
        }
        
        .print-summary {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            text-align: center;
        }
        
        .summary-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #2196F3;
        }
        
        .summary-item h3 {
            color: #2196F3;
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 800;
        }
        
        .summary-item p {
            font-size: 14px;
            font-weight: 600;
        }
        
        .print-entries-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .print-entries-table th,
        .print-entries-table td {
            border: 2px solid #333;
            padding: 12px;
            text-align: right;
            vertical-align: top;
        }
        
        .print-entries-table th {
            background: #333;
            color: white;
            font-weight: 800;
            font-size: 15px;
        }
        
        .print-entries-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .print-entries-table td {
            font-weight: 600;
        }
        
        .section-title {
            color: #333;
            font-size: 20px;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 3px solid #667eea;
            font-weight: 800;
        }
        
        .amount-positive { 
            color: #4CAF50; 
            font-weight: 800;
            font-size: 15px;
        }
        .amount-negative { 
            color: #f44336; 
            font-weight: 800;
            font-size: 15px;
        }
        .amount-neutral { 
            color: #2196F3; 
            font-weight: 800;
            font-size: 15px;
        }
        
        .final-summary {
            background: #e8f5e8;
            border: 3px solid #4CAF50;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            text-align: center;
        }
        
        .final-summary h3 {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 22px;
            font-weight: 800;
        }
        
        .final-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .final-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #4CAF50;
        }
        
        .final-item h4 {
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 700;
        }
        
        .final-item .value {
            font-size: 22px;
            font-weight: 800;
            color: #1b5e20;
        }
        
        .print-footer {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            text-align: center;
            color: #666;
            border-top: 2px solid #e0e0e0;
            padding-top: 12px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .version-info {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Extra bold for important values */
        .super-bold {
            font-weight: 900 !important;
            font-size: 16px;
        }
        
        /* Enhanced table styling for better print readability */
        .print-entries-table td.amount-cell {
            font-weight: 800;
            font-size: 15px;
            background: #f0f8ff;
        }
        
        .print-entries-table td.date-cell {
            font-weight: 700;
            font-size: 14px;
        }
        
        .print-entries-table td.quantity-cell {
            font-weight: 700;
            font-size: 14px;
            text-align: center;
        }
        
        @media print {
            body { 
                padding: 0; 
                background: white;
                font-size: 16px;
                font-weight: 500;
            }
            .no-print {
                display: none !important;
            }
            
            /* Ensure fonts are bold enough for print */
            .print-entries-table {
                font-size: 14px;
                font-weight: 600;
            }
            
            .print-entries-table th {
                font-weight: 900;
                font-size: 15px;
            }
            
            .print-entries-table td {
                font-weight: 600;
            }
        }
    </style>
</head>
<body>
    <div class="version-info">
        <strong>ğŸ“‹ Fixed Version Report:</strong> Entry ID detection âœ… | Month filtering âœ… | GitHub auto-storage âœ…
    </div>

    <div class="print-header">
        <h1>ğŸ¥› Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ú©Ø§Ø±ÙˆØ¨Ø§Ø±</h1>
        <h2>${customer.name} - Ù…Ú©Ù…Ù„ Ú©Ú¾Ø§ØªÛ (Legal Size)</h2>
        <p>ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('ur-PK')} | ÙˆÙ‚Øª: ${new Date().toLocaleTimeString('ur-PK')}</p>
    </div>

    <div class="print-customer-info">
        <div class="info-item">
            <strong>Ù†Ø§Ù…:</strong>
            <span class="super-bold">${customer.name}</span>
        </div>
        <div class="info-item">
            <strong>ÙÙˆÙ† Ù†Ù…Ø¨Ø±:</strong>
            <span class="super-bold">${customer.phone || 'ÙØ±Ø§ÛÙ… Ù†ÛÛŒÚº'}</span>
        </div>
        ${customer.address ? `
        <div class="info-item">
            <strong>Ù¾ØªÛ:</strong>
            <span class="super-bold">${customer.address}</span>
        </div>
        ` : ''}
        <div class="info-item">
            <strong>Ú©Ù„ Ø§Ù†Ù¹Ø±ÛŒØ²:</strong>
            <span class="super-bold">${customer.entries ? customer.entries.length : 0}</span>
        </div>
    </div>

    <div class="print-summary">
        <div class="summary-item">
            <h3>${totalRevenue.toLocaleString('ur-PK')}</h3>
            <p><strong>Ú©Ù„ Ø¨Ù„ (Ø±ÙˆÙ¾Û’)</strong></p>
        </div>
        <div class="summary-item">
            <h3>${totalPayments.toLocaleString('ur-PK')}</h3>
            <p><strong>Ø§Ø¯Ø§ Ø´Ø¯Û (Ø±ÙˆÙ¾Û’)</strong></p>
        </div>
        <div class="summary-item">
            <h3 class="${remaining > 0 ? 'amount-negative' : remaining < 0 ? 'amount-positive' : 'amount-neutral'}">${remaining.toLocaleString('ur-PK')}</h3>
            <p><strong>Ø¨Ø§Ù‚ÛŒ Ø±Ù‚Ù… (Ø±ÙˆÙ¾Û’)</strong></p>
        </div>
        <div class="summary-item">
            <h3>${deliveryEntries.length}</h3>
            <p><strong>ÙØ±Ø§ÛÙ…ÛŒ Ø§Ù†Ù¹Ø±ÛŒØ²</strong></p>
        </div>
    </div>

    ${deliveryEntries.length > 0 ? `
    <div class="section-title">ğŸ¥› Ø¯ÙˆØ¯Ú¾ Ú©ÛŒ ÙØ±Ø§ÛÙ…ÛŒ</div>
    <table class="print-entries-table">
        <thead>
            <tr>
                <th>Ø´Ø±ÙˆØ¹</th>
                <th>Ø§Ø®ØªØªØ§Ù…</th>
                <th>Ø¯Ù†</th>
                <th>Ù„ÛŒÙ¹Ø±/Ø¯Ù†</th>
                <th>Ú©Ù„ Ù„ÛŒÙ¹Ø±</th>
                <th>Ø±ÛŒÙ¹</th>
                <th>Ú©Ù„ Ø±Ù‚Ù…</th>
                <th>ØªØ¨ØµØ±Û</th>
            </tr>
        </thead>
        <tbody>
            ${deliveryEntries.map(entry => `
                <tr>
                    <td class="date-cell">${formatDate(entry.fromDate)}</td>
                    <td class="date-cell">${formatDate(entry.toDate)}</td>
                    <td class="quantity-cell super-bold">${entry.days}</td>
                    <td class="quantity-cell super-bold">${entry.liters}</td>
                    <td class="quantity-cell super-bold">${entry.totalLiters}</td>
                    <td class="quantity-cell super-bold">${entry.rate}</td>
                    <td class="amount-cell amount-positive">${entry.amount.toLocaleString('ur-PK')}</td>
                    <td>${entry.note || '-'}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    ` : ''}

    ${paymentEntries.length > 0 ? `
    <div class="section-title">ğŸ’° Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª</div>
    <table class="print-entries-table">
        <thead>
            <tr>
                <th>ØªØ§Ø±ÛŒØ®</th>
                <th>Ø±Ù‚Ù…</th>
                <th>ØªØ¨ØµØ±Û</th>
            </tr>
        </thead>
        <tbody>
            ${paymentEntries.map(entry => `
                <tr>
                    <td class="date-cell">${formatDate(entry.date)}</td>
                    <td class="amount-cell amount-positive">${parseFloat(entry.amount).toLocaleString('ur-PK')} Ø±ÙˆÙ¾Û’</td>
                    <td class="super-bold">${entry.note || '-'}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    ` : ''}

    ${dayOffEntries.length > 0 ? `
    <div class="section-title">ğŸš« Ú†Ú¾Ù¹ÛŒ Ú©Û’ Ø¯Ù†</div>
    <table class="print-entries-table">
        <thead>
            <tr>
                <th>ØªØ§Ø±ÛŒØ®</th>
                <th>ÙˆØ¬Û</th>
            </tr>
        </thead>
        <tbody>
            ${dayOffEntries.map(entry => `
                <tr>
                    <td class="date-cell">${formatDate(entry.date)}</td>
                    <td class="super-bold">${entry.reason || '-'}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    ` : ''}

    <div class="final-summary">
        <h3>ğŸ“Š Ø­ØªÙ…ÛŒ Ø®Ù„Ø§ØµÛ</h3>
        <div class="final-grid">
            <div class="final-item">
                <h4>Ú©Ù„ Ø¨Ù„</h4>
                <div class="value">${totalRevenue.toLocaleString('ur-PK')} Ø±ÙˆÙ¾Û’</div>
            </div>
            <div class="final-item">
                <h4>Ø§Ø¯Ø§ Ø´Ø¯Û</h4>
                <div class="value">${totalPayments.toLocaleString('ur-PK')} Ø±ÙˆÙ¾Û’</div>
            </div>
            <div class="final-item">
                <h4>Ø¨Ø§Ù‚ÛŒ</h4>
                <div class="value" style="color: ${remaining > 0 ? '#d32f2f' : '#1b5e20'}">${remaining.toLocaleString('ur-PK')} Ø±ÙˆÙ¾Û’</div>
            </div>
        </div>
    </div>

    <div class="print-footer">
        <p><strong>Legal Size Report (Fixed Version) | ${customer.name} | Generated: ${new Date().toLocaleDateString('ur-PK')} ${new Date().toLocaleTimeString('ur-PK')}</strong></p>
        <p><strong>Perfect Urdu Legal Size Printing - Auto-saved to GitHub</strong></p>
    </div>
</body>
</html>`;
            
            return html;
        }

        function createAllCustomersLegalSizeHTML() {
            const html = `<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Customers - Legal Size Report (Fixed Version)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700;800;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans Arabic', 'Segoe UI', Tahoma, sans-serif;
            direction: rtl;
            line-height: 1.5;
            color: #333;
            background: #fff;
            padding: 25px;
            font-size: 16px;
            font-weight: 500;
        }
        
        @page { 
            size: legal; 
            margin: 0.4in; 
        }
        
        .version-info {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .print-header {
            text-align: center;
            border-bottom: 4px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .print-header h1 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 12px;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .print-header h2 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .print-header p {
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }
        
        .print-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            text-align: center;
        }
        
        .summary-item {
            background: white;
            padding: 18px;
            border-radius: 8px;
            border: 3px solid #667eea;
        }
        
        .summary-item h3 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 800;
        }
        
        .summary-item p {
            font-size: 14px;
            font-weight: 700;
        }
        
        .customers-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            font-weight: 600;
        }
        
        .customers-table th,
        .customers-table td {
            border: 2px solid #333;
            padding: 12px;
            text-align: right;
        }
        
        .customers-table th {
            background: #333;
            color: white;
            font-weight: 800;
            font-size: 15px;
        }
        
        .customers-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .customers-table td {
            font-weight: 600;
        }
        
        .customers-table td.customer-name {
            font-weight: 800;
            font-size: 15px;
            color: #333;
        }
        
        .customers-table td.phone-cell {
            font-weight: 700;
            font-size: 13px;
        }
        
        .customers-table td.amount-cell {
            font-weight: 800;
            font-size: 14px;
            text-align: center;
        }
        
        .amount-positive { 
            color: #4CAF50; 
            font-weight: 800;
        }
        .amount-negative { 
            color: #f44336; 
            font-weight: 800;
        }
        .amount-neutral { 
            color: #2196F3; 
            font-weight: 800;
        }
        
        .print-footer {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            text-align: center;
            color: #666;
            border-top: 2px solid #e0e0e0;
            padding-top: 12px;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Enhanced styling for important numbers */
        .super-bold {
            font-weight: 900 !important;
            font-size: 16px;
        }
        
        @media print {
            body { 
                padding: 0; 
                background: white;
                font-size: 16px;
                font-weight: 500;
            }
            
            .customers-table {
                font-size: 14px;
                font-weight: 600;
            }
            
            .customers-table th {
                font-weight: 900;
                font-size: 15px;
            }
            
            .customers-table td {
                font-weight: 600;
            }
        }
    </style>
</head>
<body>
    <div class="version-info">
        <strong>ğŸ“‹ Fixed Version Report:</strong> Entry ID detection âœ… | Month filtering âœ… | GitHub auto-storage âœ…
    </div>

    <div class="print-header">
        <h1>ğŸ¥› Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ú©Ø§Ø±ÙˆØ¨Ø§Ø±</h1>
        <h2>ØªÙ…Ø§Ù… Ú¯Ø§ÛÚ©ÙˆÚº Ú©ÛŒ Ù…Ú©Ù…Ù„ Ø±Ù¾ÙˆØ±Ù¹ (Legal Size)</h2>
        <p>ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('ur-PK')} | ÙˆÙ‚Øª: ${new Date().toLocaleTimeString('ur-PK')}</p>
    </div>

    ${(() => {
        let totalCustomers = customers.length;
        let totalRevenue = 0;
        let totalPayments = 0;
        let totalDeliveries = 0;
        
        customers.forEach(customer => {
            if (customer.entries) {
                customer.entries.forEach(entry => {
                    if (entry.type === 'delivery') {
                        const days = calculateDays(entry.fromDate, entry.toDate);
                        totalRevenue += days * entry.liters * entry.rate;
                        totalDeliveries++;
                    } else if (entry.type === 'payment') {
                        totalPayments += parseFloat(entry.amount);
                    }
                });
            }
        });
        
        const totalPending = totalRevenue - totalPayments;
        
        return `
        <div class="print-summary">
            <div class="summary-item">
                <h3>${totalCustomers}</h3>
                <p><strong>Ú©Ù„ Ú¯Ø§ÛÚ©</strong></p>
            </div>
            <div class="summary-item">
                <h3>${totalRevenue.toLocaleString('ur-PK')}</h3>
                <p><strong>Ú©Ù„ Ø¢Ù…Ø¯Ù†ÛŒ</strong></p>
            </div>
            <div class="summary-item">
                <h3>${totalPayments.toLocaleString('ur-PK')}</h3>
                <p><strong>ÙˆØµÙˆÙ„ Ø´Ø¯Û</strong></p>
            </div>
            <div class="summary-item">
                <h3>${totalPending.toLocaleString('ur-PK')}</h3>
                <p><strong>Ø¨Ø§Ù‚ÛŒ Ø±Ù‚Ù…</strong></p>
            </div>
        </div>
        `;
    })()}

    <table class="customers-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Ù†Ø§Ù…</th>
                <th>ÙÙˆÙ†</th>
                <th>Ú©Ù„ Ø¨Ù„</th>
                <th>Ø§Ø¯Ø§ Ø´Ø¯Û</th>
                <th>Ø¨Ø§Ù‚ÛŒ</th>
                <th>Ø§Ù†Ù¹Ø±ÛŒØ²</th>
            </tr>
        </thead>
        <tbody>
            ${customers.map((customer, index) => {
                let customerRevenue = 0;
                let customerPayments = 0;
                let entryCount = 0;
                
                if (customer.entries) {
                    customer.entries.forEach(entry => {
                        entryCount++;
                        if (entry.type === 'delivery') {
                            const days = calculateDays(entry.fromDate, entry.toDate);
                            customerRevenue += days * entry.liters * entry.rate;
                        } else if (entry.type === 'payment') {
                            customerPayments += parseFloat(entry.amount);
                        }
                    });
                }
                
                const customerRemaining = customerRevenue - customerPayments;
                const statusClass = customerRemaining > 0 ? 'amount-negative' : customerRemaining < 0 ? 'amount-positive' : 'amount-neutral';
                
                return `
                    <tr>
                        <td class="amount-cell super-bold">${index + 1}</td>
                        <td class="customer-name">${customer.name}</td>
                        <td class="phone-cell">${customer.phone || '-'}</td>
                        <td class="amount-cell amount-neutral">${customerRevenue.toLocaleString('ur-PK')}</td>
                        <td class="amount-cell amount-positive">${customerPayments.toLocaleString('ur-PK')}</td>
                        <td class="amount-cell ${statusClass}">${customerRemaining.toLocaleString('ur-PK')}</td>
                        <td class="amount-cell super-bold">${entryCount}</td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    </table>

    <div class="print-footer">
        <p><strong>All Customers Legal Size Report (Fixed Version) | Generated: ${new Date().toLocaleDateString('ur-PK')} ${new Date().toLocaleTimeString('ur-PK')}</strong></p>
        <p><strong>Perfect Urdu Legal Size Printing - Auto-saved to GitHub</strong></p>
    </div>
</body>
</html>`;
            
            return html;
        }

        function createBusinessSummaryLegalSizeHTML() {
            const html = `<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Summary - Legal Size (Fixed Version)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700;800;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            direction: rtl;
            line-height: 1.5;
            color: #333;
            background: #fff;
            padding: 25px;
            font-size: 16px;
            font-weight: 500;
        }
        
        @page { 
            size: legal; 
            margin: 0.4in; 
        }
        
        .version-info {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .print-header {
            text-align: center;
            border-bottom: 4px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .print-header h1 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 12px;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .print-header h2 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .print-header p {
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }
        
        .summary-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
            border: 3px solid #667eea;
        }
        
        .summary-section h3 {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: 800;
            color: #667eea;
        }
        
        .summary-section p {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #667eea;
            text-align: center;
        }
        
        .stat-item h4 {
            color: #667eea;
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .stat-item .value {
            font-size: 28px;
            font-weight: 900;
            color: #333;
        }
        
        @media print {
            body { 
                padding: 0; 
                background: white;
                font-size: 16px;
                font-weight: 500;
            }
        }
    </style>
</head>
<body>
    <div class="version-info">
        <strong>ğŸ“‹ Fixed Version Report:</strong> Entry ID detection âœ… | Month filtering âœ… | GitHub auto-storage âœ…
    </div>

    <div class="print-header">
        <h1>ğŸ¥› Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ú©Ø§Ø±ÙˆØ¨Ø§Ø±</h1>
        <h2>Ú©Ø§Ø±ÙˆØ¨Ø§Ø±ÛŒ Ø®Ù„Ø§ØµÛ (Legal Size)</h2>
        <p>ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('ur-PK')}</p>
    </div>

    <div class="summary-section">
        <h3>ğŸ“Š Ú©Ø§Ø±ÙˆØ¨Ø§Ø±ÛŒ ØªØ¬Ø²ÛŒÛ</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <h4>Ú©Ù„ Ú¯Ø§ÛÚ©</h4>
                <div class="value">${customers.length}</div>
            </div>
            <div class="stat-item">
                <h4>Ú©Ù„ Ø§Ù†Ù¹Ø±ÛŒØ²</h4>
                <div class="value">${customers.reduce((sum, c) => sum + (c.entries ? c.entries.length : 0), 0)}</div>
            </div>
        </div>
        <p><strong>Report generated for legal size printing (8.5" x 14")</strong></p>
        <p><strong>All features working: Entry management, Month filtering, GitHub integration</strong></p>
        <p><strong>Perfect fonts and formatting for clear printing</strong></p>
    </div>
</body>
</html>`;
            
            return html;
        }

        function downloadHTMLFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // =================== WHATSAPP FUNCTIONS ===================
        
        function sendWhatsApp(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('Ú¯Ø§ÛÚ© Ù†ÛÛŒÚº Ù…Ù„Ø§', 'error');
                return;
            }
            
            const message = generateWhatsAppMessage(customer);
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
            showNotification(`${customer.name} Ú©Ø§ Ú©Ú¾Ø§ØªÛ WhatsApp Ú©Û’ Ù„ÛŒÛ’ ØªÛŒØ§Ø±!`, 'success');
        }

        function sendCurrentCustomerWhatsApp() {
            if (!currentCustomerId) {
                showNotification('Ù¾ÛÙ„Û’ Ú¯Ø§ÛÚ© Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº', 'error');
                return;
            }
            sendWhatsApp(currentCustomerId);
        }

        function generateWhatsAppMessage(customer) {
            const selectedMonth = currentCustomerId ? document.getElementById('month-filter')?.value || 'all' : 'all';
            const monthName = selectedMonth === 'all' ? 'Ù…Ú©Ù…Ù„ Ú©Ú¾Ø§ØªÛ' : getMonthDisplayName(selectedMonth);
            
            let message = `ğŸ¥› *Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ú©Ø§Ø±ÙˆØ¨Ø§Ø±*\n`;
            message += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
            message += `ğŸ‘¤ *Ú¯Ø§ÛÚ© Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª:*\n`;
            message += `ğŸ“ Ù†Ø§Ù…: ${customer.name}\n`;
            if (customer.phone) {
                message += `ğŸ“± ÙÙˆÙ†: ${customer.phone}\n`;
            }
            if (customer.address) {
                message += `ğŸ  Ù¾ØªÛ: ${customer.address}\n`;
            }
            message += `ğŸ“… Ø±Ù¾ÙˆØ±Ù¹ Ú©ÛŒ ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('ur-PK')}\n`;
            message += `â° ÙˆÙ‚Øª: ${new Date().toLocaleTimeString('ur-PK')}\n\n`;
            message += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;

            let totalRevenue = 0;
            let totalPayments = 0;
            let deliveryEntries = [];
            let paymentEntries = [];
            let dayOffEntries = [];
            
            if (customer.entries) {
                customer.entries.forEach(entry => {
                    if (selectedMonth !== 'all' && !isEntryInMonth(entry, selectedMonth)) {
                        return;
                    }
                    
                    if (entry.type === 'delivery') {
                        const days = calculateDays(entry.fromDate, entry.toDate);
                        const totalLiters = days * entry.liters;
                        const amount = totalLiters * entry.rate;
                        totalRevenue += amount;
                        
                        deliveryEntries.push({
                            ...entry,
                            days: days,
                            totalLiters: totalLiters,
                            amount: amount
                        });
                    } else if (entry.type === 'payment') {
                        totalPayments += parseFloat(entry.amount);
                        paymentEntries.push(entry);
                    } else if (entry.type === 'day-off') {
                        dayOffEntries.push(entry);
                    }
                });
            }
            
            const previousBalance = selectedMonth !== 'all' ? calculatePreviousMonthBalance(customer.id, selectedMonth) : 0;
            const currentMonthBalance = totalRevenue - totalPayments;
            const overallBalance = previousBalance + currentMonthBalance;

            message += `ğŸ’° *Ù…Ø§Ù„ÛŒ Ø®Ù„Ø§ØµÛ (${monthName}):*\n`;
            message += `â–«ï¸ `;
            if (previousBalance !== 0) {
                message += `Ù¾Ú†Ú¾Ù„Ø§ Ø¨ÛŒÙ„Ù†Ø³: ${previousBalance.toLocaleString('ur-PK')} Ø±ÙˆÙ¾Û’\nâ–«ï¸ `;
            }
            message += `${selectedMonth === 'all' ? 'Ú©Ù„' : 'Ø§Ø³ Ù…ÛÛŒÙ†Û’ Ú©Ø§'} Ø¨Ù„: ${totalRevenue.toLocaleString('ur-PK')} Ø±ÙˆÙ¾Û’\n`;
            message += `â–«ï¸ Ø§Ø¯Ø§ Ø´Ø¯Û Ø±Ù‚Ù…: ${totalPayments.toLocaleString('ur-PK')} Ø±ÙˆÙ¾Û’\n`;
            message += `â–«ï¸ Ø¨Ø§Ù‚ÛŒ Ø±Ù‚Ù…: ${overallBalance.toLocaleString('ur-PK')} Ø±ÙˆÙ¾Û’\n`;
            message += `â–«ï¸ Ú©Ù„ Ø§Ù†Ù¹Ø±ÛŒØ²: ${deliveryEntries.length} ÙØ±Ø§ÛÙ…ÛŒØŒ ${paymentEntries.length} Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ\n\n`;

            if (deliveryEntries.length > 0) {
                message += `ğŸ¥› *Ø¯ÙˆØ¯Ú¾ Ú©ÛŒ ÙØ±Ø§ÛÙ…ÛŒ Ú©ÛŒ ØªÙØµÛŒÙ„:*\n`;
                message += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                deliveryEntries.sort((a, b) => new Date(b.fromDate) - new Date(a.fromDate));
                deliveryEntries.slice(0, 5).forEach((entry, index) => {
                    message += `${index + 1}ï¸âƒ£ *${formatDate(entry.fromDate)}* Ø³Û’ *${formatDate(entry.toDate)}*\n`;
                    message += `   ğŸ—“ï¸ Ú©Ù„ Ø¯Ù†: ${entry.days}\n`;
                    message += `   ğŸ¥› Ø±ÙˆØ²Ø§Ù†Û: ${entry.liters} Ù„ÛŒÙ¹Ø±\n`;
                    message += `   ğŸ“Š Ú©Ù„ Ù„ÛŒÙ¹Ø±: ${entry.totalLiters}\n`;
                    message += `   ğŸ’µ Ø±ÛŒÙ¹: ${entry.rate} Ø±ÙˆÙ¾Û’ ÙÛŒ Ù„ÛŒÙ¹Ø±\n`;
                    message += `   ğŸ’° *Ú©Ù„ Ø±Ù‚Ù…: ${entry.amount.toLocaleString('ur-PK')} Ø±ÙˆÙ¾Û’*\n`;
                    if (entry.note) {
                        message += `   ğŸ“ Ù†ÙˆÙ¹: ${entry.note}\n`;
                    }
                    message += `\n`;
                });
                if (deliveryEntries.length > 5) {
                    message += `... Ø§ÙˆØ± ${deliveryEntries.length - 5} Ù…Ø²ÛŒØ¯ ÙØ±Ø§ÛÙ…ÛŒ Ø§Ù†Ù¹Ø±ÛŒØ²\n\n`;
                }
            }

            if (paymentEntries.length > 0) {
                message += `ğŸ’³ *Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©ÛŒ ØªÙØµÛŒÙ„:*\n`;
                message += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                paymentEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
                paymentEntries.slice(0, 5).forEach((entry, index) => {
                    message += `${index + 1}ï¸âƒ£ *${formatDate(entry.date)}*\n`;
                    message += `   ğŸ’° Ø±Ù‚Ù…: ${parseFloat(entry.amount).toLocaleString('ur-PK')} Ø±ÙˆÙ¾Û’\n`;
                    if (entry.note) {
                        message += `   ğŸ“ Ù†ÙˆÙ¹: ${entry.note}\n`;
                    }
                    message += `\n`;
                });
                if (paymentEntries.length > 5) {
                    message += `... Ø§ÙˆØ± ${paymentEntries.length - 5} Ù…Ø²ÛŒØ¯ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒØ§Úº\n\n`;
                }
            }

            if (dayOffEntries.length > 0) {
                message += `ğŸš« *Ú†Ú¾Ù¹ÛŒ Ú©Û’ Ø¯Ù†:*\n`;
                message += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                dayOffEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
                dayOffEntries.slice(0, 3).forEach((entry, index) => {
                    message += `${index + 1}ï¸âƒ£ ${formatDate(entry.date)}\n`;
                    message += `   ğŸ“ ÙˆØ¬Û: ${entry.reason || 'Ú©ÙˆØ¦ÛŒ ÙˆØ¬Û Ù†ÛÛŒÚº'}\n\n`;
                });
                if (dayOffEntries.length > 3) {
                    message += `... Ø§ÙˆØ± ${dayOffEntries.length - 3} Ù…Ø²ÛŒØ¯ Ú†Ú¾Ù¹ÛŒØ§Úº\n\n`;
                }
            }

            message += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
            message += `ğŸª *Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ú©Ø§Ø±ÙˆØ¨Ø§Ø±*\n`;
            message += `ğŸ“± Ø§ÛŒÙ¾ Ø³Û’ ØªÛŒØ§Ø± Ø´Ø¯Û Ø±Ù¾ÙˆØ±Ù¹\n`;
            message += `ğŸ• ${new Date().toLocaleString('ur-PK')}\n`;
            message += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
            message += `\n*Ø´Ú©Ø±ÛŒÛ Ø¢Ù¾ Ú©Û’ Ø§Ø¹ØªÙ…Ø§Ø¯ Ú©Ø§* ğŸ™`;

            return message;
        }

        // =================== SAMPLE DATA ===================

        function addSampleData() {
            if (customers.length > 0) {
                showConfirm('Ú©ÛŒØ§ Ø¢Ù¾ sample data Ø´Ø§Ù…Ù„ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ (Ù…ÙˆØ¬ÙˆØ¯Û ÚˆÛŒÙ¹Ø§ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø±ÛÛ’ Ú¯Ø§)', () => {
                    createSampleData();
                });
            } else {
                createSampleData();
            }
        }

        function createSampleData() {
            const sampleCustomers = [
                {
                    id: nextId++,
                    name: 'Ø§Ø­Ù…Ø¯ Ø¹Ù„ÛŒ',
                    phone: '03001234567',
                    address: 'Ú¯Ù„ÛŒ Ù†Ù…Ø¨Ø± 5ØŒ Ù…Ø­Ù„Û Ø´Ø§Û Ù¾ÙˆØ±',
                    createdAt: new Date('2025-01-01').toISOString(),
                    entries: [
                        {
                            id: Date.now() + 1,
                            type: 'delivery',
                            fromDate: '2025-01-01',
                            toDate: '2025-01-31',
                            liters: 2,
                            rate: 120,
                            note: 'ØµØ¨Ø­ Ø´Ø§Ù… Ø¯ÙˆØ¯Ú¾',
                            month: '2025-01',
                            createdAt: new Date('2025-01-01').toISOString()
                        },
                        {
                            id: Date.now() + 2,
                            type: 'payment',
                            date: '2025-01-15',
                            amount: 3000,
                            note: 'Ù¾ÛÙ„ÛŒ Ù‚Ø³Ø·',
                            month: '2025-01',
                            createdAt: new Date('2025-01-15').toISOString()
                        },
                        {
                            id: Date.now() + 3,
                            type: 'delivery',
                            fromDate: '2025-02-01',
                            toDate: '2025-02-28',
                            liters: 2.5,
                            rate: 125,
                            note: 'ÙØ±ÙˆØ±ÛŒ Ú©Ø§ Ø¯ÙˆØ¯Ú¾',
                            month: '2025-02',
                            createdAt: new Date('2025-02-01').toISOString()
                        }
                    ]
                },
                {
                    id: nextId++,
                    name: 'ÙØ§Ø·Ù…Û Ø®Ø§Ù†',
                    phone: '03009876543',
                    address: 'Ú©ÙˆÙ¹ Ù„Ú©Ú¾Ù¾ØªØŒ Ù„Ø§ÛÙˆØ±',
                    createdAt: new Date('2025-01-15').toISOString(),
                    entries: [
                        {
                            id: Date.now() + 4,
                            type: 'delivery',
                            fromDate: '2025-01-15',
                            toDate: '2025-02-14',
                            liters: 1.5,
                            rate: 115,
                            note: 'ØµØ±Ù ØµØ¨Ø­',
                            month: '2025-01',
                            createdAt: new Date('2025-01-15').toISOString()
                        },
                        {
                            id: Date.now() + 5,
                            type: 'payment',
                            date: '2025-02-01',
                            amount: 2500,
                            note: 'Ù…Ú©Ù…Ù„ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ',
                            month: '2025-02',
                            createdAt: new Date('2025-02-01').toISOString()
                        },
                        {
                            id: Date.now() + 6,
                            type: 'day-off',
                            date: '2025-02-10',
                            reason: 'Ø´Ø§Ø¯ÛŒ Ú©ÛŒ ØªÙ‚Ø±ÛŒØ¨',
                            month: '2025-02',
                            createdAt: new Date('2025-02-10').toISOString()
                        }
                    ]
                },
                {
                    id: nextId++,
                    name: 'Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†',
                    phone: '03005555555',
                    address: 'Ù…Ø§Ù„ Ø±ÙˆÚˆØŒ Ú©ÛŒÙ†Ù¹',
                    createdAt: new Date('2025-02-01').toISOString(),
                    entries: [
                        {
                            id: Date.now() + 7,
                            type: 'delivery',
                            fromDate: '2025-02-01',
                            toDate: '2025-02-28',
                            liters: 3,
                            rate: 125,
                            note: 'Ø¨Ú¾ÛŒÙ†Ø³ Ú©Ø§ Ø¯ÙˆØ¯Ú¾',
                            month: '2025-02',
                            createdAt: new Date('2025-02-01').toISOString()
                        },
                        {
                            id: Date.now() + 8,
                            type: 'day-off',
                            date: '2025-02-15',
                            reason: 'Ø¹ÛŒØ¯ Ú©ÛŒ Ú†Ú¾Ù¹ÛŒ',
                            month: '2025-02',
                            createdAt: new Date('2025-02-15').toISOString()
                        }
                    ]
                }
            ];

            customers.push(...sampleCustomers);
            saveToStorage();
            loadCustomers();
            updateDashboard();
            
            showNotification('Sample data Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø´Ø§Ù…Ù„ ÛÙˆ Ú¯ÛŒØ§! Ø§Ø¨ Ø¢Ù¾ Legal Size printing Ø§ÙˆØ± GitHub auto-storage test Ú©Ø± Ø³Ú©ØªÛ’ ÛÛŒÚº', 'success');
        }

        async function generateLegalSizeLedger() {
            if (customers.length === 0) {
                showNotification('Ù¾ÛÙ„Û’ sample data Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº', 'warning');
                return;
            }
            
            await generateCustomerLegalSize(customers[0].id);
        }

        // =================== EVENT LISTENERS ===================

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        if (!document.querySelector('.modal').style.display || document.querySelector('.modal').style.display === 'none') {
                            showAddCustomerModal();
                        }
                        break;
                    case 'p':
                        e.preventDefault();
                        if (currentCustomerId) {
                            generateCurrentCustomerLegalSize();
                        } else {
                            generateAllCustomersLegalSize();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        saveToStorage();
                        showNotification('ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯ÛŒØ§!', 'success');
                        break;
                }
            }
        });

        // Auto-save every 30 seconds
        setInterval(() => {
            saveToStorage();
        }, 30000);

    </script>
</body>
</html>
