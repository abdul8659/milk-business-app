<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دودھ کا کاروبار - Complete Online Business Solution</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 14px;
            font-weight: 500;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.18);
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .hidden {
            display: none !important;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .dashboard-card .number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            direction: rtl;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-info {
            background: #17a2b8;
        }

        /* Customer List */
        .customers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .customer-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .customer-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .customer-card h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1.2em;
        }

        .customer-card p {
            color: #666;
            margin-bottom: 4px;
        }

        .payment-status {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-paid {
            background: linear-gradient(135deg, #d4edda 0%, #c8e6c9 100%);
            color: #155724;
        }

        .status-pending {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            color: #856404;
        }

        .status-overdue {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Ledger Styles */
        .ledger-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .entries-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .entries-table th,
        .entries-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .entries-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-weight: 600;
            color: #333;
        }

        .entries-table tr:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .bill-summary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .bill-summary h3 {
            margin-bottom: 15px;
        }

        .bill-summary .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .bill-summary .summary-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
        }

        .bill-summary .summary-item .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .bill-summary .summary-item .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        /* Payment Status Section */
        .payment-status-section {
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .payment-status-section h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .payment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .payment-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .payment-item .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .payment-item .value {
            font-size: 1.5em;
            font-weight: bold;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .action-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .edit-btn {
            color: #007bff;
            background: rgba(0,123,255,0.1);
        }

        .delete-btn {
            color: #dc3545;
            background: rgba(220,53,69,0.1);
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-controls label {
            font-weight: 500;
        }

        .filter-controls select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            direction: rtl;
        }

        /* PDF Preview Styles */
        .pdf-preview {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            font-family: 'Arial', sans-serif;
            direction: rtl;
            border: 2px solid #e0e0e0;
        }

        .pdf-header {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: -30px -30px 30px -30px;
            position: relative;
            overflow: hidden;
        }

        .pdf-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .pdf-header h1 {
            color: white;
            font-size: 36px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .pdf-header p {
            color: rgba(255,255,255,0.9);
            font-size: 18px;
            position: relative;
            z-index: 1;
        }

        .pdf-customer-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-right: 6px solid #2196f3;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.2);
        }

        .pdf-customer-info h3 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pdf-customer-info h3::before {
            content: '👤';
            font-size: 24px;
        }

        .pdf-payment-info {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-right: 6px solid #ff9800;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.2);
        }

        .pdf-payment-info h3 {
            color: #f57c00;
            margin-bottom: 15px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pdf-payment-info h3::before {
            content: '💳';
            font-size: 24px;
        }

        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .pdf-table th,
        .pdf-table td {
            padding: 18px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            font-size: 16px;
        }

        .pdf-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .pdf-table tr:nth-child(even) {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .pdf-table tr:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        .pdf-summary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-top: 25px;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
            position: relative;
            overflow: hidden;
        }

        .pdf-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="summaryGrain" width="50" height="50" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="0.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="40" r="0.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23summaryGrain)"/></svg>');
            opacity: 0.2;
        }

        .pdf-summary h3 {
            margin-bottom: 25px;
            font-size: 28px;
            position: relative;
            z-index: 1;
        }

        .pdf-summary .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .pdf-summary .summary-item {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .pdf-summary .summary-item .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .pdf-summary .summary-item .label {
            font-size: 16px;
            opacity: 0.9;
        }

        .pdf-footer {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
            border-top: 3px solid #667eea;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .pdf-footer h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .pdf-footer p {
            color: #666;
            margin-bottom: 8px;
        }

        /* WhatsApp Button Styles */
        .whatsapp-btn {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 10px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
        }

        .whatsapp-btn:hover {
            background: linear-gradient(135deg, #128C7E 0%, #075e54 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4);
        }

        .whatsapp-icon::before {
            content: "📱";
            font-size: 20px;
        }

        /* Alert/Notification Styles */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
            backdrop-filter: blur(10px);
        }

        .alert.show {
            transform: translateX(0);
        }

        .alert.error {
            background: #dc3545;
        }

        .alert.warning {
            background: #ffc107;
            color: #333;
        }

        .alert.info {
            background: #17a2b8;
        }

        /* Payment Summary in Ledger */
        .payment-summary-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-right: 5px solid #4caf50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
        }

        .payment-summary-info h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .payment-summary-info p {
            margin-bottom: 8px;
            color: #2e7d32;
            font-size: 16px;
        }

        /* Payment History Styles */
        .payment-history-item {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-right: 5px solid #4caf50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
            transition: transform 0.3s ease;
        }

        .payment-history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        /* GitHub Backup Styles */
        .backup-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .backup-section h3 {
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid #e0e0e0;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .nav-buttons {
                gap: 5px;
            }

            .nav-btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .customers-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
                width: 98%;
            }

            .entries-table {
                font-size: 14px;
            }

            .entries-table th,
            .entries-table td {
                padding: 8px 4px;
            }

            .bill-summary .summary-grid {
                grid-template-columns: 1fr;
            }

            .payment-grid {
                grid-template-columns: 1fr;
            }

            .pdf-preview {
                padding: 15px;
            }

            .pdf-header {
                margin: -15px -15px 20px -15px;
                padding: 20px;
            }

            .pdf-header h1 {
                font-size: 24px;
            }

            .pdf-summary .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🥛 دودھ کا کاروبار</h1>
            <p>مکمل آن لائن بزنس سلوشن - پیمنٹ ٹریکنگ اور GitHub بیک اپ کے ساتھ</p>
        </div>

        <!-- Navigation -->
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showSection('dashboard')">📊 ڈیش بورڈ</button>
            <button class="nav-btn" onclick="showSection('customers')">👥 گاہک</button>
            <button class="nav-btn" onclick="showSection('payments')">💰 پیمنٹس</button>
            <button class="nav-btn" onclick="showSection('reports')">📈 رپورٹس</button>
            <button class="nav-btn" onclick="showSection('backup')">☁️ بیک اپ</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section">
            <h2 class="section-title">📊 ڈیش بورڈ</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>کل گاہک</h3>
                    <div class="number" id="total-customers">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>اس مہینے کل دودھ</h3>
                    <div class="number" id="total-milk">0</div>
                    <small>لیٹر</small>
                </div>
                <div class="dashboard-card">
                    <h3>اس مہینے کل آمدنی</h3>
                    <div class="number" id="total-revenue">0</div>
                    <small>روپے</small>
                </div>
                <div class="dashboard-card">
                    <h3>بقایا رقم</h3>
                    <div class="number" id="pending-amount">0</div>
                    <small>روپے</small>
                </div>
            </div>
        </div>

        <!-- Customers Section -->
        <div id="customers-section" class="section hidden">
            <h2 class="section-title">👥 گاہکوں کی فہرست</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn" onclick="openAddCustomerModal()">➕ نیا گاہک شامل کریں</button>
            </div>
            <div id="customers-list" class="customers-grid">
                <!-- Customers will be loaded here -->
            </div>
        </div>

        <!-- Payments Section -->
        <div id="payments-section" class="section hidden">
            <h2 class="section-title">💰 پیمنٹس کا جائزہ</h2>
            <div class="filter-controls">
                <label>مہینہ منتخب کریں:</label>
                <select id="payments-month-filter" onchange="loadPaymentsOverview()">
                    <option value="all">تمام مہینے</option>
                    <option value="2025-01">جنوری 2025</option>
                    <option value="2025-02">فروری 2025</option>
                    <option value="2025-03">مارچ 2025</option>
                    <option value="2025-04">اپریل 2025</option>
                    <option value="2025-05">مئی 2025</option>
                    <option value="2025-06">جون 2025</option>
                    <option value="2025-07">جولائی 2025</option>
                    <option value="2025-08">اگست 2025</option>
                    <option value="2025-09">ستمبر 2025</option>
                    <option value="2025-10">اکتوبر 2025</option>
                    <option value="2025-11">نومبر 2025</option>
                    <option value="2025-12">دسمبر 2025</option>
                </select>
            </div>
            <div id="payments-overview">
                <!-- Payment overview will be loaded here -->
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="section hidden">
            <h2 class="section-title">📈 رپورٹس</h2>
            <div style="text-align: center;">
                <button class="btn" onclick="generateMonthlyReport()">📅 ماہانہ رپورٹ</button>
                <button class="btn btn-secondary" onclick="generateCustomerReport()">👥 گاہک وار رپورٹ</button>
                <button class="btn btn-info" onclick="generatePaymentReport()">💳 پیمنٹ رپورٹ</button>
            </div>
        </div>

        <!-- Backup Section -->
        <div id="backup-section" class="section hidden">
            <h2 class="section-title">☁️ ڈیٹا بیک اپ اور بحالی</h2>
            
            <!-- Local Backup -->
            <div class="backup-section">
                <h3 style="color: #4CAF50;">💾 مقامی بیک اپ</h3>
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="exportData()">📤 ڈیٹا ایکسپورٹ</button>
                    <button class="btn btn-warning" onclick="importData()">📥 ڈیٹا امپورٹ</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                </div>
            </div>

            <!-- GitHub Backup -->
            <div class="backup-section">
                <h3 style="color: #2196F3;">🐙 GitHub بیک اپ سسٹم</h3>
                <div class="form-group">
                    <label>GitHub Personal Access Token:</label>
                    <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                    <small style="display: block; margin-top: 5px; color: #666;">
                        GitHub Settings > Developer settings > Personal access tokens سے ٹوکن بنائیں
                    </small>
                </div>
                <div class="form-group">
                    <label>Repository Name:</label>
                    <input type="text" id="github-repo" placeholder="milk-business-backup" value="milk-business-backup">
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button class="btn btn-success" onclick="setupGitHubBackup()">🔧 GitHub سیٹ اپ</button>
                    <button class="btn btn-info" onclick="backupToGitHub()">☁️ فوری بیک اپ</button>
                    <button class="btn btn-warning" onclick="restoreFromGitHub()">⬇️ بحالی</button>
                    <button class="btn" onclick="testGitHubConnection()" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);">🔗 کنکشن ٹیسٹ</button>
                </div>
            </div>

            <!-- Backup Statistics -->
            <div class="backup-section">
                <h3 style="color: #FF9800;">📊 بیک اپ کی تفصیلات</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="last-backup-time">کبھی نہیں</div>
                        <div>آخری بیک اپ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="backup-size">0 KB</div>
                        <div>ڈیٹا سائز</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="github-status">❌</div>
                        <div>GitHub Status</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="backup-status">آمادہ</div>
                        <div>سسٹم کی حالت</div>
                    </div>
                </div>
            </div>

            <!-- Auto Backup Settings -->
            <div class="backup-section">
                <h3 style="color: #607D8B;">⚙️ خودکار بیک اپ ترتیبات</h3>
                <div class="form-group">
                    <label>خودکار بیک اپ:</label>
                    <select id="auto-backup-frequency" onchange="updateAutoBackupSettings()">
                        <option value="0">بند</option>
                        <option value="5">ہر 5 منٹ</option>
                        <option value="15">ہر 15 منٹ</option>
                        <option value="30">ہر 30 منٹ</option>
                        <option value="60">ہر گھنٹے</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Ledger Section -->
        <div id="ledger-section" class="section hidden">
            <div class="ledger-header">
                <h2 id="ledger-customer-name">گاہک کا نام</h2>
                <p id="ledger-customer-phone">فون نمبر</p>
                <button class="btn btn-secondary" onclick="showSection('customers')" style="margin-top: 10px;">⬅️ واپس</button>
            </div>

            <!-- Filter Controls -->
            <div class="filter-controls">
                <label>مہینہ منتخب کریں:</label>
                <select id="month-filter" onchange="filterByMonth()">
                    <option value="all">تمام مہینے</option>
                    <option value="2025-01">جنوری 2025</option>
                    <option value="2025-02">فروری 2025</option>
                    <option value="2025-03">مارچ 2025</option>
                    <option value="2025-04">اپریل 2025</option>
                    <option value="2025-05">مئی 2025</option>
                    <option value="2025-06">جون 2025</option>
                    <option value="2025-07">جولائی 2025</option>
                    <option value="2025-08">اگست 2025</option>
                    <option value="2025-09">ستمبر 2025</option>
                    <option value="2025-10">اکتوبر 2025</option>
                    <option value="2025-11">نومبر 2025</option>
                    <option value="2025-12">دسمبر 2025</option>
                </select>
                <button class="btn" onclick="openAddEntryModal()">➕ نئی انٹری</button>
                <button class="btn btn-warning" onclick="openPaymentModal()">💰 پیمنٹ لیں</button>
                <button class="btn btn-success" onclick="generateBill()">📄 بل بنائیں</button>
            </div>

            <!-- Payment Status Section -->
            <div class="payment-status-section" id="payment-status-section">
                <h3>💰 پیمنٹ کی صورتحال - <span id="payment-month-name">اس مہینے کی</span></h3>
                <div class="payment-grid">
                    <div class="payment-item">
                        <div class="label">کل بل</div>
                        <div class="value" id="month-total-amount">0</div>
                        <small>روپے</small>
                    </div>
                    <div class="payment-item">
                        <div class="label">ادا شدہ</div>
                        <div class="value" id="month-paid-amount">0</div>
                        <small>روپے</small>
                    </div>
                    <div class="payment-item">
                        <div class="label">باقی</div>
                        <div class="value" id="month-remaining-amount">0</div>
                        <small>روپے</small>
                    </div>
                    <div class="payment-item">
                        <div class="label">فیصد</div>
                        <div class="value" id="payment-percentage">0%</div>
                        <small>مکمل</small>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-warning" id="pay-remaining-btn" onclick="openPaymentModal()">💰 باقی رقم ادا کریں</button>
                </div>
            </div>

            <!-- Bill Summary -->
            <div class="bill-summary" id="bill-summary">
                <h3>🧾 بل کی تفصیلات</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">کل دودھ</div>
                        <div class="value" id="summary-total-liters">0</div>
                        <small>لیٹر</small>
                    </div>
                    <div class="summary-item">
                        <div class="label">کل دن</div>
                        <div class="value" id="summary-total-days">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">کل رقم</div>
                        <div class="value" id="summary-total-amount">0</div>
                        <small>روپے</small>
                    </div>
                </div>
            </div>

            <!-- Entries Table -->
            <table class="entries-table" id="entries-table">
                <thead>
                    <tr>
                        <th>شروع کی تاریخ</th>
                        <th>اختتام کی تاریخ</th>
                        <th>دودھ (لیٹر)</th>
                        <th>ریٹ (فی لیٹر)</th>
                        <th>کل رقم</th>
                        <th>عمل</th>
                    </tr>
                </thead>
                <tbody id="entries-tbody">
                    <!-- Entries will be loaded here -->
                </tbody>
            </table>

            <!-- Payment History -->
            <div id="payment-history-section" style="margin-top: 30px;">
                <h3 style="color: #333; margin-bottom: 15px; text-align: center;">💳 پیمنٹ کی تاریخ</h3>
                <div id="payment-history-list">
                    <!-- Payment history will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="add-customer-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <h2 class="section-title">➕ نیا گاہک شامل کریں</h2>
            <form onsubmit="addCustomer(event)">
                <div class="form-group">
                    <label>گاہک کا نام *</label>
                    <input type="text" id="customer-name" required>
                </div>
                <div class="form-group">
                    <label>فون نمبر</label>
                    <input type="tel" id="customer-phone">
                </div>
                <div class="form-group">
                    <label>پتہ</label>
                    <textarea id="customer-address" rows="3"></textarea>
                </div>
                <div style="text-align: center;">
                    <button type="submit" class="btn">گاہک شامل کریں</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">منسوخ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Entry Modal -->
    <div id="add-entry-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <h2 class="section-title" id="entry-modal-title">➕ نئی انٹری شامل کریں</h2>
            <form onsubmit="submitEntry(event)">
                <div class="form-group">
                    <label>شروع کی تاریخ *</label>
                    <input type="date" id="entry-from-date" required>
                </div>
                <div class="form-group">
                    <label>اختتام کی تاریخ *</label>
                    <input type="date" id="entry-to-date" required>
                </div>
                <div class="form-group">
                    <label>دودھ (لیٹر) *</label>
                    <input type="number" id="entry-liters" step="0.1" min="0" required>
                </div>
                <div class="form-group">
                    <label>ریٹ (فی لیٹر) *</label>
                    <input type="number" id="entry-rate" step="1" min="0" required>
                </div>
                <div style="text-align: center;">
                    <button type="submit" class="btn" id="entry-submit-btn">انٹری شامل کریں</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">منسوخ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <h2 class="section-title">💰 پیمنٹ ریکارڈ کریں</h2>
            <form onsubmit="addPayment(event)">
                <div class="form-group">
                    <label>مہینہ منتخب کریں:</label>
                    <select id="payment-month" onchange="updatePaymentSummary()" required>
                        <option value="">منتخب کریں</option>
                        <option value="2025-01">جنوری 2025</option>
                        <option value="2025-02">فروری 2025</option>
                        <option value="2025-03">مارچ 2025</option>
                        <option value="2025-04">اپریل 2025</option>
                        <option value="2025-05">مئی 2025</option>
                        <option value="2025-06">جون 2025</option>
                        <option value="2025-07">جولائی 2025</option>
                        <option value="2025-08">اگست 2025</option>
                        <option value="2025-09">ستمبر 2025</option>
                        <option value="2025-10">اکتوبر 2025</option>
                        <option value="2025-11">نومبر 2025</option>
                        <option value="2025-12">دسمبر 2025</option>
                    </select>
                </div>
                <div id="payment-summary-info" class="payment-summary-info" style="display: none;">
                    <h4>📊 پیمنٹ کی تفصیلات</h4>
                    <p><strong>💰 کل بل:</strong> <span id="bill-total-info">0</span> روپے</p>
                    <p><strong>✅ پہلے سے ادا:</strong> <span id="already-paid-info">0</span> روپے</p>
                    <p><strong>❗ باقی:</strong> <span id="remaining-info">0</span> روپے</p>
                </div>
                <div class="form-group">
                    <label>رقم *</label>
                    <input type="number" id="payment-amount" step="1" min="0" required>
                </div>
                <div class="form-group">
                    <label>تاریخ *</label>
                    <input type="date" id="payment-date" required>
                </div>
                <div class="form-group">
                    <label>ادائیگی کا طریقہ:</label>
                    <select id="payment-method">
                        <option value="cash">💵 نقد</option>
                        <option value="bank">🏦 بینک ٹرانسفر</option>
                        <option value="check">📝 چیک</option>
                        <option value="mobile">📱 موبائل پیمنٹ</option>
                        <option value="other">🔄 دیگر</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>نوٹس:</label>
                    <textarea id="payment-notes" rows="3" placeholder="اختیاری تبصرہ..."></textarea>
                </div>
                <div style="text-align: center;">
                    <button type="submit" class="btn btn-warning">💰 پیمنٹ ریکارڈ کریں</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">منسوخ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdf-preview-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <h2 class="section-title">📄 بل کا پیش منظر</h2>
            
            <div id="pdf-preview-content" class="pdf-preview">
                <!-- PDF content will be generated here -->
            </div>
            
            <div style="text-align: center; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px;">
                <button class="btn" onclick="downloadPDF()" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">📥 PDF ڈاؤن لوڈ کریں</button>
                <button class="whatsapp-btn" onclick="shareViaWhatsApp()">
                    <span class="whatsapp-icon"></span>
                    واٹس ایپ پر شیئر کریں
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">❌ بند کریں</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let customers = [];
        let nextId = 1;
        let currentCustomerId = null;
        let currentEditEntryId = null;
        let currentBillData = null;
        let gitHubSettings = { token: '', repo: 'milk-business-backup', username: '' };
        let autoBackupInterval = null;

        // Month names in Urdu
        const monthNames = {
            '2025-01': 'جنوری 2025',
            '2025-02': 'فروری 2025',
            '2025-03': 'مارچ 2025',
            '2025-04': 'اپریل 2025',
            '2025-05': 'مئی 2025',
            '2025-06': 'جون 2025',
            '2025-07': 'جولائی 2025',
            '2025-08': 'اگست 2025',
            '2025-09': 'ستمبر 2025',
            '2025-10': 'اکتوبر 2025',
            '2025-11': 'نومبر 2025',
            '2025-12': 'دسمبر 2025'
        };

        // Payment method names in Urdu
        const paymentMethodNames = {
            'cash': '💵 نقد',
            'bank': '🏦 بینک ٹرانسفر',
            'check': '📝 چیک',
            'mobile': '📱 موبائل پیمنٹ',
            'other': '🔄 دیگر'
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Enhanced Milk Business App initializing...');
            
            try {
                loadFromStorage();
                loadCustomers();
                updateDashboard();
                showSection('dashboard');
                
                // Set today's date as default for payment
                const today = new Date().toISOString().split('T')[0];
                const paymentDateInput = document.getElementById('payment-date');
                if (paymentDateInput) {
                    paymentDateInput.value = today;
                }
                
                // Update GitHub UI
                updateGitHubUI();
                updateBackupStats();
                
                console.log('✅ App initialized successfully!');
                showAlert('🚀 Enhanced Milk Business App آمادہ!');
            } catch (error) {
                console.error('❌ Error during initialization:', error);
                showAlert('ابتدائی لوڈنگ میں خرابی: ' + error.message, 'error');
            }
        });

        // Navigation Functions
        function showSection(sectionName) {
            try {
                // Remove active class from all nav buttons
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Hide all sections
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                // Show selected section
                const targetSection = document.getElementById(sectionName + '-section');
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    
                    // Add active class to clicked nav button
                    if (event && event.target && event.target.classList && event.target.classList.contains('nav-btn')) {
                        event.target.classList.add('active');
                    }
                    
                    // Load section-specific data
                    if (sectionName === 'dashboard') {
                        updateDashboard();
                    } else if (sectionName === 'payments') {
                        loadPaymentsOverview();
                    }
                } else {
                    console.error('Section not found:', sectionName + '-section');
                }
            } catch (error) {
                console.error('Error in showSection:', error);
                showAlert('سیکشن تبدیل کرنے میں خرابی', 'error');
            }
        }

        // Storage Functions
        function saveToStorage() {
            try {
                const data = {
                    customers: customers,
                    nextId: nextId,
                    gitHubSettings: gitHubSettings,
                    lastBackup: new Date().toISOString(),
                    version: '5.0'
                };
                
                localStorage.setItem('milkBusinessData', JSON.stringify(data));
                console.log('✅ Data saved to storage');
                
                // Update backup status
                updateBackupStats();
            } catch (error) {
                console.error('❌ Error saving data:', error);
                showAlert('ڈیٹا محفوظ کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function loadFromStorage() {
            try {
                const data = localStorage.getItem('milkBusinessData');
                if (data) {
                    const parsed = JSON.parse(data);
                    customers = parsed.customers || [];
                    nextId = parsed.nextId || 1;
                    gitHubSettings = parsed.gitHubSettings || { token: '', repo: 'milk-business-backup', username: '' };
                    console.log('✅ Data loaded from storage');
                    return true;
                }
            } catch (error) {
                console.error('❌ Error loading data:', error);
                showAlert('ڈیٹا لوڈ کرنے میں خرابی: ' + error.message, 'error');
            }
            return false;
        }

        // Customer Management Functions
        function addCustomer(event) {
            event.preventDefault();
            
            try {
                const name = document.getElementById('customer-name').value.trim();
                const phone = document.getElementById('customer-phone').value.trim();
                const address = document.getElementById('customer-address').value.trim();
                
                if (!name) {
                    showAlert('براہ کرم گاہک کا نام داخل کریں', 'error');
                    return;
                }
                
                const customer = {
                    id: nextId++,
                    name: name,
                    phone: phone,
                    address: address,
                    entries: [],
                    payments: [],
                    createdAt: new Date().toISOString()
                };
                
                customers.push(customer);
                saveToStorage();
                loadCustomers();
                updateDashboard();
                closeModal();
                
                showAlert('گاہک کامیابی سے شامل ہو گیا!');
            } catch (error) {
                console.error('Error adding customer:', error);
                showAlert('گاہک شامل کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function loadCustomers() {
            try {
                const customersList = document.getElementById('customers-list');
                if (!customersList) return;
                
                customersList.innerHTML = '';
                
                customers.forEach(customer => {
                    const totalEntries = customer.entries ? customer.entries.length : 0;
                    const totalAmount = customer.entries ? customer.entries.reduce((sum, entry) => sum + (entry.liters * entry.rate), 0) : 0;
                    
                    // Calculate payment status for current month
                    const currentMonth = new Date().toISOString().substring(0, 7);
                    const monthlyEntries = customer.entries ? customer.entries.filter(entry => 
                        entry.fromDate && entry.fromDate.startsWith(currentMonth)
                    ) : [];
                    
                    let monthlyBill = 0;
                    monthlyEntries.forEach(entry => {
                        monthlyBill += entry.liters * entry.rate;
                    });
                    
                    let monthlyPaid = 0;
                    if (customer.payments) {
                        customer.payments.filter(payment => payment.month === currentMonth).forEach(payment => {
                            monthlyPaid += parseFloat(payment.amount);
                        });
                    }
                    
                    const paymentStatus = monthlyBill === 0 ? 'paid' : (monthlyPaid >= monthlyBill ? 'paid' : (monthlyPaid > 0 ? 'pending' : 'overdue'));
                    const paymentText = monthlyBill === 0 ? 'کوئی بل نہیں' : (monthlyPaid >= monthlyBill ? 'ادا شدہ' : (monthlyPaid > 0 ? 'جزوی ادا' : 'باقی'));
                    
                    const customerCard = document.createElement('div');
                    customerCard.className = 'customer-card';
                    customerCard.onclick = () => showLedger(customer.id);
                    
                    customerCard.innerHTML = `
                        <div class="payment-status status-${paymentStatus}">${paymentText}</div>
                        <h3>👤 ${customer.name}</h3>
                        <p><strong>📞 فون:</strong> ${customer.phone || 'موجود نہیں'}</p>
                        <p><strong>📍 پتہ:</strong> ${customer.address || 'موجود نہیں'}</p>
                        <p><strong>📊 کل انٹریز:</strong> ${totalEntries}</p>
                        <p><strong>💰 کل رقم:</strong> ${totalAmount.toFixed(0)} روپے</p>
                        <p><strong>💳 اس مہینے:</strong> ${monthlyBill.toFixed(0)} روپے</p>
                        <p><strong>✅ ادا شدہ:</strong> ${monthlyPaid.toFixed(0)} روپے</p>
                        <p><strong>❗ باقی:</strong> ${(monthlyBill - monthlyPaid).toFixed(0)} روپے</p>
                    `;
                    
                    customersList.appendChild(customerCard);
                });
            } catch (error) {
                console.error('Error loading customers:', error);
                showAlert('گاہک لوڈ کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        // Ledger Functions
        function showLedger(customerId) {
            try {
                currentCustomerId = customerId;
                const customer = customers.find(c => c.id === customerId);
                
                if (!customer) {
                    showAlert('گاہک نہیں ملا', 'error');
                    return;
                }
                
                // Initialize payments array if not exists
                if (!customer.payments) {
                    customer.payments = [];
                }
                
                // Hide other sections and show ledger
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                const ledgerSection = document.getElementById('ledger-section');
                if (ledgerSection) {
                    ledgerSection.classList.remove('hidden');
                }
                
                // Update customer info
                const nameEl = document.getElementById('ledger-customer-name');
                const phoneEl = document.getElementById('ledger-customer-phone');
                
                if (nameEl) nameEl.textContent = `👤 ${customer.name}`;
                if (phoneEl) phoneEl.textContent = `📞 ${customer.phone || 'فون نمبر موجود نہیں'}`;
                
                // Reset month filter
                const monthFilter = document.getElementById('month-filter');
                if (monthFilter) {
                    monthFilter.value = 'all';
                }
                
                loadLedgerEntries(customerId);
                updateBillSummary();
                updatePaymentStatus();
                loadPaymentHistory();
            } catch (error) {
                console.error('Error showing ledger:', error);
                showAlert('لیجر دکھانے میں خرابی: ' + error.message, 'error');
            }
        }

        function loadLedgerEntries(customerId) {
            try {
                const customer = customers.find(c => c.id === customerId);
                const tbody = document.getElementById('entries-tbody');
                if (!tbody || !customer) return;
                
                tbody.innerHTML = '';
                
                if (!customer.entries || !customer.entries.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">کوئی انٹری موجود نہیں</td></tr>';
                    return;
                }
                
                // Filter entries by selected month
                const selectedMonth = document.getElementById('month-filter').value;
                let filteredEntries = customer.entries;
                
                if (selectedMonth !== 'all') {
                    filteredEntries = customer.entries.filter(entry => {
                        return entry.fromDate && entry.fromDate.startsWith(selectedMonth);
                    });
                }
                
                filteredEntries.forEach(entry => {
                    const row = document.createElement('tr');
                    const totalAmount = entry.liters * entry.rate;
                    
                    row.innerHTML = `
                        <td>${formatDate(entry.fromDate)}</td>
                        <td>${formatDate(entry.toDate)}</td>
                        <td>${entry.liters}</td>
                        <td>${entry.rate}</td>
                        <td>${totalAmount.toFixed(0)}</td>
                        <td class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editEntry(${entry.id})" title="ایڈٹ">✏️</button>
                            <button class="action-btn delete-btn" onclick="deleteEntry(${entry.id})" title="ڈیلیٹ">🗑️</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                updateBillSummary();
                updatePaymentStatus();
            } catch (error) {
                console.error('Error loading ledger entries:', error);
                showAlert('انٹریز لوڈ کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function filterByMonth() {
            try {
                loadLedgerEntries(currentCustomerId);
                updatePaymentStatus();
            } catch (error) {
                console.error('Error filtering by month:', error);
                showAlert('مہینہ فلٹر کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        // Entry Management Functions
        function openAddEntryModal() {
            try {
                if (!currentCustomerId) {
                    showAlert('براہ کرم پہلے گاہک منتخب کریں', 'error');
                    return;
                }
                
                // Reset form for new entry
                currentEditEntryId = null;
                const titleEl = document.getElementById('entry-modal-title');
                const btnEl = document.getElementById('entry-submit-btn');
                
                if (titleEl) titleEl.textContent = '➕ نئی انٹری شامل کریں';
                if (btnEl) btnEl.textContent = 'انٹری شامل کریں';
                
                const form = document.querySelector('#add-entry-modal form');
                if (form) form.reset();
                
                const modal = document.getElementById('add-entry-modal');
                if (modal && modal.classList) {
                    modal.classList.add('show');
                }
            } catch (error) {
                console.error('Error opening add entry modal:', error);
                showAlert('انٹری فارم کھولنے میں خرابی: ' + error.message, 'error');
            }
        }

        function submitEntry(event) {
            event.preventDefault();
            
            try {
                if (currentEditEntryId) {
                    updateEntry();
                } else {
                    addEntry();
                }
            } catch (error) {
                console.error('Error submitting entry:', error);
                showAlert('انٹری محفوظ کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function addEntry() {
            try {
                const fromDate = document.getElementById('entry-from-date').value;
                const toDate = document.getElementById('entry-to-date').value;
                const liters = parseFloat(document.getElementById('entry-liters').value);
                const rate = parseFloat(document.getElementById('entry-rate').value);
                
                if (!fromDate || !toDate || !liters || !rate) {
                    showAlert('براہ کرم تمام فیلڈز بھریں', 'error');
                    return;
                }
                
                if (new Date(fromDate) > new Date(toDate)) {
                    showAlert('اختتام کی تاریخ شروع کی تاریخ سے پہلے نہیں ہو سکتی', 'error');
                    return;
                }
                
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer) {
                    showAlert('گاہک نہیں ملا', 'error');
                    return;
                }
                
                const entry = {
                    id: nextId++,
                    fromDate: fromDate,
                    toDate: toDate,
                    liters: liters,
                    rate: rate,
                    createdAt: new Date().toISOString()
                };
                
                customer.entries.push(entry);
                saveToStorage();
                loadLedgerEntries(currentCustomerId);
                updateDashboard();
                closeModal();
                
                showAlert('انٹری کامیابی سے شامل ہو گئی!');
            } catch (error) {
                console.error('Error adding entry:', error);
                showAlert('انٹری شامل کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function editEntry(entryId) {
            try {
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer) return;
                
                const entry = customer.entries.find(e => e.id === entryId);
                if (!entry) {
                    showAlert('انٹری نہیں ملی', 'error');
                    return;
                }
                
                currentEditEntryId = entryId;
                
                // Fill form with existing data
                document.getElementById('entry-from-date').value = entry.fromDate;
                document.getElementById('entry-to-date').value = entry.toDate;
                document.getElementById('entry-liters').value = entry.liters;
                document.getElementById('entry-rate').value = entry.rate;
                
                // Update modal title and button text
                const titleEl = document.getElementById('entry-modal-title');
                const btnEl = document.getElementById('entry-submit-btn');
                
                if (titleEl) titleEl.textContent = '✏️ انٹری ایڈٹ کریں';
                if (btnEl) btnEl.textContent = 'اپڈیٹ کریں';
                
                const modal = document.getElementById('add-entry-modal');
                if (modal && modal.classList) {
                    modal.classList.add('show');
                }
            } catch (error) {
                console.error('Error editing entry:', error);
                showAlert('انٹری ایڈٹ کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function updateEntry() {
            try {
                const fromDate = document.getElementById('entry-from-date').value;
                const toDate = document.getElementById('entry-to-date').value;
                const liters = parseFloat(document.getElementById('entry-liters').value);
                const rate = parseFloat(document.getElementById('entry-rate').value);
                
                if (!fromDate || !toDate || !liters || !rate) {
                    showAlert('براہ کرم تمام فیلڈز بھریں', 'error');
                    return;
                }
                
                if (new Date(fromDate) > new Date(toDate)) {
                    showAlert('اختتام کی تاریخ شروع کی تاریخ سے پہلے نہیں ہو سکتی', 'error');
                    return;
                }
                
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer) return;
                
                const entryIndex = customer.entries.findIndex(e => e.id === currentEditEntryId);
                
                if (entryIndex !== -1) {
                    customer.entries[entryIndex] = {
                        ...customer.entries[entryIndex],
                        fromDate: fromDate,
                        toDate: toDate,
                        liters: liters,
                        rate: rate,
                        updatedAt: new Date().toISOString()
                    };
                    
                    saveToStorage();
                    loadLedgerEntries(currentCustomerId);
                    updateDashboard();
                    closeModal();
                    
                    showAlert('انٹری کامیابی سے اپڈیٹ ہو گئی!');
                }
            } catch (error) {
                console.error('Error updating entry:', error);
                showAlert('انٹری اپڈیٹ کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function deleteEntry(entryId) {
            try {
                if (!confirm('کیا آپ واقعی اس انٹری کو ڈیلیٹ کرنا چاہتے ہیں؟')) {
                    return;
                }
                
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer) return;
                
                customer.entries = customer.entries.filter(e => e.id !== entryId);
                
                saveToStorage();
                loadLedgerEntries(currentCustomerId);
                updateDashboard();
                
                showAlert('انٹری ڈیلیٹ ہو گئی!');
            } catch (error) {
                console.error('Error deleting entry:', error);
                showAlert('انٹری ڈیلیٹ کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        // Bill Summary Functions
        function updateBillSummary() {
            try {
                if (!currentCustomerId) return;
                
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer) return;
                
                // Filter entries by selected month
                const selectedMonth = document.getElementById('month-filter').value;
                let filteredEntries = customer.entries || [];
                
                if (selectedMonth !== 'all') {
                    filteredEntries = filteredEntries.filter(entry => {
                        return entry.fromDate && entry.fromDate.startsWith(selectedMonth);
                    });
                }
                
                let totalLiters = 0;
                let totalDays = 0;
                let totalAmount = 0;
                
                filteredEntries.forEach(entry => {
                    totalLiters += entry.liters;
                    totalAmount += entry.liters * entry.rate;
                    
                    // Calculate days between dates
                    const fromDate = new Date(entry.fromDate);
                    const toDate = new Date(entry.toDate);
                    const diffTime = Math.abs(toDate - fromDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    totalDays += diffDays;
                });
                
                // Update summary display
                const litersEl = document.getElementById('summary-total-liters');
                const daysEl = document.getElementById('summary-total-days');
                const amountEl = document.getElementById('summary-total-amount');
                
                if (litersEl) litersEl.textContent = totalLiters.toFixed(1);
                if (daysEl) daysEl.textContent = totalDays;
                if (amountEl) amountEl.textContent = totalAmount.toFixed(0);
            } catch (error) {
                console.error('Error updating bill summary:', error);
            }
        }

        // Payment Management Functions
        function updatePaymentStatus() {
            try {
                if (!currentCustomerId) return;
                
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer) return;
                
                const selectedMonth = document.getElementById('month-filter').value;
                let monthToCheck = selectedMonth;
                
                if (selectedMonth === 'all') {
                    monthToCheck = new Date().toISOString().substring(0, 7);
                }
                
                // Update payment month name
                const monthNameEl = document.getElementById('payment-month-name');
                if (monthNameEl) {
                    monthNameEl.textContent = selectedMonth === 'all' ? 'اس مہینے کی' : monthNames[monthToCheck] + ' کی';
                }
                
                // Calculate monthly bill
                let monthlyBill = 0;
                const monthlyEntries = customer.entries ? customer.entries.filter(entry => 
                    entry.fromDate && entry.fromDate.startsWith(monthToCheck)
                ) : [];
                
                monthlyEntries.forEach(entry => {
                    monthlyBill += entry.liters * entry.rate;
                });
                
                // Calculate paid amount
                let paidAmount = 0;
                if (customer.payments) {
                    customer.payments.filter(payment => payment.month === monthToCheck).forEach(payment => {
                        paidAmount += parseFloat(payment.amount);
                    });
                }
                
                const remainingAmount = monthlyBill - paidAmount;
                const percentage = monthlyBill > 0 ? ((paidAmount / monthlyBill) * 100) : 0;
                
                // Update payment status display
                const totalEl = document.getElementById('month-total-amount');
                const paidEl = document.getElementById('month-paid-amount');
                const remainingEl = document.getElementById('month-remaining-amount');
                const percentageEl = document.getElementById('payment-percentage');
                const payBtn = document.getElementById('pay-remaining-btn');
                
                if (totalEl) totalEl.textContent = monthlyBill.toFixed(0);
                if (paidEl) paidEl.textContent = paidAmount.toFixed(0);
                if (remainingEl) remainingEl.textContent = remainingAmount.toFixed(0);
                if (percentageEl) percentageEl.textContent = percentage.toFixed(1) + '%';
                
                if (payBtn) {
                    if (remainingAmount > 0) {
                        payBtn.textContent = `💰 ${remainingAmount.toFixed(0)} روپے ادا کریں`;
                        payBtn.style.background = 'linear-gradient(135deg, #ffc107 0%, #ff8f00 100%)';
                        payBtn.disabled = false;
                    } else {
                        payBtn.textContent = '✅ مکمل ادا شدہ';
                        payBtn.style.background = '#4CAF50';
                        payBtn.disabled = true;
                    }
                }
            } catch (error) {
                console.error('Error updating payment status:', error);
            }
        }

        function openPaymentModal() {
            try {
                if (!currentCustomerId) {
                    showAlert('براہ کرم پہلے گاہک منتخب کریں', 'error');
                    return;
                }
                
                const modal = document.getElementById('payment-modal');
                if (!modal) return;
                
                const selectedMonth = document.getElementById('month-filter').value;
                
                if (selectedMonth && selectedMonth !== 'all') {
                    const paymentMonthEl = document.getElementById('payment-month');
                    if (paymentMonthEl) {
                        paymentMonthEl.value = selectedMonth;
                        updatePaymentSummary();
                    }
                }
                
                const today = new Date().toISOString().split('T')[0];
                const paymentDateEl = document.getElementById('payment-date');
                if (paymentDateEl) {
                    paymentDateEl.value = today;
                }
                
                if (modal.classList) {
                    modal.classList.add('show');
                }
            } catch (error) {
                console.error('Error opening payment modal:', error);
                showAlert('پیمنٹ فارم کھولنے میں خرابی: ' + error.message, 'error');
            }
        }

        function updatePaymentSummary() {
            try {
                const selectedMonth = document.getElementById('payment-month').value;
                if (!selectedMonth || !currentCustomerId) return;
                
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer) return;
                
                // Calculate monthly bill
                let monthlyTotal = 0;
                const monthlyEntries = customer.entries ? customer.entries.filter(entry => 
                    entry.fromDate && entry.fromDate.startsWith(selectedMonth)
                ) : [];
                
                monthlyEntries.forEach(entry => {
                    monthlyTotal += entry.liters * entry.rate;
                });
                
                // Calculate already paid
                let alreadyPaid = 0;
                if (customer.payments) {
                    customer.payments.filter(p => p.month === selectedMonth).forEach(payment => {
                        alreadyPaid += parseFloat(payment.amount);
                    });
                }
                
                const remaining = monthlyTotal - alreadyPaid;
                
                // Show summary
                const summaryDiv = document.getElementById('payment-summary-info');
                if (summaryDiv) {
                    summaryDiv.style.display = 'block';
                }
                
                const billTotalEl = document.getElementById('bill-total-info');
                const alreadyPaidEl = document.getElementById('already-paid-info');
                const remainingEl = document.getElementById('remaining-info');
                
                if (billTotalEl) billTotalEl.textContent = monthlyTotal.toFixed(0);
                if (alreadyPaidEl) alreadyPaidEl.textContent = alreadyPaid.toFixed(0);
                if (remainingEl) remainingEl.textContent = remaining.toFixed(0);
                
                // Set suggested amount
                const amountInput = document.getElementById('payment-amount');
                if (amountInput) {
                    amountInput.value = remaining > 0 ? remaining.toFixed(0) : '';
                }
            } catch (error) {
                console.error('Error updating payment summary:', error);
            }
        }

        function addPayment(event) {
            event.preventDefault();
            
            try {
                const month = document.getElementById('payment-month').value;
                const amount = parseFloat(document.getElementById('payment-amount').value);
                const date = document.getElementById('payment-date').value;
                const method = document.getElementById('payment-method').value;
                const notes = document.getElementById('payment-notes').value;
                
                if (!month || !amount || !date) {
                    showAlert('براہ کرم ضروری فیلڈز بھریں', 'error');
                    return;
                }
                
                if (amount <= 0) {
                    showAlert('رقم صفر سے زیادہ ہونی چاہیے', 'error');
                    return;
                }
                
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer) return;
                
                // Initialize payments array if not exists
                if (!customer.payments) {
                    customer.payments = [];
                }
                
                const payment = {
                    id: nextId++,
                    month: month,
                    amount: amount,
                    date: date,
                    method: method,
                    notes: notes,
                    createdAt: new Date().toISOString()
                };
                
                customer.payments.push(payment);
                saveToStorage();
                
                // Update UI
                updatePaymentStatus();
                loadPaymentHistory();
                loadCustomers();
                updateDashboard();
                closeModal();
                
                showAlert(`💰 ${amount} روپے کی پیمنٹ کامیابی سے ریکارڈ ہو گئی!`);
            } catch (error) {
                console.error('Error adding payment:', error);
                showAlert('پیمنٹ ریکارڈ کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function loadPaymentHistory() {
            try {
                if (!currentCustomerId) return;
                
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer || !customer.payments) return;
                
                const historyList = document.getElementById('payment-history-list');
                if (!historyList) return;
                
                historyList.innerHTML = '';
                
                if (!customer.payments.length) {
                    historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">کوئی پیمنٹ ریکارڈ موجود نہیں</p>';
                    return;
                }
                
                // Sort payments by date (newest first)
                const sortedPayments = [...customer.payments].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedPayments.forEach(payment => {
                    const paymentDiv = document.createElement('div');
                    paymentDiv.className = 'payment-history-item';
                    
                    paymentDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #2e7d32; font-size: 20px;">💰 ${payment.amount} روپے</strong>
                            <span style="background: #4caf50; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                ${monthNames[payment.month] || payment.month}
                            </span>
                        </div>
                        <p style="color: #2e7d32; margin-bottom: 5px;">📅 تاریخ: ${formatDate(payment.date)}</p>
                        <p style="color: #2e7d32; margin-bottom: 5px;">💳 طریقہ: ${paymentMethodNames[payment.method] || payment.method}</p>
                        ${payment.notes ? `<p style="color: #2e7d32; margin-bottom: 0;">📝 نوٹس: ${payment.notes}</p>` : ''}
                    `;
                    
                    historyList.appendChild(paymentDiv);
                });
            } catch (error) {
                console.error('Error loading payment history:', error);
            }
        }

        function loadPaymentsOverview() {
            try {
                const overviewDiv = document.getElementById('payments-overview');
                if (!overviewDiv) return;
                
                const selectedMonth = document.getElementById('payments-month-filter').value;
                
                overviewDiv.innerHTML = '';
                
                if (selectedMonth === 'all') {
                    loadAllMonthsPayments();
                } else {
                    loadSpecificMonthPayments(selectedMonth);
                }
            } catch (error) {
                console.error('Error loading payments overview:', error);
                showAlert('پیمنٹس کا جائزہ لوڈ کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function loadAllMonthsPayments() {
            try {
                const overviewDiv = document.getElementById('payments-overview');
                
                let totalBill = 0;
                let totalPaid = 0;
                let totalCustomers = 0;
                
                const monthlyData = {};
                
                customers.forEach(customer => {
                    let customerHasData = false;
                    
                    // Process each month
                    Object.keys(monthNames).forEach(month => {
                        let monthBill = 0;
                        let monthPaid = 0;
                        
                        // Calculate monthly bill
                        const monthlyEntries = customer.entries ? customer.entries.filter(entry => 
                            entry.fromDate && entry.fromDate.startsWith(month)
                        ) : [];
                        
                        monthlyEntries.forEach(entry => {
                            monthBill += entry.liters * entry.rate;
                        });
                        
                        // Calculate monthly payments
                        if (customer.payments) {
                            customer.payments.filter(p => p.month === month).forEach(payment => {
                                monthPaid += parseFloat(payment.amount);
                            });
                        }
                        
                        if (monthBill > 0) {
                            customerHasData = true;
                            totalBill += monthBill;
                            totalPaid += monthPaid;
                            
                            if (!monthlyData[month]) {
                                monthlyData[month] = { bill: 0, paid: 0, customers: 0 };
                            }
                            monthlyData[month].bill += monthBill;
                            monthlyData[month].paid += monthPaid;
                            monthlyData[month].customers++;
                        }
                    });
                    
                    if (customerHasData) {
                        totalCustomers++;
                    }
                });
                
                // Create overview cards
                const summaryHTML = `
                    <div class="dashboard-grid" style="margin-bottom: 30px;">
                        <div class="dashboard-card">
                            <h3>کل گاہک</h3>
                            <div class="number">${totalCustomers}</div>
                        </div>
                        <div class="dashboard-card">
                            <h3>کل بل</h3>
                            <div class="number">${totalBill.toFixed(0)}</div>
                            <small>روپے</small>
                        </div>
                        <div class="dashboard-card">
                            <h3>کل ادا شدہ</h3>
                            <div class="number">${totalPaid.toFixed(0)}</div>
                            <small>روپے</small>
                        </div>
                        <div class="dashboard-card">
                            <h3>کل باقی</h3>
                            <div class="number">${(totalBill - totalPaid).toFixed(0)}</div>
                            <small>روپے</small>
                        </div>
                    </div>
                `;
                
                // Create monthly breakdown
                let monthlyHTML = '<h3 style="margin-bottom: 20px; text-align: center;">📊 ماہانہ تفصیلات</h3>';
                
                Object.keys(monthlyData).sort().reverse().forEach(month => {
                    const data = monthlyData[month];
                    const remaining = data.bill - data.paid;
                    const percentage = data.bill > 0 ? ((data.paid / data.bill) * 100) : 0;
                    
                    monthlyHTML += `
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 10px; margin-bottom: 15px; border-right: 5px solid ${percentage >= 100 ? '#28a745' : (percentage > 50 ? '#ffc107' : '#dc3545')};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #333;">${monthNames[month]}</h4>
                                <span style="background: ${percentage >= 100 ? '#28a745' : (percentage > 50 ? '#ffc107' : '#dc3545')}; color: white; padding: 5px 12px; border-radius: 15px; font-size: 14px;">
                                    ${percentage.toFixed(1)}% مکمل
                                </span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: bold; color: #2196f3;">${data.customers}</div>
                                    <small>گاہک</small>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: bold; color: #ff9800;">${data.bill.toFixed(0)}</div>
                                    <small>کل بل</small>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: bold; color: #4caf50;">${data.paid.toFixed(0)}</div>
                                    <small>ادا شدہ</small>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: bold; color: #f44336;">${remaining.toFixed(0)}</div>
                                    <small>باقی</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                overviewDiv.innerHTML = summaryHTML + monthlyHTML;
            } catch (error) {
                console.error('Error loading all months payments:', error);
            }
        }

        function loadSpecificMonthPayments(month) {
            try {
                const overviewDiv = document.getElementById('payments-overview');
                
                let monthBill = 0;
                let monthPaid = 0;
                const customerPayments = [];
                
                customers.forEach(customer => {
                    let customerBill = 0;
                    let customerPaid = 0;
                    
                    // Calculate customer's monthly bill
                    const monthlyEntries = customer.entries ? customer.entries.filter(entry => 
                        entry.fromDate && entry.fromDate.startsWith(month)
                    ) : [];
                    
                    monthlyEntries.forEach(entry => {
                        customerBill += entry.liters * entry.rate;
                    });
                    
                    // Calculate customer's monthly payments
                    if (customer.payments) {
                        customer.payments.filter(p => p.month === month).forEach(payment => {
                            customerPaid += parseFloat(payment.amount);
                        });
                    }
                    
                    if (customerBill > 0) {
                        monthBill += customerBill;
                        monthPaid += customerPaid;
                        
                        customerPayments.push({
                            customer: customer,
                            bill: customerBill,
                            paid: customerPaid,
                            remaining: customerBill - customerPaid
                        });
                    }
                });
                
                // Sort by remaining amount (highest first)
                customerPayments.sort((a, b) => b.remaining - a.remaining);
                
                const summaryHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                        <h2>${monthNames[month]} کی تفصیلات</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold;">${customerPayments.length}</div>
                                <div>گاہک</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold;">${monthBill.toFixed(0)}</div>
                                <div>کل بل</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold;">${monthPaid.toFixed(0)}</div>
                                <div>ادا شدہ</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold;">${(monthBill - monthPaid).toFixed(0)}</div>
                                <div>باقی</div>
                            </div>
                        </div>
                    </div>
                `;
                
                let customersHTML = '<h3 style="margin-bottom: 20px; text-align: center;">👥 گاہکوں کی تفصیلات</h3>';
                
                customerPayments.forEach(data => {
                    const percentage = data.bill > 0 ? ((data.paid / data.bill) * 100) : 0;
                    
                    customersHTML += `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-right: 5px solid ${percentage >= 100 ? '#28a745' : (percentage > 50 ? '#ffc107' : '#dc3545')}; cursor: pointer;" onclick="showLedger(${data.customer.id})">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #333; margin: 0;">👤 ${data.customer.name}</h4>
                                <span style="background: ${percentage >= 100 ? '#28a745' : (percentage > 50 ? '#ffc107' : '#dc3545')}; color: white; padding: 5px 12px; border-radius: 15px; font-size: 12px;">
                                    ${percentage >= 100 ? 'مکمل' : (percentage > 0 ? 'جزوی' : 'باقی')}
                                </span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 18px; font-weight: bold; color: #ff9800;">💰 ${data.bill.toFixed(0)}</div>
                                    <small>کل بل</small>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 18px; font-weight: bold; color: #4caf50;">✅ ${data.paid.toFixed(0)}</div>
                                    <small>ادا شدہ</small>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 18px; font-weight: bold; color: #f44336;">❗ ${data.remaining.toFixed(0)}</div>
                                    <small>باقی</small>
                                </div>
                            </div>
                            <p style="margin-top: 10px; color: #666; font-size: 14px;">📞 ${data.customer.phone || 'فون موجود نہیں'}</p>
                        </div>
                    `;
                });
                
                if (customerPayments.length === 0) {
                    customersHTML += '<p style="text-align: center; color: #666; padding: 40px;">اس مہینے کوئی بل موجود نہیں</p>';
                }
                
                overviewDiv.innerHTML = summaryHTML + customersHTML;
            } catch (error) {
                console.error('Error loading specific month payments:', error);
            }
        }

        // PDF Generation Functions
        function generateBill() {
            try {
                if (!currentCustomerId) {
                    showAlert('براہ کرم پہلے گاہک منتخب کریں', 'error');
                    return;
                }
                
                const customer = customers.find(c => c.id === currentCustomerId);
                if (!customer || !customer.entries || !customer.entries.length) {
                    showAlert('کوئی انٹری موجود نہیں', 'error');
                    return;
                }
                
                // Filter entries by selected month
                const selectedMonth = document.getElementById('month-filter').value;
                let filteredEntries = customer.entries;
                
                if (selectedMonth !== 'all') {
                    filteredEntries = customer.entries.filter(entry => {
                        return entry.fromDate && entry.fromDate.startsWith(selectedMonth);
                    });
                }
                
                if (!filteredEntries.length) {
                    showAlert('منتخب کردہ مہینے میں کوئی انٹری موجود نہیں', 'error');
                    return;
                }
                
                // Prepare bill data
                currentBillData = {
                    customer: customer,
                    entries: filteredEntries,
                    selectedMonth: selectedMonth
                };
                
                generatePDFPreview();
                const modal = document.getElementById('pdf-preview-modal');
                if (modal && modal.classList) {
                    modal.classList.add('show');
                }
            } catch (error) {
                console.error('Error generating bill:', error);
                showAlert('بل بنانے میں خرابی: ' + error.message, 'error');
            }
        }

        function generatePDFPreview() {
            try {
                if (!currentBillData) return;
                
                const { customer, entries, selectedMonth } = currentBillData;
                const previewContent = document.getElementById('pdf-preview-content');
                if (!previewContent) return;
                
                let totalLiters = 0;
                let totalDays = 0;
                let totalAmount = 0;
                
                // Calculate totals
                entries.forEach(entry => {
                    totalLiters += entry.liters;
                    totalAmount += entry.liters * entry.rate;
                    
                    const fromDate = new Date(entry.fromDate);
                    const toDate = new Date(entry.toDate);
                    const diffTime = Math.abs(toDate - fromDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    totalDays += diffDays;
                });
                
                // Calculate payment information
                let paidAmount = 0;
                const payments = [];
                
                if (customer.payments) {
                    const monthToCheck = selectedMonth === 'all' ? new Date().toISOString().substring(0, 7) : selectedMonth;
                    customer.payments.filter(payment => payment.month === monthToCheck).forEach(payment => {
                        paidAmount += parseFloat(payment.amount);
                        payments.push(payment);
                    });
                }
                
                const remainingAmount = totalAmount - paidAmount;
                
                const monthName = selectedMonth === 'all' ? 'تمام مہینے' : monthNames[selectedMonth];
                const currentDate = new Date().toLocaleDateString('ur-PK');
                
                // Generate beautiful colorful Urdu PDF preview
                previewContent.innerHTML = `
                    <div class="pdf-header">
                        <h1>🥛 دودھ کا کاروبار</h1>
                        <p>کمپیوٹرائزڈ بل سسٹم - پیمنٹ ٹریکنگ کے ساتھ</p>
                        <p style="font-size: 16px; margin-top: 10px;">📅 تاریخ: ${currentDate}</p>
                    </div>
                    
                    <div class="pdf-customer-info">
                        <h3>گاہک کی تفصیلات</h3>
                        <p style="font-size: 18px;"><strong>👤 نام:</strong> ${customer.name}</p>
                        <p style="font-size: 16px;"><strong>📞 فون:</strong> ${customer.phone || 'موجود نہیں'}</p>
                        <p style="font-size: 16px;"><strong>📍 پتہ:</strong> ${customer.address || 'موجود نہیں'}</p>
                        <p style="font-size: 16px;"><strong>📊 مہینہ:</strong> ${monthName}</p>
                    </div>
                    
                    <table class="pdf-table">
                        <thead>
                            <tr>
                                <th>شروع کی تاریخ</th>
                                <th>اختتام کی تاریخ</th>
                                <th>دودھ (لیٹر)</th>
                                <th>ریٹ (فی لیٹر)</th>
                                <th>کل رقم</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${entries.map(entry => `
                                <tr>
                                    <td>${formatDate(entry.fromDate)}</td>
                                    <td>${formatDate(entry.toDate)}</td>
                                    <td>${entry.liters}</td>
                                    <td>${entry.rate} روپے</td>
                                    <td>${(entry.liters * entry.rate).toFixed(0)} روپے</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    ${payments.length > 0 ? `
                    <div class="pdf-payment-info">
                        <h3>پیمنٹ کی تفصیلات</h3>
                        ${payments.map(payment => `
                            <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-right: 4px solid #4caf50;">
                                <p style="font-size: 16px;"><strong>💰 رقم:</strong> ${payment.amount} روپے</p>
                                <p style="font-size: 14px;"><strong>📅 تاریخ:</strong> ${formatDate(payment.date)}</p>
                                <p style="font-size: 14px;"><strong>💳 طریقہ:</strong> ${paymentMethodNames[payment.method] || payment.method}</p>
                                ${payment.notes ? `<p style="font-size: 14px;"><strong>📝 نوٹس:</strong> ${payment.notes}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="pdf-summary">
                        <h3 style="margin-bottom: 25px;">📊 کل حساب کتاب</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="value">${totalLiters.toFixed(1)}</div>
                                <div class="label">🥛 کل دودھ (لیٹر)</div>
                            </div>
                            <div class="summary-item">
                                <div class="value">${totalDays}</div>
                                <div class="label">📅 کل دن</div>
                            </div>
                            <div class="summary-item">
                                <div class="value">${totalAmount.toFixed(0)}</div>
                                <div class="label">💰 کل رقم (روپے)</div>
                            </div>
                            <div class="summary-item">
                                <div class="value">${paidAmount.toFixed(0)}</div>
                                <div class="label">✅ ادا شدہ (روپے)</div>
                            </div>
                            <div class="summary-item">
                                <div class="value" style="color: ${remainingAmount > 0 ? '#ffeb3b' : '#4caf50'};">${remainingAmount.toFixed(0)}</div>
                                <div class="label">💸 ${remainingAmount > 0 ? 'باقی' : 'مکمل'} (روپے)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pdf-footer">
                        <h4>🙏 شکریہ آپ کے کاروبار کے لیے!</h4>
                        <p>یہ کمپیوٹر سے تیار کردہ بل ہے - پیمنٹ ٹریکنگ کے ساتھ</p>
                        <p style="margin-top: 15px; font-size: 14px;">
                            📱 موبائل: آپ کا فون نمبر | 📧 ای میل: آپ کا ای میل<br>
                            🌐 ویب سائٹ: آپ کا ویب سائٹ | 📍 پتہ: آپ کا کاروباری پتہ
                        </p>
                        <p style="margin-top: 10px; font-size: 12px; color: #888;">
                            Enhanced Milk Business App v5.0 - تیار کردہ ${new Date().toLocaleDateString('ur-PK')}
                        </p>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating PDF preview:', error);
                showAlert('PDF پیش منظر بنانے میں خرابی: ' + error.message, 'error');
            }
        }

        function downloadPDF() {
            try {
                if (!currentBillData) {
                    showAlert('بل کی معلومات موجود نہیں', 'error');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set font (Note: jsPDF has limited Urdu support, but we'll create a readable document)
                doc.setFont('times', 'normal');
                doc.setFontSize(16);
                
                const { customer, entries, selectedMonth } = currentBillData;
                
                // Calculate totals
                let totalLiters = 0;
                let totalAmount = 0;
                let totalDays = 0;
                
                entries.forEach(entry => {
                    totalLiters += entry.liters;
                    totalAmount += entry.liters * entry.rate;
                    
                    const fromDate = new Date(entry.fromDate);
                    const toDate = new Date(entry.toDate);
                    const diffTime = Math.abs(toDate - fromDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    totalDays += diffDays;
                });
                
                // Calculate payment info
                let paidAmount = 0;
                if (customer.payments) {
                    const monthToCheck = selectedMonth === 'all' ? new Date().toISOString().substring(0, 7) : selectedMonth;
                    customer.payments.filter(payment => payment.month === monthToCheck).forEach(payment => {
                        paidAmount += parseFloat(payment.amount);
                    });
                }
                
                const remainingAmount = totalAmount - paidAmount;
                
                // Header
                doc.setFontSize(20);
                doc.text('Milk Business - دودھ کا کاروبار', 105, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.text('Computerized Bill System with Payment Tracking', 105, 30, { align: 'center' });
                
                // Customer info
                doc.setFontSize(12);
                const currentDate = new Date().toLocaleDateString();
                doc.text(`Date: ${currentDate}`, 20, 50);
                
                doc.text(`Customer Name: ${customer.name}`, 20, 60);
                doc.text(`Phone: ${customer.phone || 'N/A'}`, 20, 70);
                doc.text(`Address: ${customer.address || 'N/A'}`, 20, 80);
                doc.text(`Month: ${selectedMonth === 'all' ? 'All Months' : monthNames[selectedMonth]}`, 20, 90);
                
                // Table header
                let yPosition = 110;
                doc.setFontSize(10);
                doc.text('From Date', 20, yPosition);
                doc.text('To Date', 50, yPosition);
                doc.text('Liters', 80, yPosition);
                doc.text('Rate', 105, yPosition);
                doc.text('Amount', 130, yPosition);
                
                // Draw line under header
                doc.line(20, yPosition + 2, 150, yPosition + 2);
                
                // Table content
                yPosition += 10;
                entries.forEach(entry => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.text(formatDate(entry.fromDate), 20, yPosition);
                    doc.text(formatDate(entry.toDate), 50, yPosition);
                    doc.text(entry.liters.toString(), 80, yPosition);
                    doc.text(entry.rate.toString(), 105, yPosition);
                    doc.text((entry.liters * entry.rate).toFixed(0), 130, yPosition);
                    yPosition += 8;
                });
                
                // Summary
                yPosition += 10;
                doc.line(20, yPosition, 150, yPosition);
                yPosition += 10;
                
                doc.setFontSize(12);
                doc.text(`Total Liters: ${totalLiters.toFixed(1)}`, 20, yPosition);
                yPosition += 10;
                doc.text(`Total Days: ${totalDays}`, 20, yPosition);
                yPosition += 10;
                doc.text(`Total Amount: ${totalAmount.toFixed(0)} Rs`, 20, yPosition);
                yPosition += 10;
                doc.text(`Paid Amount: ${paidAmount.toFixed(0)} Rs`, 20, yPosition);
                yPosition += 10;
                doc.text(`Remaining: ${remainingAmount.toFixed(0)} Rs`, 20, yPosition);
                
                // Footer
                yPosition += 20;
                doc.setFontSize(10);
                doc.text('Thank you for your business!', 105, yPosition, { align: 'center' });
                doc.text('This is a computer generated bill with payment tracking', 105, yPosition + 10, { align: 'center' });
                
                // Download
                const fileName = `${customer.name}_Bill_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showAlert('📥 PDF کامیابی سے ڈاؤن لوڈ ہو گیا!');
            } catch (error) {
                console.error('Error downloading PDF:', error);
                showAlert('PDF ڈاؤن لوڈ کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function shareViaWhatsApp() {
            try {
                if (!currentBillData) {
                    showAlert('بل کی معلومات موجود نہیں', 'error');
                    return;
                }
                
                const { customer, entries, selectedMonth } = currentBillData;
                
                // Calculate totals
                let totalLiters = 0;
                let totalAmount = 0;
                let totalDays = 0;
                
                entries.forEach(entry => {
                    totalLiters += entry.liters;
                    totalAmount += entry.liters * entry.rate;
                    
                    const fromDate = new Date(entry.fromDate);
                    const toDate = new Date(entry.toDate);
                    const diffTime = Math.abs(toDate - fromDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    totalDays += diffDays;
                });
                
                // Calculate payment info
                let paidAmount = 0;
                const payments = [];
                
                if (customer.payments) {
                    const monthToCheck = selectedMonth === 'all' ? new Date().toISOString().substring(0, 7) : selectedMonth;
                    customer.payments.filter(payment => payment.month === monthToCheck).forEach(payment => {
                        paidAmount += parseFloat(payment.amount);
                        payments.push(payment);
                    });
                }
                
                const remainingAmount = totalAmount - paidAmount;
                const monthName = selectedMonth === 'all' ? 'تمام مہینے' : monthNames[selectedMonth];
                
                // Create WhatsApp message
                let message = `🥛 *دودھ کا کاروبار - بل*\n\n`;
                message += `*👤 گاہک کی تفصیلات:*\n`;
                message += `نام: ${customer.name}\n`;
                message += `📞 فون: ${customer.phone || 'موجود نہیں'}\n`;
                message += `📊 مہینہ: ${monthName}\n\n`;
                
                message += `*📋 بل کی تفصیلات:*\n`;
                entries.forEach((entry, index) => {
                    message += `${index + 1}. ${formatDate(entry.fromDate)} سے ${formatDate(entry.toDate)}\n`;
                    message += `🥛 دودھ: ${entry.liters} لیٹر\n`;
                    message += `💰 ریٹ: ${entry.rate} روپے فی لیٹر\n`;
                    message += `💵 رقم: ${(entry.liters * entry.rate).toFixed(0)} روپے\n\n`;
                });
                
                if (payments.length > 0) {
                    message += `*💳 پیمنٹ کی تفصیلات:*\n`;
                    payments.forEach((payment, index) => {
                        message += `${index + 1}. ${formatDate(payment.date)} - ${payment.amount} روپے`;
                        message += ` (${paymentMethodNames[payment.method] || payment.method})`;
                        if (payment.notes) message += ` - ${payment.notes}`;
                        message += `\n`;
                    });
                    message += `\n`;
                }
                
                message += `*📊 کل حساب:*\n`;
                message += `🥛 کل دودھ: ${totalLiters.toFixed(1)} لیٹر\n`;
                message += `📅 کل دن: ${totalDays}\n`;
                message += `💰 کل رقم: ${totalAmount.toFixed(0)} روپے\n`;
                message += `✅ ادا شدہ: ${paidAmount.toFixed(0)} روپے\n`;
                message += `❗ باقی: ${remainingAmount.toFixed(0)} روپے\n\n`;
                
                message += `*🙏 شکریہ آپ کے کاروبار کے لیے!*\n`;
                message += `📅 ${new Date().toLocaleDateString('ur-PK')}`;
                
                // Encode message for WhatsApp URL
                const encodedMessage = encodeURIComponent(message.trim());
                const whatsappURL = `https://wa.me/?text=${encodedMessage}`;
                
                // Open WhatsApp
                window.open(whatsappURL, '_blank');
                
                showAlert('📱 WhatsApp پر شیئر کے لیے تیار!');
            } catch (error) {
                console.error('Error sharing via WhatsApp:', error);
                showAlert('WhatsApp شیئر کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            try {
                const totalCustomers = customers.length;
                const currentMonth = new Date().toISOString().substring(0, 7);
                
                let totalMilkThisMonth = 0;
                let totalRevenueThisMonth = 0;
                let pendingAmount = 0;
                
                customers.forEach(customer => {
                    // Current month entries
                    const currentMonthEntries = customer.entries ? customer.entries.filter(entry => 
                        entry.fromDate && entry.fromDate.startsWith(currentMonth)
                    ) : [];
                    
                    currentMonthEntries.forEach(entry => {
                        totalMilkThisMonth += entry.liters;
                        totalRevenueThisMonth += entry.liters * entry.rate;
                    });
                    
                    // Calculate pending amount for all months
                    if (customer.entries) {
                        customer.entries.forEach(entry => {
                            const entryAmount = entry.liters * entry.rate;
                            const entryMonth = entry.fromDate ? entry.fromDate.substring(0, 7) : currentMonth;
                            
                            // Calculate how much was paid for this month
                            let paidForMonth = 0;
                            if (customer.payments) {
                                customer.payments.filter(p => p.month === entryMonth).forEach(payment => {
                                    paidForMonth += parseFloat(payment.amount);
                                });
                            }
                            
                            // Calculate monthly bill
                            const monthlyEntries = customer.entries.filter(e => 
                                e.fromDate && e.fromDate.startsWith(entryMonth)
                            );
                            const monthlyBill = monthlyEntries.reduce((sum, e) => sum + (e.liters * e.rate), 0);
                            
                            // Add to pending if not fully paid
                            if (paidForMonth < monthlyBill && entry === monthlyEntries[0]) {
                                // Only count once per month
                                pendingAmount += (monthlyBill - paidForMonth);
                            }
                        });
                    }
                });
                
                // Update dashboard cards
                const totalCustomersEl = document.getElementById('total-customers');
                const totalMilkEl = document.getElementById('total-milk');
                const totalRevenueEl = document.getElementById('total-revenue');
                const pendingAmountEl = document.getElementById('pending-amount');
                
                if (totalCustomersEl) totalCustomersEl.textContent = totalCustomers;
                if (totalMilkEl) totalMilkEl.textContent = totalMilkThisMonth.toFixed(1);
                if (totalRevenueEl) totalRevenueEl.textContent = totalRevenueThisMonth.toFixed(0);
                if (pendingAmountEl) pendingAmountEl.textContent = pendingAmount.toFixed(0);
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        // Modal Functions
        function openAddCustomerModal() {
            try {
                const modal = document.getElementById('add-customer-modal');
                if (modal && modal.classList) {
                    modal.classList.add('show');
                }
            } catch (error) {
                console.error('Error opening customer modal:', error);
                showAlert('گاہک فارم کھولنے میں خرابی: ' + error.message, 'error');
            }
        }

        function closeModal() {
            try {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (modal.classList) {
                        modal.classList.remove('show');
                    }
                });
                
                // Reset forms
                document.querySelectorAll('form').forEach(form => {
                    if (form.reset) form.reset();
                });
                
                currentEditEntryId = null;
                
                // Hide payment summary
                const summaryDiv = document.getElementById('payment-summary-info');
                if (summaryDiv) {
                    summaryDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        // Backup Functions
        function exportData() {
            try {
                const data = {
                    customers: customers,
                    nextId: nextId,
                    exportDate: new Date().toISOString(),
                    version: '5.0'
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `milk-business-backup-${new Date().toISOString().split('T')[0]}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                showAlert('📤 ڈیٹا کامیابی سے ایکسپورٹ ہو گیا!');
            } catch (error) {
                console.error('Error exporting data:', error);
                showAlert('ڈیٹا ایکسپورٹ کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function importData() {
            try {
                const fileInput = document.getElementById('import-file');
                if (fileInput) {
                    fileInput.click();
                }
            } catch (error) {
                console.error('Error triggering import:', error);
                showAlert('امپورٹ شروع کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        function handleImportFile(event) {
            try {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.name.endsWith('.json')) {
                    showAlert('براہ کرم صحیح JSON فائل منتخب کریں', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!data.customers || !Array.isArray(data.customers)) {
                            showAlert('غلط فائل فارمیٹ', 'error');
                            return;
                        }
                        
                        if (confirm('کیا آپ واقعی ڈیٹا امپورٹ کرنا چاہتے ہیں؟ موجودہ ڈیٹا ڈیلیٹ ہو جائے گا۔')) {
                            customers = data.customers || [];
                            nextId = data.nextId || 1;
                            
                            saveToStorage();
                            loadCustomers();
                            updateDashboard();
                            
                            showAlert('📥 ڈیٹا کامیابی سے امپورٹ ہو گیا!');
                        }
                    } catch (error) {
                        console.error('Error parsing import file:', error);
                        showAlert('فائل پڑھنے میں خرابی: ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
                
                // Reset file input
                event.target.value = '';
            } catch (error) {
                console.error('Error handling import file:', error);
                showAlert('فائل ہینڈل کرنے میں خرابی: ' + error.message, 'error');
            }
        }

        // GitHub Backup Functions
        function updateGitHubUI() {
            try {
                const tokenEl = document.getElementById('github-token');
                const repoEl = document.getElementById('github-repo');
                
                if (tokenEl && gitHubSettings.token) {
                    tokenEl.value = gitHubSettings.token;
                }
                if (repoEl && gitHubSettings.repo) {
                    repoEl.value = gitHubSettings.repo;
                }
                
                updateGitHubStatus();
            } catch (error) {
                console.error('Error updating GitHub UI:', error);
            }
        }

        function updateGitHubStatus() {
            try {
                const statusEl = document.getElementById('github-status');
                if (statusEl) {
                    statusEl.textContent = gitHubSettings.token ? '✅ کنکٹڈ' : '❌ غیر کنکٹڈ';
                }
            } catch (error) {
                console.error('Error updating GitHub status:', error);
            }
        }

        function updateBackupStats() {
            try {
                const now = new Date();
                const backupTimeEl = document.getElementById('last-backup-time');
                if (backupTimeEl) {
                    backupTimeEl.textContent = now.toLocaleString('ur-PK');
                }
                
                const dataSize = new Blob([JSON.stringify(customers)]).size;
                const sizeEl = document.getElementById('backup-size');
                if (sizeEl) {
                    sizeEl.textContent = `${(dataSize / 1024).toFixed(2)} KB`;
                }
            } catch (error) {
                console.error('Error updating backup stats:', error);
            }
        }

        async function setupGitHubBackup() {
            try {
                const token = document.getElementById('github-token').value.trim();
                const repo = document.getElementById('github-repo').value.trim();
                
                if (!token || !repo) {
                    showAlert('براہ کرم GitHub ٹوکن اور ریپوزیٹری کا نام داخل کریں', 'error');
                    return;
                }
                
                updateBackupStatus('GitHub سیٹ اپ...', 'syncing');
                
                // Test GitHub connection
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    gitHubSettings.token = token;
                    gitHubSettings.repo = repo;
                    gitHubSettings.username = userData.login;
                    
                    saveToStorage();
                    showAlert('✅ GitHub کامیابی سے کنکٹ ہو گیا!');
                    updateBackupStatus('GitHub Ready', 'success');
                    updateGitHubStatus();
                } else {
                    throw new Error('Invalid GitHub token');
                }
            } catch (error) {
                console.error('GitHub setup error:', error);
                showAlert('GitHub کنکشن میں خرابی: ' + error.message, 'error');
                updateBackupStatus('GitHub خرابی', 'error');
            }
        }

        async function backupToGitHub() {
            try {
                if (!gitHubSettings.token) {
                    showAlert('پہلے GitHub سیٹ اپ کریں', 'error');
                    return;
                }
                
                updateBackupStatus('GitHub بیک اپ...', 'syncing');
                
                const data = {
                    customers: customers,
                    nextId: nextId,
                    backupDate: new Date().toISOString(),
                    version: '5.0'
                };
                
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const fileName = `backup_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                
                // Create or update file in GitHub repository
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.username}/${gitHubSettings.repo}/contents/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Milk Business Backup - ${new Date().toLocaleString('ur-PK')}`,
                        content: content
                    })
                });
                
                if (response.ok) {
                    showAlert('☁️ GitHub میں بیک اپ مکمل!');
                    updateBackupStatus('بیک اپ مکمل', 'success');
                    updateBackupStats();
                } else {
                    throw new Error('GitHub backup failed');
                }
            } catch (error) {
                console.error('GitHub backup error:', error);
                showAlert('GitHub بیک اپ میں خرابی: ' + error.message, 'error');
                updateBackupStatus('بیک اپ خرابی', 'error');
            }
        }

        async function restoreFromGitHub() {
            try {
                if (!gitHubSettings.token) {
                    showAlert('پہلے GitHub سیٹ اپ کریں', 'error');
                    return;
                }
                
                updateBackupStatus('GitHub سے بحالی...', 'syncing');
                
                // Get list of backup files
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.username}/${gitHubSettings.repo}/contents`, {
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`
                    }
                });
                
                if (response.ok) {
                    const files = await response.json();
                    const backupFiles = files.filter(file => file.name.startsWith('backup_') && file.name.endsWith('.json'));
                    
                    if (backupFiles.length === 0) {
                        showAlert('کوئی بیک اپ فائل نہیں ملی', 'error');
                        updateBackupStatus('کوئی بیک اپ نہیں', 'error');
                        return;
                    }
                    
                    // Get the latest backup file
                    const latestBackup = backupFiles.sort((a, b) => b.name.localeCompare(a.name))[0];
                    
                    // Download and restore
                    const fileResponse = await fetch(latestBackup.download_url);
                    const backupData = await fileResponse.json();
                    
                    if (confirm(`کیا آپ GitHub سے ڈیٹا restore کرنا چاہتے ہیں؟\nآخری بیک اپ: ${latestBackup.name}\nموجودہ ڈیٹا ڈیلیٹ ہو جائے گا۔`)) {
                        customers = backupData.customers || [];
                        nextId = backupData.nextId || 1;
                        
                        saveToStorage();
                        loadCustomers();
                        updateDashboard();
                        
                        showAlert('⬇️ GitHub سے ڈیٹا بحال ہو گیا!');
                        updateBackupStatus('بحالی مکمل', 'success');
                    }
                } else {
                    throw new Error('GitHub access failed');
                }
            } catch (error) {
                console.error('GitHub restore error:', error);
                showAlert('GitHub سے بحالی میں خرابی: ' + error.message, 'error');
                updateBackupStatus('بحالی خرابی', 'error');
            }
        }

        async function testGitHubConnection() {
            try {
                const token = document.getElementById('github-token').value.trim();
                
                if (!token) {
                    showAlert('پہلے GitHub ٹوکن داخل کریں', 'error');
                    return;
                }
                
                updateBackupStatus('کنکشن ٹیسٹ...', 'syncing');
                
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    showAlert(`✅ کنکشن کامیاب! صارف: ${userData.login}`);
                    updateBackupStatus('کنکشن OK', 'success');
                } else {
                    throw new Error('Invalid token');
                }
            } catch (error) {
                console.error('GitHub connection test failed:', error);
                showAlert('❌ کنکشن ناکام: ' + error.message, 'error');
                updateBackupStatus('کنکشن خرابی', 'error');
            }
        }

        function updateBackupStatus(message, type = 'info') {
            try {
                const statusEl = document.getElementById('backup-status');
                if (statusEl) {
                    statusEl.textContent = message;
                }
            } catch (error) {
                console.error('Error updating backup status:', error);
            }
        }

        function updateAutoBackupSettings() {
            try {
                const frequency = parseInt(document.getElementById('auto-backup-frequency').value);
                
                if (autoBackupInterval) {
                    clearInterval(autoBackupInterval);
                    autoBackupInterval = null;
                }
                
                if (frequency > 0 && gitHubSettings.token) {
                    autoBackupInterval = setInterval(() => {
                        backupToGitHub();
                    }, frequency * 60 * 1000);
                    
                    showAlert(`⚙️ خودکار بیک اپ ہر ${frequency} منٹ میں شروع`);
                } else {
                    showAlert('⚙️ خودکار بیک اپ بند');
                }
            } catch (error) {
                console.error('Error updating auto backup settings:', error);
                showAlert('خودکار بیک اپ سیٹنگ میں خرابی: ' + error.message, 'error');
            }
        }

        // Report Functions
        function generateMonthlyReport() {
            showAlert('📅 ماہانہ رپورٹ کی خصوصیت جلد ہی آئے گی!', 'info');
        }

        function generateCustomerReport() {
            showAlert('👥 گاہک وار رپورٹ کی خصوصیت جلد ہی آئے گی!', 'info');
        }

        function generatePaymentReport() {
            showAlert('💳 پیمنٹ رپورٹ کی خصوصیت جلد ہی آئے گی!', 'info');
        }

        // Utility Functions
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ur-PK');
            } catch (error) {
                return dateString;
            }
        }

        function showAlert(message, type = 'success') {
            try {
                const alert = document.createElement('div');
                alert.className = `alert ${type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : ''}`;
                alert.textContent = message;
                
                document.body.appendChild(alert);
                
                setTimeout(() => {
                    if (alert.classList) alert.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    if (alert.classList) alert.classList.remove('show');
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.parentNode.removeChild(alert);
                        }
                    }, 300);
                }, 3000);
            } catch (error) {
                console.error('Error showing alert:', error);
                // Fallback to console log
                console.log(`${type.toUpperCase()}: ${message}`);
            }
        }

        // Auto-save functionality
        setInterval(() => {
            try {
                if (customers.length > 0) {
                    saveToStorage();
                    console.log('💾 Auto-saved data');
                }
            } catch (error) {
                console.error('Auto-save failed:', error);
            }
        }, 30000); // 30 seconds

        // Auto-backup functionality (if GitHub is configured)
        setInterval(() => {
            try {
                if (gitHubSettings.token && customers.length > 0) {
                    const autoFreq = document.getElementById('auto-backup-frequency');
                    if (autoFreq && parseInt(autoFreq.value) > 0) {
                        console.log('🔄 Performing auto backup to GitHub...');
                        // Auto backup is handled by updateAutoBackupSettings
                    }
                }
            } catch (error) {
                console.error('Auto-backup check failed:', error);
            }
        }, 60000); // 1 minute

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            try {
                if (e.target && e.target.classList && e.target.classList.contains('modal')) {
                    closeModal();
                }
            } catch (error) {
                console.error('Error handling modal click:', error);
            }
        });

        // Handle beforeunload to save data
        window.addEventListener('beforeunload', function() {
            try {
                saveToStorage();
            } catch (error) {
                console.error('Error saving on beforeunload:', error);
            }
        });

        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            try {
                if (event.key === 'Escape') {
                    closeModal();
                } else if (event.ctrlKey && event.key === 's') {
                    event.preventDefault();
                    saveToStorage();
                    showAlert('💾 ڈیٹا محفوظ ہو گیا!');
                }
            } catch (error) {
                console.error('Error handling keyboard shortcut:', error);
            }
        });

    </script>
</body>
</html>
